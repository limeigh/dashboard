import{b as ze}from"./chart-0.0.0-dataease2.js";import{c as Y,b as w,h as Re}from"./index-0.0.0-dataease12.js";import{d as Ve}from"./dvMain-0.0.0-dataease.js";import{V as We}from"./ViewTrackBar-0.0.0-dataease.js";import{s as Ge}from"./pinia-0.0.0-dataease.js";import{p as ue,B as Je}from"./chart-0.0.0-dataease.js";import He from"./ChartError-0.0.0-dataease.js";import{r as me,e as Ze,f as Ue}from"./canvasStyle-0.0.0-dataease.js";import{u as $,i as Xe,k as Ye}from"./index-0.0.0-dataease.js";import{x as $e,P as Ke}from"./canvasUtils-0.0.0-dataease.js";import{f as Qe}from"./ConfigGlobal.vue_vue_type_script_setup_true_lang-0.0.0-dataease.js";import{$ as et}from"./@antv-0.0.0-dataease.js";import"./lodash-0.0.0-dataease.js";import"./eventemitter3-0.0.0-dataease.js";import{E as tt,h as it,N as at}from"./lodash-es-0.0.0-dataease.js";import{d as rt,t as ot,r as I,l as nt,x as lt,k as st,b as ct,e as pt,o as K,c as de,W as ut,u as mt,Z as dt,T as ft,n as vt}from"./@vue-0.0.0-dataease.js";import{_ as gt}from"./_plugin-vue_export-helper-0.0.0-dataease.js";import"./dataset-0.0.0-dataease.js";import"./js-base64-0.0.0-dataease.js";import"./jspdf-0.0.0-dataease.js";import"./@babel-0.0.0-dataease.js";import"./@amap-0.0.0-dataease.js";import"./fflate-0.0.0-dataease.js";import"./fast-png-0.0.0-dataease.js";import"./iobuffer-0.0.0-dataease.js";import"./pako-0.0.0-dataease.js";import"./@turf-0.0.0-dataease.js";import"./polygon-clipping-0.0.0-dataease.js";import"./splaytree-0.0.0-dataease.js";import"./robust-predicates-0.0.0-dataease.js";import"./mathjs-0.0.0-dataease.js";import"./decimal.js-0.0.0-dataease.js";import"./typed-function-0.0.0-dataease.js";import"./complex.js-0.0.0-dataease.js";import"./sysParameter-0.0.0-dataease.js";import"./TableTooltip-0.0.0-dataease.js";import"./element-plus-secondary-0.0.0-dataease.js";import"./@vueuse-0.0.0-dataease.js";import"./@element-plus-0.0.0-dataease.js";import"./dayjs-0.0.0-dataease.js";import"./@popperjs-0.0.0-dataease.js";import"./async-validator-0.0.0-dataease.js";import"./@ctrl-0.0.0-dataease.js";import"./normalize-wheel-es-0.0.0-dataease.js";import"./memoize-one-0.0.0-dataease.js";import"./vue-demi-0.0.0-dataease.js";import"./mitt-0.0.0-dataease.js";import"./web-storage-cache-0.0.0-dataease.js";import"./vue-types-0.0.0-dataease.js";import"./is-plain-object-0.0.0-dataease.js";import"./axios-0.0.0-dataease.js";import"./qs-0.0.0-dataease.js";import"./side-channel-0.0.0-dataease.js";import"./es-errors-0.0.0-dataease.js";import"./object-inspect-0.0.0-dataease.js";import"./crypto-js-0.0.0-dataease.js";import"./side-channel-list-0.0.0-dataease.js";import"./side-channel-map-0.0.0-dataease.js";import"./get-intrinsic-0.0.0-dataease.js";import"./es-object-atoms-0.0.0-dataease.js";import"./math-intrinsics-0.0.0-dataease.js";import"./gopd-0.0.0-dataease.js";import"./es-define-property-0.0.0-dataease.js";import"./has-symbols-0.0.0-dataease.js";import"./get-proto-0.0.0-dataease.js";import"./dunder-proto-0.0.0-dataease.js";import"./call-bind-apply-helpers-0.0.0-dataease.js";import"./function-bind-0.0.0-dataease.js";import"./hasown-0.0.0-dataease.js";import"./call-bound-0.0.0-dataease.js";import"./side-channel-weakmap-0.0.0-dataease.js";import"./vue-router_2-0.0.0-dataease.js";import"./vue-0.0.0-dataease.js";import"./vue-i18n-0.0.0-dataease.js";import"./@intlify-0.0.0-dataease.js";import"./echarts-0.0.0-dataease.js";import"./zrender-0.0.0-dataease.js";import"./tinymce-0.0.0-dataease.js";import"./@mapbox-0.0.0-dataease.js";import"./pbf-0.0.0-dataease.js";import"./ieee754-0.0.0-dataease.js";import"./supercluster-0.0.0-dataease.js";import"./gl-matrix-0.0.0-dataease.js";import"./tslib-0.0.0-dataease.js";import"./detect-browser-0.0.0-dataease.js";import"./size-sensor-0.0.0-dataease.js";import"./d3-regression-0.0.0-dataease.js";import"./d3-hierarchy-0.0.0-dataease.js";import"./fmin-0.0.0-dataease.js";import"./pdfast-0.0.0-dataease.js";import"./d3-ease-0.0.0-dataease.js";import"./d3-interpolate-0.0.0-dataease.js";import"./d3-color-0.0.0-dataease.js";import"./d3-timer-0.0.0-dataease.js";import"./fecha-0.0.0-dataease.js";import"./topojson-client-0.0.0-dataease.js";import"./viewport-mercator-project-0.0.0-dataease.js";import"./d3-scale-0.0.0-dataease.js";import"./d3-collection-0.0.0-dataease.js";import"./d3-format-0.0.0-dataease.js";import"./d3-time-format-0.0.0-dataease.js";import"./d3-time-0.0.0-dataease.js";import"./d3-array-0.0.0-dataease.js";import"./earcut-0.0.0-dataease.js";import"./regl-0.0.0-dataease.js";import"./mapbox-gl-0.0.0-dataease.js";import"./d3-dsv-0.0.0-dataease.js";import"./geojson-vt-0.0.0-dataease.js";import"./hammerjs-0.0.0-dataease.js";import"./element-resize-detector-0.0.0-dataease.js";import"./batch-processor-0.0.0-dataease.js";import"./d3-hexbin-0.0.0-dataease.js";import"./exceljs-0.0.0-dataease.js";import"./file-saver-0.0.0-dataease.js";import"./dataVisualization-0.0.0-dataease2.js";import"./util-0.0.0-dataease.js";import"./snowflake-id-0.0.0-dataease.js";import"./appearance-0.0.0-dataease.js";import"./font-0.0.0-dataease.js";import"./login-0.0.0-dataease.js";import"./less-0.0.0-dataease.js";import"./copy-anything-0.0.0-dataease.js";import"./is-what-0.0.0-dataease.js";import"./app-0.0.0-dataease.js";import"./translate-0.0.0-dataease.js";import"./eventBus-0.0.0-dataease.js";import"./dataVisualization-0.0.0-dataease.js";import"./snapshot-0.0.0-dataease.js";import"./ModelUtil-0.0.0-dataease.js";const yt={class:"canvas-area"},fe=.01,ht=rt({__name:"ChartComponentG2Plot",props:{element:{type:Object,default(){return{propValue:null}}},view:{type:Object,default(){return{propValue:null}}},showPosition:{type:String,required:!1,default:"canvas"},scale:{type:Number,required:!1,default:1},terminal:{type:String,default:"pc"},suffixId:{type:String,required:!1,default:"common"},fontFamily:{type:String,required:!1,default:"inherit"},active:{type:Boolean,required:!1,default:!0}},emits:["onPointClick","onChartClick","onDrillFilters","onJumpClick","resetLoading"],setup(Q,{expose:ve,emit:ge}){const{t:ye}=Qe(),B=Ve(),{nowPanelTrackInfo:N,nowPanelJumpInfo:C,mobileInPc:ee,embeddedCallBack:he,inMobile:te}=Ge(B),{emitter:O}=$(),T=Q,L=ge,ke=["bidirectional-bar"],Se=["bar-range"],Ae=["circle-packing"],Pe=["bar-stack","bar-group-stack","percentage-bar-stack","bar-stack-horizontal","percentage-bar-stack-horizontal"],be=["bar-group"],{view:p,showPosition:ie,scale:ae,terminal:re,suffixId:Te}=ot(T),z=I(!1),oe=I(""),D=I(!1),ne=!$e()&&Xe(),c=nt({trackBarStyle:{position:"absolute",left:"50px",top:"50px"},trackBarStyleMobile:{position:"absolute",left:"50px",top:"50px"},linkageActiveParam:null,pointParam:null,data:{fields:[]}});let A=lt({fields:[]});const x="container-"+ie.value+"-"+p.value.id+"-"+Te.value,le=I(null),xe=()=>{D.value=!1;try{i==null||i.setState("active",()=>!0,!1),i==null||i.setState("inactive",()=>!0,!1),i==null||i.setState("selected",()=>!0,!1)}catch{console.warn("clearLinkage error")}},_e=()=>{var a;D.value=!1,((a=i==null?void 0:i.chart)==null?void 0:a.getController("slider"))||i==null||i.render()},Le=()=>{D.value&&_e(),vt(()=>{se()})},se=()=>{D.value=!0,i==null||i.setState("active",()=>!0,!1),i==null||i.setState("inactive",()=>!0,!1),i==null||i.setState("selected",()=>!0,!1),i==null||i.setState("active",e=>Array.isArray(e)?!1:R(e)),i==null||i.setState("inactive",e=>Array.isArray(e)?!1:!R(e)),i==null||i.setState("selected",e=>Array.isArray(e)?!1:R(e))},R=e=>{var h,k,v,y,g,b;const a=Array.from(new Set((p.value.type.includes("chart-mix")?at((k=(h=A.value)==null?void 0:h.left)==null?void 0:k.fields,(y=(v=A.value)==null?void 0:v.right)==null?void 0:y.fields):(g=A.value)==null?void 0:g.fields).map(u=>u==null?void 0:u.id).filter(u=>Object.keys(N.value).some(d=>d.startsWith(p.value.id)&&d.split("#")[1]===u)))),[r,t,o]=["xAxis","xAxisExt","extStack"].map(u=>p.value[u].find(d=>a.includes(d.id))),{group:n,name:l,category:m}=c.linkageActiveParam;if(ke.includes(p.value.type))return l===e.field;if(Se.includes(p.value.type))return m===e.category;if(Ae.includes(p.value.type))return(b=e.path)!=null&&b.startsWith(l)||l===ye("commons.all")?!0:l===e.name;if(be.includes(p.value.type)){const u=l===e.name||l==="NO_DATA"&&!e.name,d=m===e.category;return r&&t?u&&d:r&&!t?u:!r&&t?d:!1}else if(Pe.includes(p.value.type)){const u=n===e.group||n==="NO_DATA"&&!e.group,d=l===e.name||l==="NO_DATA"&&!e.name,E=m===e.category;return r&&t&&o?d&&u&&E:r&&!t&&!o?d:!r&&t&&!o?u:!r&&!t&&o?E:r&&t&&!o?d&&u:r&&!t&&o?d&&E:!r&&t&&o?u&&E:!1}else return(l===e.name||l==="NO_DATA"&&!e.name)&&m===e.category},Ee=async(e,a)=>{if(e.tableId||e.dataFrom==="template"){z.value=!1;const r=JSON.parse(JSON.stringify(e));ze(r).then(async t=>{var o,n,l,m,h,k,v,y;if(t.code&&t.code!==0)z.value=!0,oe.value=t.msg,a==null||a();else{if(A.value=t==null?void 0:t.data,L("onDrillFilters",t==null?void 0:t.drillFilters),!((o=t==null?void 0:t.drillFilters)!=null&&o.length))P.value="",G=null;else{const g=(m=(n=e.chartExtRequest)==null?void 0:n.drill)==null?void 0:m[((l=t==null?void 0:t.drillFilters)==null?void 0:l.length)-1].extra;P.value=(g==null?void 0:g.adcode)+"",G=g==null?void 0:g.scope;const b=(h=ue(e.customAttr))==null?void 0:h.map;if(b){let u=b.id;_.value=u.slice(0,3)}(k=P.value)!=null&&k.startsWith(_.value)||(_.value==="cus"?P.value="156"+P.value:P.value=_.value+P.value)}B.setViewDataDetails(e.id,t),!t.drill&&!((y=(v=t.chartExtRequest)==null?void 0:v.linkageFilters)!=null&&y.length)&&(B.setViewOriginData(e.id,A.value),O.emit("chart-data-change")),await j(t,a)}}).catch(()=>{a==null||a()})}else["bubble-map","map","flow-map","heat-map"].includes(e.type)&&await j(e,a),a==null||a()};let s;const j=async(e,a)=>{if(!e)return;s=e;const r=Ye({...tt(e,it(Je)),data:A.value,...T.fontFamily&&T.fontFamily!=="inherit"?{fontFamily:T.fontFamily}:{}}),t=Y.getChartView(e.render,e.type);switch(me(Ze,r.customAttr,ae.value,re.value),me(Ue,r.customStyle,ae.value,re.value),t.library){case w.L7_PLOT:await Ie(r,t,a);break;case w.L7:await Be(r,t,a);break;case w.G2_PLOT:await we(r,t),a==null||a();break}};let i=null,V;const we=async(e,a)=>{V&&clearTimeout(V),V=setTimeout(async()=>{try{Re([1],x),i==null||i.destroy(),i=await a.drawChart({chartObj:i,container:x,chart:e,scale:1,action:Z,quadrantDefaultBaseline:Fe}),i==null||i.render(),D.value&&se()}catch(r){console.error("renderG2Plot error",r)}},300)},P=I(""),_=I(""),W=I(null);let G,J;const Ie=async(e,a,r)=>{let o=ue(e.customAttr).map.id;_.value=o.slice(0,3),P.value&&(_.value==="000"&&P.value.startsWith("000")?(_.value=P.value.slice(3),o=_.value):o=P.value),J&&clearTimeout(J),J=setTimeout(async()=>{i==null||i.destroy(),W.value&&(W.value.textContent=""),i=await a.drawChart({chartObj:i,container:x,chart:e,areaId:o,action:Z,scope:G}),r==null||r(),L("resetLoading")},500)};let H;const Be=async(e,a,r)=>{H&&clearTimeout(H),H=setTimeout(async()=>{i=await a.drawChart({chartObj:i,container:x,chart:e,action:Z}),i==null||i.render(),r==null||r(),L("resetLoading")},500)},Oe=()=>{he.value==="yes"&&U("pointClick")},De=e=>{e.from==="map"&&O.emit("map-default-range",e),e.from==="word-cloud"&&O.emit("word-cloud-default-data-range",e),(e.from==="gauge"||e.from==="liquid")&&O.emit("gauge-liquid-y-value",e)},Z=e=>{var a,r,t,o;if(e.from){De(e);return}if(!(p.value.type==="map"&&!((r=(a=e==null?void 0:e.data)==null?void 0:a.data)!=null&&r.quotaList&&((o=(t=e==null?void 0:e.data)==null?void 0:t.data)==null?void 0:o.quotaList.length)>0)))if(c.pointParam=e.data,Oe(),c.linkageActiveParam={category:c.pointParam.data.category?c.pointParam.data.category:"NO_DATA",name:c.pointParam.data.name?c.pointParam.data.name:"NO_DATA",group:c.pointParam.data.group?c.pointParam.data.group:"NO_DATA"},F.value.length<2)U(F.value[0]);else{const n={left:e.x-50,top:e.y+10};Ke(T.element,n,T.scale,F.value.length);const l=n.left;let m=50;c.trackBarStyle.left=n.left+"px",s.type==="symbolic-map"?(m=e.y+10,c.trackBarStyle.top=e.y+10+"px"):(m=n.top,c.trackBarStyle.top=n.top+"px"),ne?(c.trackBarStyle.left=l+40+"px",c.trackBarStyle.top=m+70+"px"):(c.trackBarStyle.left=l+"px",c.trackBarStyle.top=m+"px"),le.value.trackButtonClick(p.value.id)}},U=e=>{var h,k,v,y,g,b,u,d,E;const a=c.pointParam;if(!((h=a==null?void 0:a.data)!=null&&h.dimensionList))return;let r;if(a.data.dimensionList.length>1){if(p.value.type==="bar-group-stack"){const S=a.data.dimensionList.length;a.data.dimensionList[S-1].id===a.data.dimensionList[S-2].id&&a.data.dimensionList.pop(),a.data.dimensionList.forEach(f=>{f.value===a.data.category&&(r=f.id)})}r||(r=a.data.dimensionList[0].id)}r||(r=a.data.name);let t=c.pointParam.data.name;if(c.pointParam.data.dimensionList.length>1){const S=[];if(s.drill){const f=s.drillFields[s.drillFilters.length];S.push(f.id)}s.type.includes("chart-mix")?((y=(v=(k=A.value)==null?void 0:k.left)==null?void 0:v.fields)==null||y.forEach(f=>{S.includes(f.id)||S.push(f.id)}),(u=(b=(g=A.value)==null?void 0:g.right)==null?void 0:b.fields)==null||u.forEach(f=>{S.includes(f.id)||S.push(f.id)})):(E=(d=A.value)==null?void 0:d.fields)==null||E.forEach(f=>{S.includes(f.id)||S.push(f.id)});for(let f=0;f<S.length;f++){const pe=S[f],Ce=p.value.id+"#"+pe;if(C.value[Ce]){t=pe;break}}}let o=c.pointParam.data.quotaList;["bar-range","bullet-graph"].includes(s.type)?o=c.pointParam.data.dimensionList:o[0].value=c.pointParam.data.value;const n={option:"linkage",name:r,viewId:p.value.id,dimensionList:c.pointParam.data.dimensionList,quotaList:o},l={option:"jump",name:t,viewId:p.value.id,dimensionList:c.pointParam.data.dimensionList,quotaList:o},m={option:"pointClick",name:r,viewId:p.value.id,dimensionList:c.pointParam.data.dimensionList,quotaList:o};switch(e){case"pointClick":L("onPointClick",m);break;case"linkageAndDrill":B.addViewTrackFilter(n),L("onChartClick",a);break;case"drill":L("onChartClick",a);break;case"linkage":Le(),B.addViewTrackFilter(n);break;case"jump":if(ee.value&&!te.value)return;L("onJumpClick",l);break}},F=st(()=>{var a,r,t,o,n,l;let e=[];if(!["multiplexing","viewDialog"].includes(ie.value)){let m=s!=null&&s.drill&&((a=s==null?void 0:s.drillFilters)!=null&&a.length)?s.drillFilters.map(v=>v.fieldId):[],h=0,k=0;(r=s==null?void 0:s.type)!=null&&r.includes("chart-mix")?Array.of("left","right").forEach(v=>{var y,g,b;(b=(g=(y=A.value)==null?void 0:y[v])==null?void 0:g.fields)==null||b.filter(u=>!m.includes(u.id)).forEach(u=>{const d=p.value.id+"#"+u.id;N.value[d]&&h++,C.value[d]&&k++})}):(o=(t=A.value)==null?void 0:t.fields)==null||o.filter(v=>!m.includes(v.id)).forEach(v=>{const y=p.value.id+"#"+v.id;N.value[y]&&h++,C.value[y]&&k++}),k&&((n=p.value)!=null&&n.jumpActive)&&(!ee.value||te.value)&&e.push("jump"),h&&((l=p.value)!=null&&l.linkageActive)&&e.push("linkage"),p.value.drillFields.length&&e.push("drill"),e.length===3&&T.element.actionSelection.linkageActive==="auto"?e=["jump","linkageAndDrill"]:e.length===2&&T.element.actionSelection.linkageActive==="auto"&&!e.includes("jump")&&(e=["linkageAndDrill"])}return e}),Fe=e=>{O.emit("quadrant-default-baseline",e)},X=(e,a)=>{const r=document.getElementById(x),t=r.querySelectorAll(".l7-scene");if(t!=null&&t.length&&t.forEach(n=>{n.style.display="none"}),a){const n=r.querySelectorAll(".amap-maps");n==null||n.forEach(l=>{l.style.display="none"})}const o=document.createElement("img");o.style.width="100%",o.style.height="100%",o.style.position="absolute",o.style.objectFit="cover",o.style["z-index"]="2",o.classList.add("prepare-picture-img"),o.src=e,r==null||r.appendChild(o)},Me=e=>{if(e!==(s==null?void 0:s.id))return;const a=Y.getChartView(s.render,s.type);if(a.library===w.L7_PLOT)i.getScene().exportMap("png").then(r=>X(r,!1));else if(a.library===w.L7){const r=i.getScene(),t=new et({onExport:o=>{X(o,!0)}});r.addControl(t),t.hide(),t.getImage().then(o=>{X(o,!0)})}},qe=e=>{if(e!==(s==null?void 0:s.id))return;const a=Y.getChartView(s.render,s.type);if(a.library===w.L7_PLOT||a.library===w.L7){const r=document.getElementById(x),t=r.querySelectorAll(".l7-scene");t!=null&&t.length&&t.forEach(l=>{l.style.display="block"});const o=r.querySelectorAll(".prepare-picture-img");o==null||o.forEach(l=>{l.remove()});const n=r.querySelectorAll(".amap-maps");n==null||n.forEach(l=>{l.style.display="block"})}};ve({calcData:Ee,renderChart:j,trackMenu:F,clearLinkage:xe});let M,q;const ce=["map","bubble-map","flow-map","heat-map"];ct(()=>{const e=document.getElementById(x),{offsetWidth:a,offsetHeight:r}=e,t=[a,r];q=new ResizeObserver(([o]=[])=>{if(!ce.includes(p.value.type))return;const[n]=o.borderBoxSize||[],l=(n.inlineSize-t[0])/t[0],m=(n.blockSize-t[1])/t[1];Math.abs(l)<fe&&Math.abs(m)<fe||(i&&t[1]>1&&j(s),t[0]=n.inlineSize,t[1]=n.blockSize)}),q.observe(e),M=new IntersectionObserver(([o])=>{ce.includes(p.value.type)||o.intersectionRatio<=0&&(i==null||i.emit("tooltip:hidden"))}),M.observe(e),$({name:"l7-prepare-picture",callback:Me}),$({name:"l7-unprepare-picture",callback:qe})});const je=["map","bubble-map","flow-map","heat-map","symbolic-map"],Ne=e=>{je.includes(p.value.type)&&(T.active||e.stopPropagation())};return pt(()=>{try{i==null||i.destroy(),q==null||q.disconnect(),M==null||M.disconnect()}catch(e){console.warn(e)}}),(e,a)=>(K(),de("div",yt,[ut(We,{ref_key:"viewTrack",ref:le,"track-menu":F.value,"font-family":Q.fontFamily,"is-data-v-mobile":mt(ne),class:"track-bar",style:dt(c.trackBarStyle),onTrackClick:U},null,8,["track-menu","font-family","is-data-v-mobile","style"]),z.value?(K(),ft(He,{key:1,"err-msg":oe.value},null,8,["err-msg"])):(K(),de("div",{key:0,onWheelCapture:Ne,ref_key:"chartContainer",ref:W,class:"canvas-content",id:x},null,544))]))}});const za=gt(ht,[["__scopeId","data-v-5bf4c3dd"]]);export{za as default};
