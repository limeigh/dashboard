import{b as ze}from"./chart-0.0.0-dataease2.js";import{c as Y,b as w,h as Re}from"./index-0.0.0-dataease21.js";import{d as Ve}from"./dvMain-0.0.0-dataease.js";import{V as Ge}from"./ViewTrackBar-0.0.0-dataease.js";import{d as We,af as Je,t as He,r as I,X as Xe,s as Qe,y as Ue,o as Ye,a as Ze,f as Z,O as de,j as Ke,u as $e,T as et,g as tt,n as it}from"./vue-0.0.0-dataease.js";import{p as fe,B as at}from"./chart-0.0.0-dataease.js";import nt from"./ChartError-0.0.0-dataease.js";import{r as pe,e as ot,f as rt}from"./canvasStyle-0.0.0-dataease.js";import{i as lt,N as st,o as ct}from"./ConfigGlobal.vue_vue_type_script_setup_true_lang-0.0.0-dataease.js";import{x as ut,P as dt}from"./canvasUtils-0.0.0-dataease.js";import{a as K}from"./index-0.0.0-dataease.js";import{ab as ft}from"./antv-0.0.0-dataease.js";import{D as pt,e as mt,Q as vt}from"./lodash-0.0.0-dataease.js";import{_ as gt}from"./_plugin-vue_export-helper-0.0.0-dataease.js";import"./dataset-0.0.0-dataease.js";import"./library-0.0.0-dataease.js";import"./index-0.0.0-dataease22.js";import"./pureFunctionsAny.generated-0.0.0-dataease.js";import"./extends-0.0.0-dataease.js";import"./decimal-0.0.0-dataease.js";import"./tslib.es6-0.0.0-dataease.js";import"./sysParameter-0.0.0-dataease.js";import"./TableTooltip-0.0.0-dataease.js";import"./el-col-0.0.0-dataease.js";import"./constants-0.0.0-dataease.js";import"./el-row-0.0.0-dataease.js";import"./axios-0.0.0-dataease.js";import"./echarts-0.0.0-dataease.js";import"./tinymce-0.0.0-dataease.js";import"./_commonjs-dynamic-modules-0.0.0-dataease.js";import"./dataVisualization-0.0.0-dataease2.js";import"./util-0.0.0-dataease.js";import"./appearance-0.0.0-dataease.js";import"./font-0.0.0-dataease.js";import"./el-dropdown-menu-0.0.0-dataease.js";import"./index-0.0.0-dataease4.js";import"./index-0.0.0-dataease3.js";import"./dropdown-0.0.0-dataease.js";import"./refs-0.0.0-dataease.js";import"./el-popper-0.0.0-dataease.js";import"./el-dropdown-item-0.0.0-dataease.js";import"./app-0.0.0-dataease.js";import"./el-dialog-0.0.0-dataease.js";import"./use-dialog-0.0.0-dataease.js";import"./el-main-0.0.0-dataease.js";import"./index-0.0.0-dataease16.js";import"./translate-0.0.0-dataease.js";import"./eventBus-0.0.0-dataease.js";import"./dataVisualization-0.0.0-dataease.js";import"./snapshot-0.0.0-dataease.js";import"./ModelUtil-0.0.0-dataease.js";const yt={class:"canvas-area"},me=.01,ht=We({__name:"ChartComponentG2Plot",props:{element:{type:Object,default(){return{propValue:null}}},view:{type:Object,default(){return{propValue:null}}},showPosition:{type:String,required:!1,default:"canvas"},scale:{type:Number,required:!1,default:1},terminal:{type:String,default:"pc"},suffixId:{type:String,required:!1,default:"common"},fontFamily:{type:String,required:!1,default:"inherit"},active:{type:Boolean,required:!1,default:!0}},emits:["onPointClick","onChartClick","onDrillFilters","onJumpClick","resetLoading"],setup($,{expose:ve,emit:ge}){const{t:ye}=ct(),O=Ve(),{nowPanelTrackInfo:N,nowPanelJumpInfo:C,mobileInPc:ee,embeddedCallBack:he,inMobile:te}=Je(O),{emitter:B}=K(),T=$,L=ge,ke=["bidirectional-bar"],Se=["bar-range"],Ae=["circle-packing"],Pe=["bar-stack","bar-group-stack","percentage-bar-stack","bar-stack-horizontal","percentage-bar-stack-horizontal"],be=["bar-group"],{view:u,showPosition:ie,scale:ae,terminal:ne,suffixId:Te}=He(T),z=I(!1),oe=I(""),D=I(!1),re=!ut()&&lt(),c=Xe({trackBarStyle:{position:"absolute",left:"50px",top:"50px"},trackBarStyleMobile:{position:"absolute",left:"50px",top:"50px"},linkageActiveParam:null,pointParam:null,data:{fields:[]}});let A=Qe({fields:[]});const x="container-"+ie.value+"-"+u.value.id+"-"+Te.value,le=I(null),xe=()=>{D.value=!1;try{i==null||i.setState("active",()=>!0,!1),i==null||i.setState("inactive",()=>!0,!1),i==null||i.setState("selected",()=>!0,!1)}catch{console.warn("clearLinkage error")}},_e=()=>{var a;D.value=!1,((a=i==null?void 0:i.chart)==null?void 0:a.getController("slider"))||i==null||i.render()},Le=()=>{D.value&&_e(),it(()=>{se()})},se=()=>{D.value=!0,i==null||i.setState("active",()=>!0,!1),i==null||i.setState("inactive",()=>!0,!1),i==null||i.setState("selected",()=>!0,!1),i==null||i.setState("active",e=>Array.isArray(e)?!1:R(e)),i==null||i.setState("inactive",e=>Array.isArray(e)?!1:!R(e)),i==null||i.setState("selected",e=>Array.isArray(e)?!1:R(e))},R=e=>{var h,k,v,y,g,b;const a=Array.from(new Set((u.value.type.includes("chart-mix")?vt((k=(h=A.value)==null?void 0:h.left)==null?void 0:k.fields,(y=(v=A.value)==null?void 0:v.right)==null?void 0:y.fields):(g=A.value)==null?void 0:g.fields).map(d=>d==null?void 0:d.id).filter(d=>Object.keys(N.value).some(p=>p.startsWith(u.value.id)&&p.split("#")[1]===d)))),[n,t,o]=["xAxis","xAxisExt","extStack"].map(d=>u.value[d].find(p=>a.includes(p.id))),{group:r,name:l,category:f}=c.linkageActiveParam;if(ke.includes(u.value.type))return l===e.field;if(Se.includes(u.value.type))return f===e.category;if(Ae.includes(u.value.type))return(b=e.path)!=null&&b.startsWith(l)||l===ye("commons.all")?!0:l===e.name;if(be.includes(u.value.type)){const d=l===e.name||l==="NO_DATA"&&!e.name,p=f===e.category;return n&&t?d&&p:n&&!t?d:!n&&t?p:!1}else if(Pe.includes(u.value.type)){const d=r===e.group||r==="NO_DATA"&&!e.group,p=l===e.name||l==="NO_DATA"&&!e.name,E=f===e.category;return n&&t&&o?p&&d&&E:n&&!t&&!o?p:!n&&t&&!o?d:!n&&!t&&o?E:n&&t&&!o?p&&d:n&&!t&&o?p&&E:!n&&t&&o?d&&E:!1}else return(l===e.name||l==="NO_DATA"&&!e.name)&&f===e.category},Ee=async(e,a)=>{if(e.tableId||e.dataFrom==="template"){z.value=!1;const n=JSON.parse(JSON.stringify(e));ze(n).then(async t=>{var o,r,l,f,h,k,v,y;if(t.code&&t.code!==0)z.value=!0,oe.value=t.msg,a==null||a();else{if(A.value=t==null?void 0:t.data,L("onDrillFilters",t==null?void 0:t.drillFilters),!((o=t==null?void 0:t.drillFilters)!=null&&o.length))P.value="",W=null;else{const g=(f=(r=e.chartExtRequest)==null?void 0:r.drill)==null?void 0:f[((l=t==null?void 0:t.drillFilters)==null?void 0:l.length)-1].extra;P.value=(g==null?void 0:g.adcode)+"",W=g==null?void 0:g.scope;const b=(h=fe(e.customAttr))==null?void 0:h.map;if(b){let d=b.id;_.value=d.slice(0,3)}(k=P.value)!=null&&k.startsWith(_.value)||(_.value==="cus"?P.value="156"+P.value:P.value=_.value+P.value)}O.setViewDataDetails(e.id,t),!t.drill&&!((y=(v=t.chartExtRequest)==null?void 0:v.linkageFilters)!=null&&y.length)&&(O.setViewOriginData(e.id,A.value),B.emit("chart-data-change")),await j(t,a)}}).catch(()=>{a==null||a()})}else["bubble-map","map","flow-map","heat-map"].includes(e.type)&&await j(e,a),a==null||a()};let s;const j=async(e,a)=>{if(!e)return;s=e;const n=st({...pt(e,mt(at)),data:A.value,...T.fontFamily&&T.fontFamily!=="inherit"?{fontFamily:T.fontFamily}:{}}),t=Y.getChartView(e.render,e.type);switch(pe(ot,n.customAttr,ae.value,ne.value),pe(rt,n.customStyle,ae.value,ne.value),t.library){case w.L7_PLOT:await Ie(n,t,a);break;case w.L7:await Oe(n,t,a);break;case w.G2_PLOT:await we(n,t),a==null||a();break}};let i=null,V;const we=async(e,a)=>{V&&clearTimeout(V),V=setTimeout(async()=>{try{Re([1],x),i==null||i.destroy(),i=await a.drawChart({chartObj:i,container:x,chart:e,scale:1,action:X,quadrantDefaultBaseline:Fe}),i==null||i.render(),D.value&&se()}catch(n){console.error("renderG2Plot error",n)}},300)},P=I(""),_=I(""),G=I(null);let W,J;const Ie=async(e,a,n)=>{let o=fe(e.customAttr).map.id;_.value=o.slice(0,3),P.value&&(_.value==="000"&&P.value.startsWith("000")?(_.value=P.value.slice(3),o=_.value):o=P.value),J&&clearTimeout(J),J=setTimeout(async()=>{i==null||i.destroy(),G.value&&(G.value.textContent=""),i=await a.drawChart({chartObj:i,container:x,chart:e,areaId:o,action:X,scope:W}),n==null||n(),L("resetLoading")},500)};let H;const Oe=async(e,a,n)=>{H&&clearTimeout(H),H=setTimeout(async()=>{i=await a.drawChart({chartObj:i,container:x,chart:e,action:X}),i==null||i.render(),n==null||n(),L("resetLoading")},500)},Be=()=>{he.value==="yes"&&Q("pointClick")},De=e=>{e.from==="map"&&B.emit("map-default-range",e),e.from==="word-cloud"&&B.emit("word-cloud-default-data-range",e),(e.from==="gauge"||e.from==="liquid")&&B.emit("gauge-liquid-y-value",e)},X=e=>{var a,n,t,o;if(e.from){De(e);return}if(!(u.value.type==="map"&&!((n=(a=e==null?void 0:e.data)==null?void 0:a.data)!=null&&n.quotaList&&((o=(t=e==null?void 0:e.data)==null?void 0:t.data)==null?void 0:o.quotaList.length)>0)))if(c.pointParam=e.data,Be(),c.linkageActiveParam={category:c.pointParam.data.category?c.pointParam.data.category:"NO_DATA",name:c.pointParam.data.name?c.pointParam.data.name:"NO_DATA",group:c.pointParam.data.group?c.pointParam.data.group:"NO_DATA"},F.value.length<2)Q(F.value[0]);else{const r={left:e.x-50,top:e.y+10};dt(T.element,r,T.scale,F.value.length);const l=r.left;let f=50;c.trackBarStyle.left=r.left+"px",s.type==="symbolic-map"?(f=e.y+10,c.trackBarStyle.top=e.y+10+"px"):(f=r.top,c.trackBarStyle.top=r.top+"px"),re?(c.trackBarStyle.left=l+40+"px",c.trackBarStyle.top=f+70+"px"):(c.trackBarStyle.left=l+"px",c.trackBarStyle.top=f+"px"),le.value.trackButtonClick(u.value.id)}},Q=e=>{var h,k,v,y,g,b,d,p,E;const a=c.pointParam;if(!((h=a==null?void 0:a.data)!=null&&h.dimensionList))return;let n;if(a.data.dimensionList.length>1){if(u.value.type==="bar-group-stack"){const S=a.data.dimensionList.length;a.data.dimensionList[S-1].id===a.data.dimensionList[S-2].id&&a.data.dimensionList.pop(),a.data.dimensionList.forEach(m=>{m.value===a.data.category&&(n=m.id)})}n||(n=a.data.dimensionList[0].id)}n||(n=a.data.name);let t=c.pointParam.data.name;if(c.pointParam.data.dimensionList.length>1){const S=[];if(s.drill){const m=s.drillFields[s.drillFilters.length];S.push(m.id)}s.type.includes("chart-mix")?((y=(v=(k=A.value)==null?void 0:k.left)==null?void 0:v.fields)==null||y.forEach(m=>{S.includes(m.id)||S.push(m.id)}),(d=(b=(g=A.value)==null?void 0:g.right)==null?void 0:b.fields)==null||d.forEach(m=>{S.includes(m.id)||S.push(m.id)})):(E=(p=A.value)==null?void 0:p.fields)==null||E.forEach(m=>{S.includes(m.id)||S.push(m.id)});for(let m=0;m<S.length;m++){const ue=S[m],Ce=u.value.id+"#"+ue;if(C.value[Ce]){t=ue;break}}}let o=c.pointParam.data.quotaList;["bar-range","bullet-graph"].includes(s.type)?o=c.pointParam.data.dimensionList:o[0].value=c.pointParam.data.value;const r={option:"linkage",name:n,viewId:u.value.id,dimensionList:c.pointParam.data.dimensionList,quotaList:o},l={option:"jump",name:t,viewId:u.value.id,dimensionList:c.pointParam.data.dimensionList,quotaList:o},f={option:"pointClick",name:n,viewId:u.value.id,dimensionList:c.pointParam.data.dimensionList,quotaList:o};switch(e){case"pointClick":L("onPointClick",f);break;case"linkageAndDrill":O.addViewTrackFilter(r),L("onChartClick",a);break;case"drill":L("onChartClick",a);break;case"linkage":Le(),O.addViewTrackFilter(r);break;case"jump":if(ee.value&&!te.value)return;L("onJumpClick",l);break}},F=Ue(()=>{var a,n,t,o,r,l;let e=[];if(!["multiplexing","viewDialog"].includes(ie.value)){let f=s!=null&&s.drill&&((a=s==null?void 0:s.drillFilters)!=null&&a.length)?s.drillFilters.map(v=>v.fieldId):[],h=0,k=0;(n=s==null?void 0:s.type)!=null&&n.includes("chart-mix")?Array.of("left","right").forEach(v=>{var y,g,b;(b=(g=(y=A.value)==null?void 0:y[v])==null?void 0:g.fields)==null||b.filter(d=>!f.includes(d.id)).forEach(d=>{const p=u.value.id+"#"+d.id;N.value[p]&&h++,C.value[p]&&k++})}):(o=(t=A.value)==null?void 0:t.fields)==null||o.filter(v=>!f.includes(v.id)).forEach(v=>{const y=u.value.id+"#"+v.id;N.value[y]&&h++,C.value[y]&&k++}),k&&((r=u.value)!=null&&r.jumpActive)&&(!ee.value||te.value)&&e.push("jump"),h&&((l=u.value)!=null&&l.linkageActive)&&e.push("linkage"),u.value.drillFields.length&&e.push("drill"),e.length===3&&T.element.actionSelection.linkageActive==="auto"?e=["jump","linkageAndDrill"]:e.length===2&&T.element.actionSelection.linkageActive==="auto"&&!e.includes("jump")&&(e=["linkageAndDrill"])}return e}),Fe=e=>{B.emit("quadrant-default-baseline",e)},U=(e,a)=>{const n=document.getElementById(x),t=n.querySelectorAll(".l7-scene");if(t!=null&&t.length&&t.forEach(r=>{r.style.display="none"}),a){const r=n.querySelectorAll(".amap-maps");r==null||r.forEach(l=>{l.style.display="none"})}const o=document.createElement("img");o.style.width="100%",o.style.height="100%",o.style.position="absolute",o.style.objectFit="cover",o.style["z-index"]="2",o.classList.add("prepare-picture-img"),o.src=e,n==null||n.appendChild(o)},Me=e=>{if(e!==(s==null?void 0:s.id))return;const a=Y.getChartView(s.render,s.type);if(a.library===w.L7_PLOT)i.getScene().exportMap("png").then(n=>U(n,!1));else if(a.library===w.L7){const n=i.getScene(),t=new ft({onExport:o=>{U(o,!0)}});n.addControl(t),t.hide(),t.getImage().then(o=>{U(o,!0)})}},qe=e=>{if(e!==(s==null?void 0:s.id))return;const a=Y.getChartView(s.render,s.type);if(a.library===w.L7_PLOT||a.library===w.L7){const n=document.getElementById(x),t=n.querySelectorAll(".l7-scene");t!=null&&t.length&&t.forEach(l=>{l.style.display="block"});const o=n.querySelectorAll(".prepare-picture-img");o==null||o.forEach(l=>{l.remove()});const r=n.querySelectorAll(".amap-maps");r==null||r.forEach(l=>{l.style.display="block"})}};ve({calcData:Ee,renderChart:j,trackMenu:F,clearLinkage:xe});let M,q;const ce=["map","bubble-map","flow-map","heat-map"];Ye(()=>{const e=document.getElementById(x),{offsetWidth:a,offsetHeight:n}=e,t=[a,n];q=new ResizeObserver(([o]=[])=>{if(!ce.includes(u.value.type))return;const[r]=o.borderBoxSize||[],l=(r.inlineSize-t[0])/t[0],f=(r.blockSize-t[1])/t[1];Math.abs(l)<me&&Math.abs(f)<me||(i&&t[1]>1&&j(s),t[0]=r.inlineSize,t[1]=r.blockSize)}),q.observe(e),M=new IntersectionObserver(([o])=>{ce.includes(u.value.type)||o.intersectionRatio<=0&&(i==null||i.emit("tooltip:hidden"))}),M.observe(e),K({name:"l7-prepare-picture",callback:Me}),K({name:"l7-unprepare-picture",callback:qe})});const je=["map","bubble-map","flow-map","heat-map","symbolic-map"],Ne=e=>{je.includes(u.value.type)&&(T.active||e.stopPropagation())};return Ze(()=>{try{i==null||i.destroy(),q==null||q.disconnect(),M==null||M.disconnect()}catch(e){console.warn(e)}}),(e,a)=>(Z(),de("div",yt,[Ke(Ge,{ref_key:"viewTrack",ref:le,"track-menu":F.value,"font-family":$.fontFamily,"is-data-v-mobile":$e(re),class:"track-bar",style:et(c.trackBarStyle),onTrackClick:Q},null,8,["track-menu","font-family","is-data-v-mobile","style"]),z.value?(Z(),tt(nt,{key:1,"err-msg":oe.value},null,8,["err-msg"])):(Z(),de("div",{key:0,onWheelCapture:Ne,ref_key:"chartContainer",ref:G,class:"canvas-content",id:x},null,544))]))}});const gi=gt(ht,[["__scopeId","data-v-5bf4c3dd"]]);export{gi as default};
