import{e as I}from"./eventBus-0.0.0-dataease.js";import{d as K}from"./dvMain-0.0.0-dataease.js";import{s as ae}from"./snapshot-0.0.0-dataease.js";import{d as T,s as g}from"./pinia-0.0.0-dataease.js";import{o as $,$ as he,l as D}from"./index-0.0.0-dataease.js";import{g as ye}from"./util-0.0.0-dataease.js";import{b as me}from"./canvasStyle-0.0.0-dataease.js";import{e as ve,g as ge,h as Ce}from"./dataVisualization-0.0.0-dataease2.js";import{c as W,g as Se,a as De}from"./style-0.0.0-dataease.js";import{g as we,n as ne,p as Ie,r as xe,t as ke}from"./canvasUtils-0.0.0-dataease.js";import{f as Ae}from"./ConfigGlobal.vue_vue_type_script_setup_true_lang-0.0.0-dataease.js";const Ee=T("contextmenu",{state:()=>({menuTop:0,menuLeft:0,menuShow:!1,position:"canvasCore"}),actions:{showContextMenu({top:e,left:t,position:o}){this.menuShow=!0,this.menuTop=e,this.menuLeft=t,this.position=o},hideContextMenu(){this.menuShow=!1}}}),Ke=()=>Ee($);function B(e,t,o,n="canvas-main",l){if(e.style.left=e.style.left+o.left,e.style.top=e.style.top+o.top,l&&e.groupStyle){const s=e.groupStyle.left/e.groupStyle.width,a=e.groupStyle.top/e.groupStyle.height;e.groupStyle.width=e.groupStyle.width*l.width,e.groupStyle.height=e.groupStyle.height*l.height,e.groupStyle.left=o.left+e.groupStyle.width*s,e.groupStyle.top=o.top+e.groupStyle.height*a}e.canvasId=n}const P=()=>ye(),{t:_}=Ae(),x=K(),{curComponent:S,componentData:d,curOriginThemes:be}=g(x),Ge=T("compose",{state:()=>({areaData:{style:{top:0,left:0,width:0,height:0},components:[]},editorMap:{},isCtrlOrCmdDown:!1,isSpaceDown:!1,isShiftDown:!1,laterIndex:null,editor:null}),actions:{getEditor(e="canvas-main"){this.editorMap[e]=he("#editor-"+e)},setLaterIndex(e){this.laterIndex=e},setSpaceDownStatus(e){this.isSpaceDown=e},setIsCtrlOrCmdDownStatus(e){this.isCtrlOrCmdDown=e},setIsShiftDownStatus(e){this.isShiftDown=e},setAreaData(e){this.areaData=e},updateGroupBorder(e){if(e){const t=e.replace("Group-",""),o=d.value.filter(a=>a.id===t)[0],n=o.propValue,l={...o.style};n.forEach(a=>{B(a,null,l)});const s={style:{top:0,left:0,width:0,height:0},components:n};this.calcComposeArea(s),o.style={...o.style,...s.style},n.forEach(a=>{a.canvasId=e}),W(o)}},alignment:function(e){const{areaData:t}=this;if(t.components.length===1){t.components=[];return}t.components.length>0&&t.style.width===0&&this.calcComposeArea();const{left:o,top:n,width:l,height:s}=t.style,a=o+l,c=o+l/2,r=n+s,f=n+s/2;t.components.forEach(i=>{e==="left"?i.style.left=o:e==="right"?i.style.left=a-i.style.width:e==="top"?i.style.top=n:e==="bottom"?i.style.top=r-i.style.height:e==="transverse"?i.style.left=c-i.style.width/2:e==="direction"&&(i.style.top=f-i.style.height/2)})},compose:function(e="canvas-main"){const t=this.editorMap[e],{areaData:o}=this;if(o.components.length===1){o.components=[];return}o.components.length>0&&this.calcComposeArea();const n=[];o.components.forEach(a=>{if(["Group"].includes(a.component)){const c={...a.style},r=a.propValue,f=t.getBoundingClientRect();r.forEach(i=>{B(i,f,c)}),n.push(...a.propValue)}else["GroupArea"].includes(a.component)||we(a)&&n.push(a)});const l=P();n.forEach(a=>{a.canvasId="Group-"+l});const s=D({id:l,component:"Group",canvasActive:!1,name:_("visualization.view_group"),label:_("visualization.view_group"),icon:"group",expand:!0,commonBackground:{...ve[be.value],backgroundColorSelect:!1,innerPadding:0},...ge,style:{...Ce,...o.style},propValue:n});W(s),x.addComponent({component:s,index:void 0}),I.emit("hideArea-canvas-main"),this.batchDeleteComponent(o.components),x.setCurComponent({component:d.value[d.value.length-1],index:d.value.length-1}),this.areaData.components=[]},batchDeleteComponent(e){e.forEach(t=>{if(!["GroupArea"].includes(t.component)){for(let o=0,n=d.value.length;o<n;o++)if(t.id==d.value[o].id){d.value.splice(o,1);break}}})},decompose(){const e=S.value.canvasId,t=this.editorMap[e];if(!t)return;const o={...S.value.style},n=S.value.propValue,l=t.getBoundingClientRect(),s=ne(e);let a=d.value,c=null;if(s){const r={};d.value.forEach(h=>{Ie(h,null,r)});const i=r[S.value.id].propValue.filter(h=>e.indexOf(h.name)>-1);i&&i.length>0&&(a=i[0].componentData),c=S.value.groupStyle}x.deleteComponentById(S.value.id,a),n.forEach(r=>{B(r,l,o,e,c),x.addComponent({component:r,index:void 0,isFromGroup:!0,componentData:a})})},calcComposeArea(e=this.areaData){if(e.components<=1)return;let t=1/0,o=1/0,n=-1/0,l=-1/0;e.components.forEach(s=>{let a={left:0,top:0,right:0,bottom:0};a=Se(s.style),a.left<o&&(o=a.left),a.top<t&&(t=a.top),a.right>n&&(n=a.right),a.bottom>l&&(l=a.bottom)}),e.style={left:o,top:t,width:n-o,height:l-t}}}}),se=()=>Ge($),v=K(),y=se(),Me=Ke(),{multiplexingStyleAdapt:Oe,curComponent:m,curComponentIndex:L,curMultiplexingComponents:Ve,dvInfo:N,pcMatrixCount:Te,canvasStyleData:b,componentData:q}=g(v),{menuTop:$e,menuLeft:Be}=g(Me),H=ae(),Le=T("copy",{state:()=>({copyDataArray:[],copyData:null,isCut:!1}),actions:{copyMultiplexingComponents(e,t=Ve.value,o=!1,n="multiplexing",l=(s=>(s=b.value)==null?void 0:s.scale)()){const a=this,{scale:c}=b.value;Object.keys(t).forEach(function(r,f){const i=D(t[r]);if(i.canvasId="canvas-main",o)i.style.top=i.style.height+i.style.top;else{const h=f%2;n==="multiplexing"&&!Oe.value?(i.style.width=i.style.width*c/l,i.style.height=i.style.height*c/l):(i.sizeX=Te.value.x/2,i.sizeY=14,i.style.width=b.value.width/3*c/100,i.style.height=b.value.height/3*c/100),i.x=i.sizeX*h+1,i.y=xe()+10,i.style.left=0,i.style.top=0}a.copyData={data:[i],copyCanvasViewInfo:e,index:f,copyFrom:n},a.paste()})},copy(){m.value&&m.value.component!=="GroupArea"?this.copyDataInfo([m.value]):y.areaData.components.length&&this.copyDataInfo(y.areaData.components),this.isCut=!1},paste(e){if(!this.copyData)return;const t=this.copyData.data;let o=0;const n=this.copyData,l=t.length>1?300:10,s=setInterval(function(){if(o>=t.length)clearInterval(s);else{const a=t[o];N.value.type==="dataV"?e?(a.style.top=$e,a.style.left=Be):(a.style.top+=10,a.style.left+=10):a.y=a.y+a.sizeY;const c={},r=O(a,c);r.category="base",r.canvasId.includes("Group")&&(r.canvasId="canvas-main"),v.addCopyComponent(r,c,n.copyCanvasViewInfo),v.multiplexingStyleAdapt&&n.copyFrom==="multiplexing"&&me(r),N.value.type==="dashboard"&&I.emit("addDashboardItem-"+r.canvasId,r),o===t.length-1&&v.setCurComponent({component:r,index:q.value.length-1}),o++}},l);H.recordSnapshotCache("paste")},cut(e=q.value){m.value&&m.value.component!=="GroupArea"?(this.copyDataInfo([m.value]),v.deleteComponentById(m.value.id,e)):y.areaData.components.length&&(this.copyDataInfo(y.areaData.components),y.areaData.components.forEach(t=>{v.deleteComponentById(t.id)}),y.setAreaData({style:{left:0,top:0,width:0,height:0},components:[]})),H.recordSnapshotCache("cut"),this.isCut=!0},restorePreCutData(){if(this.isCut&&this.copyData){const e=D(this.copyData.data),t=this.copyData.index;v.addComponent({component:e,index:t}),L.value>=t&&L.value++}},copyDataArrayInfo(){this.copyDataArray=D(y.areaData.components)},copyDataInfo(e){this.copyData={data:D(e),index:L}}}});function Kt(e,t,o){const n=[];return t.forEach(l=>{const s=O(l,o);s.canvasId=e,n.push(s)}),n}function O(e,t){var l;const o=D(e);o.freeze&&(o.freeze=!1);const n=P();return t[e.id]=n,o.id=n,o.inMobile=!1,delete o.mStyle,delete o.mEvents,delete o.mPropValue,delete o.mCommonBackground,o.component==="VQuery"&&((l=o.propValue)==null||l.forEach(s=>{s.id=P()})),o.component==="Group"&&o.propValue.forEach((s,a)=>{o.propValue[a]=O(s,t)}),o.component==="DeTabs"&&o.propValue.forEach(s=>{var a;(a=s.componentData)==null||a.forEach((c,r)=>{s.componentData[r]=O(c,t),s.componentData[r].canvasId=o.id+"--"+s.name})}),o}const Pe=()=>Le($),Re=K(),{curComponent:Y}=g(Re),ze=T("lock",{actions:{lock(e=Y.value){e.isLock=!0,e.component==="Group"&&e.propValue.forEach(t=>{t.isLock=!0})},unlock(e=Y.value){e.isLock=!1,e.component==="Group"&&e.propValue.forEach(t=>{t.isLock=!1})}}}),We=()=>ze($),_e=K(),{curComponent:X,componentData:V}=g(_e),bt=e=>{const t=le(e);return t?t.targetComponent:null},le=e=>{if(e)return j(e);if(X.value)return j(X.value.id)},j=e=>{if(e){let t=0,o=0,n=V.value,l=null;return V.value.forEach((s,a)=>{e===s.id&&(t=a,l=s),s.component==="Group"&&s.propValue.forEach((c,r)=>{e===c.id&&(t=r,l=c,n=s.propValue)}),s.component==="DeTabs"&&s.propValue.forEach((c,r)=>{var f;o=r,(f=c.componentData)==null||f.forEach((i,h)=>{e===i.id&&(t=h,l=i,n=c.componentData)})})}),{index:t,tabIndex:o,targetComponent:l,componentData:n}}},Gt=(e,t="down")=>{e.sort((o,n)=>{const l=V.value.findIndex(a=>a.id===o.id),s=V.value.findIndex(a=>a.id===n.id);return t==="down"?s-l:l-s})},k=K(),p=se(),C=ae(),z=Pe(),ie=We(),{curComponent:u,editMode:Ne}=g(k),{areaData:A}=g(p),F=17,J=16,Q=91,re=37,ce=38,ue=39,pe=40,qe=86,He=67,Ye=88,Xe=89,je=90,Fe=71,Je=66,Qe=76,Ue=85,Ze=83,et=80,tt=68,fe=46,ot=8,at=69,U=32,Mt=[8,37,38,39,40,66,67,68,69,71,76,80,83,85,86,88,89,90],de={[qe]:lt,[Xe]:rt,[je]:ct,[Ze]:ft,[et]:dt,[at]:ht},Z={[re]:G,[ce]:G,[ue]:G,[pe]:G},ee={...de,[Ue]:mt},te={...de,[He]:st,[Ye]:it,[Fe]:ut,[Je]:pt,[tt]:R,[fe]:R,[Qe]:yt},nt=()=>{let e=!1;return document.querySelectorAll(".ed-overlay").forEach(t=>{window.getComputedStyle(t).getPropertyValue("display")!="none"&&(e=!0)}),document.querySelectorAll(".ed-popper").forEach(t=>{var o;!((o=t.classList)!=null&&o.contains("template-popper-tips"))&&window.getComputedStyle(t).getPropertyValue("display")!="none"&&(e=!0)}),document.querySelector(".tox-dialog-wrap")&&(e=!0),e};let w=!1,E=!1;function Ot(){window.onkeydown=e=>{if(Ne.value==="preview"||nt())return;const{keyCode:t}=e;Z[t]&&u.value?(Z[t](t),e.preventDefault(),e.stopPropagation()):t===J?(E=!0,p.setIsShiftDownStatus(!0),oe("shift")):t===F||t===Q?(w=!0,p.setIsCtrlOrCmdDownStatus(!0),oe("ctrl")):t===U?(p.setSpaceDownStatus(!0),e.preventDefault(),e.stopPropagation()):(t==fe||t==ot)&&u.value?R():w&&(te[t]&&(!u.value||!u.value.isLock)?(e.preventDefault(),te[t]()):ee[t]&&u.value&&u.value.isLock&&(e.preventDefault(),ee[t]()))},window.onkeyup=e=>{e.keyCode===F||e.keyCode===Q?(w=!1,p.setIsCtrlOrCmdDownStatus(!1)):e.keyCode===J?(E=!0,p.setIsShiftDownStatus(!1)):e.keyCode===U&&(p.setSpaceDownStatus(!1),e.preventDefault(),e.stopPropagation())},window.onmousedown=()=>{k.setInEditorStatus(!1)}}function Vt(){w=!1,p.setIsCtrlOrCmdDownStatus(!1),E=!1,p.setIsShiftDownStatus(!1)}function oe(e){e==="shift"&&w?(w=!1,p.setIsCtrlOrCmdDownStatus(!1)):e==="ctrl"&&E&&(E=!1,p.setIsShiftDownStatus(!1))}function st(){z.copy()}function lt(){z.paste(!1),C.recordSnapshotCache("key-paste")}function G(e){if(u.value){const t=k.canvasStyleData.scale/100;e===re?(u.value.style.left=u.value.style.left-t,M(-t,0)):e===ue?(u.value.style.left=u.value.style.left+t,M(t,0)):e===ce?(u.value.style.top=u.value.style.top-t,M(0,-t)):e===pe&&(u.value.style.top=u.value.style.top+t,M(0,t)),C.recordSnapshotCache("key-move")}}function M(e=0,t=0){const o=u.value.canvasId,n=document.querySelector("#editor-"+o);ke(o)||ne(o)?De(u.value,{width:n.offsetWidth,height:n.offsetHeight}):u.value.component==="GroupArea"&&A.value.components.length>0&&A.value.components.forEach(l=>{l.style.top=l.style.top+t,l.style.left=l.style.left+e})}function it(){z.cut()}function rt(){C.redo()}function ct(){C.undo()}function ut(){A.value.components.length&&(p.compose(),C.recordSnapshotCache("key-compose"))}function pt(){const e=u.value;e&&!e.isLock&&e.component=="Group"&&(p.decompose(),C.recordSnapshotCache("key-decompose"))}function ft(){I.emit("save")}function dt(){I.emit("preview")}function R(){if(u.value&&u.value.component!=="GroupArea"){const e=le();e&&k.deleteComponent(e.index,e.componentData)}else A.value.components.length&&(A.value.components.forEach(e=>{k.deleteComponentById(e.id)}),I.emit("hideArea-canvas-main"));C.recordSnapshotCache("listenGlobalKeyDown")}function ht(){I.emit("clearCanvas")}function yt(){ie.lock()}function mt(){ie.unlock()}export{Ke as a,Ot as b,se as c,Pe as d,le as e,bt as f,P as g,Gt as h,Kt as i,Mt as k,We as l,Vt as r};
