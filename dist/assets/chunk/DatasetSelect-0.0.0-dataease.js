import{b as Be,a as K,aQ as Oe,ap as Pe,R as xe,z as Fe}from"./index-0.0.0-dataease.js";import"./el-popper-0.0.0-dataease.js";import{E as Ae}from"./el-popover-0.0.0-dataease.js";import"./el-footer-0.0.0-dataease.js";import"./el-aside-0.0.0-dataease.js";import"./el-main-0.0.0-dataease.js";import{E as Me}from"./el-tree-0.0.0-dataease.js";import"./el-checkbox-0.0.0-dataease.js";import{a as We,o as je,j as Re,G as Ue,y as He,n as Le}from"./ConfigGlobal.vue_vue_type_script_setup_true_lang-0.0.0-dataease.js";import"./el-form-0.0.0-dataease.js";import{d as Ge,r as i,y as r,w as Qe,o as $e,e as X,a7 as qe,f as l,O as P,j as o,i as a,u as n,R as D,U as Y,S as h,g as m,_ as d,P as w,a4 as b,a3 as x}from"./vue-0.0.0-dataease.js";import{d as Je}from"./dv-folder-0.0.0-dataease.js";import{i as Ke}from"./icon_dataset-0.0.0-dataease.js";import{i as Xe}from"./icon_done_outlined-0.0.0-dataease.js";import{useAppStoreWithOut as Ye}from"./app-0.0.0-dataease.js";import{_ as S}from"./lodash-0.0.0-dataease.js";import{n as Ze,a as et}from"./dataset-0.0.0-dataease.js";import{E as tt,a as at}from"./el-form-item-0.0.0-dataease.js";import{d as ot}from"./dvMain-0.0.0-dataease.js";import{t as st}from"./treeSortUtils-0.0.0-dataease.js";import{E as rt,b as lt,d as nt,c as it}from"./index-0.0.0-dataease16.js";import{_ as ct}from"./_plugin-vue_export-helper-0.0.0-dataease.js";import"./index-0.0.0-dataease4.js";import"./index-0.0.0-dataease3.js";import"./dropdown-0.0.0-dataease.js";import"./token-0.0.0-dataease.js";import"./index-0.0.0-dataease15.js";import"./axios-0.0.0-dataease.js";import"./library-0.0.0-dataease.js";import"./echarts-0.0.0-dataease.js";import"./tinymce-0.0.0-dataease.js";import"./chart-0.0.0-dataease.js";import"./chart-0.0.0-dataease2.js";import"./decimal-0.0.0-dataease.js";import"./dataVisualization-0.0.0-dataease2.js";import"./util-0.0.0-dataease.js";import"./index-0.0.0-dataease21.js";import"./antv-0.0.0-dataease.js";import"./index-0.0.0-dataease22.js";import"./pureFunctionsAny.generated-0.0.0-dataease.js";import"./extends-0.0.0-dataease.js";import"./tslib.es6-0.0.0-dataease.js";import"./sysParameter-0.0.0-dataease.js";import"./TableTooltip-0.0.0-dataease.js";import"./el-col-0.0.0-dataease.js";import"./constants-0.0.0-dataease.js";import"./el-row-0.0.0-dataease.js";import"./_commonjs-dynamic-modules-0.0.0-dataease.js";import"./appearance-0.0.0-dataease.js";import"./font-0.0.0-dataease.js";const ut={key:0,class:"m-loading"},dt={key:1,class:"empty-info"},mt=["title"],pt={class:"m-icon"},ft={class:"footer-container"},_t=Ge({__name:"DatasetSelect",props:{themes:{default:"dark"},modelValue:{},stateObj:{},disabled:{type:Boolean,default:!1},viewId:{},sourceType:{default:"dataset"}},emits:["update:modelValue","update:stateObj","onDatasetChange","addDsWindow"],setup(Z,{expose:ee,emit:te}){const F=ot(),{wsCache:E}=Be("localStorage"),A=We(),{t:c}=je(),u=Z,y=i(null),p=i(!1),g=i(!0),f=i([]),ae=u.sourceType==="datasource"?c("visualization.select_datasource"):c("visualization.select_dataset"),oe=u.sourceType==="datasource"?c("visualization.new_datasource"):c("visualization.new_dataset"),T=r(()=>u.sourceType==="datasource"?c("datasource.datasource"):c("visualization.dataset")),se=e=>{const t=E.get("TreeSort-dataset")||"time_desc";f.value=st(e,t)},M=()=>{p.value=!0;const e=u.sourceType==="datasource"?Ze:et,t=u.sourceType==="datasource"?null:{};e(t).then(s=>{se(s||[])}).finally(()=>{var s;p.value=!1,(s=W.value)==null||s.validate()})},V=te,_=r({get(){return u.modelValue},set(e){V("update:modelValue",e)}}),re={label:"name",children:"children",value:"id",isLeaf:e=>{var t;return!((t=e.children)!=null&&t.length)}},W=i(),N=i();Qe(N,e=>{y.value.filter(e)});const I=r(()=>f.value&&f.value.length>0&&!p.value&&g.value),le=r(()=>g.value?"暂无"+T.value:"已切换至新组织，无权访问其他组织的资源"),ne=r(()=>!I.value&&!p.value&&!g.value),j=r(()=>I.value&&f.value[0].id==="0"?f.value[0].children:f.value),ie=r(()=>S.filter(H(j.value),e=>e.leaf)),R=r(()=>S.find(ie.value,e=>e.id===_.value)),U=r(()=>!(_.value&&R.value===void 0)),z=r(()=>{var e;return U.value?(e=R.value)==null?void 0:e.name:T.value+"不存在"}),ce=r(()=>({name:z.value})),ue=i([{validator:(...e)=>{U.value?e[2]():e[2](new Error)},trigger:["change","blur"]}]);function H(e){let t=S.cloneDeep(e);return S.forEach(e,s=>{s.children&&s.children.length>0&&(t=S.union(t,H(s.children)))}),t}const de=e=>{V("onDatasetChange",e)},me=(e,t)=>{var s;return e?(s=t.name)==null?void 0:s.includes(e):!0},L=()=>{M()},pe=()=>{V("addDsWindow")},G=i(),Q=e=>{var t;e.leaf&&(_.value!==e.id&&de(e.id),_.value=e.id,(t=G.value)==null||t.hide())},B=i(!1);function fe(){B.value=!0}function _e(){B.value=!1}function ve(e){var t;return(t=y==null?void 0:y.value)==null?void 0:t.getNode(e)}const he=r(()=>u.sourceType==="dataset"&&F.curComponent&&["rich-text","picture-group"].includes(F.curComponent.innerType)),ye=e=>{e.preventDefault(),e.stopPropagation(),Q({leaf:!0,id:null}),K().emitter.emit("clear-remove",["xAxis","yAxis","drillFields"])},ge=()=>{u.sourceType==="dataset"&&A.getOid&&E.get("user.oid")&&A.getOid!==E.get("user.oid")?g.value=!1:g.value=!0};ee({getNode:ve});const $=Ye(),ke=r(()=>$.getIsDataEaseBi||$.getIsIframe);return $e(()=>{M(),K({name:"refresh-dataset-selector",callback:()=>L()})}),(e,t)=>{const s=X("ArrowDown"),k=Re,we=X("CircleClose"),q=Ue,be=at,J=He,Se=rt,O=Le,Ce=Me,De=xe,Ee=lt,Te=nt,Ve=it,Ne=Ae,Ie=Fe,ze=qe("permission");return l(),P("div",null,[o(Ne,{ref_key:"datasetSelectorPopover",ref:G,trigger:"click",placement:"bottom-start",width:320,"popper-class":"customDatasetSelect","show-arrow":!1,onShow:fe,onHide:_e,disabled:e.disabled,effect:e.themes,offset:4},{reference:a(()=>[o(be,{ref_key:"formRef",ref:W,model:ce.value},{default:a(()=>[o(n(tt),{prop:"name",rules:ue.value},{default:a(()=>[o(q,{size:"middle",effect:e.themes,modelValue:z.value,"onUpdate:modelValue":t[0]||(t[0]=v=>z.value=v),class:"data-set-dark",onFocus:ge,disabled:e.disabled,placeholder:n(ae)},{suffix:a(()=>[D(o(k,{class:h(["input-arrow-icon",{reverse:B.value}])},{default:a(()=>[o(s)]),_:1},8,["class"]),[[Y,!e.disabled]]),he.value?D((l(),m(k,{key:0,class:"input-custom-clear-icon",onClick:ye},{default:a(()=>[o(we)]),_:1},512)),[[Y,!e.disabled]]):d("",!0)]),_:1},8,["effect","modelValue","disabled","placeholder"])]),_:1},8,["rules"])]),_:1},8,["model"])]),default:a(()=>[o(Ve,{class:h(e.themes)},{default:a(()=>[o(Se,null,{default:a(()=>[w("div",{class:h(["m-title",{dark:e.themes==="dark"}])},[w("div",null,b(T.value),1),o(J,{type:"primary",link:"",class:"refresh-btn",onClick:L},{default:a(()=>[x(b(n(c)("commons.refresh")),1)]),_:1})],2),o(q,{size:"middle",effect:e.themes,modelValue:N.value,"onUpdate:modelValue":t[1]||(t[1]=v=>N.value=v),placeholder:n(c)("dataset.search"),"prefix-icon":n(Oe),clearable:""},null,8,["effect","modelValue","placeholder","prefix-icon"])]),_:1}),o(Ee,{class:h({dark:e.themes==="dark"})},{default:a(()=>[o(De,{"max-height":"252px",always:""},{default:a(()=>[p.value?D((l(),P("div",ut,null,512)),[[Ie,p.value]]):d("",!0),ne.value?(l(),P("div",dt,b(le.value),1)):d("",!0),I.value?(l(),m(Ce,{key:2,class:h({dark:e.themes==="dark"}),ref_key:"datasetSelector",ref:y,"node-key":"id",data:j.value,teleported:!1,props:re,"render-after-expand":!1,filterable:"",onNodeClick:Q,"filter-node-method":me,"empty-text":"暂无相关数据"},{default:a(({node:v,data:C})=>[w("div",{class:h(["tree-row-item",{dark:e.themes==="dark",active:_.value===C.id}]),title:v.label},[w("div",pt,[C.leaf?d("",!0):(l(),m(k,{key:0},{default:a(()=>[o(O,{name:"dv-folder"},{default:a(()=>[o(n(Je),{class:"svg-icon"})]),_:1})]),_:1})),C.leaf?(l(),m(k,{key:1},{default:a(()=>[o(O,{name:"icon_dataset"},{default:a(()=>[o(n(Ke),{class:"svg-icon"})]),_:1})]),_:1})):d("",!0)]),x(" "+b(v.label)+" ",1),_.value===C.id?(l(),m(k,{key:0,class:"checked-item"},{default:a(()=>[o(O,{name:"icon_done_outlined"},{default:a(()=>[o(n(Xe),{class:"svg-icon"})]),_:1})]),_:1})):d("",!0)],10,mt)]),_:1},8,["class","data"])):d("",!0)]),_:1})]),_:1},8,["class"]),ke.value?d("",!0):(l(),m(Te,{key:0},{default:a(()=>[w("div",ft,[D((l(),m(J,{type:"primary",icon:n(Pe),link:"",class:"add-btn",onClick:pe},{default:a(()=>[x(b(n(oe)),1)]),_:1},8,["icon"])),[[ze,e.sourceType==="datasource"?["datasource"]:["dataset"]]])])]),_:1}))]),_:1},8,["class"])]),_:1},8,["disabled","effect"])])}}});const ma=ct(_t,[["__scopeId","data-v-bff13f41"]]);export{ma as default};
