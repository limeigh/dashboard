import{w as Be,e as Fe,r as Pe,x as Oe,i as We,l as Ae,t as Me,b as Ue,n as He,a7 as Le,o as Re,g as je,v as $e}from"./element-plus-secondary-0.0.0-dataease.js";import{a as qe,f as Ye,e as Ge}from"./ConfigGlobal.vue_vue_type_script_setup_true_lang-0.0.0-dataease.js";import{d as Je,r as n,k as s,w as Ke,b as Qe,ae as Q,aq as Xe,o as i,c as F,W as a,U as o,u as l,$ as D,a0 as X,z as h,T as u,R as p,a as w,Y as b,_ as P}from"./@vue-0.0.0-dataease.js";import{d as Ze}from"./dv-folder-0.0.0-dataease.js";import{i as et}from"./icon_dataset-0.0.0-dataease.js";import{i as tt}from"./icon_done_outlined-0.0.0-dataease.js";import{F as ot,p as at}from"./@element-plus-0.0.0-dataease.js";import{useAppStoreWithOut as rt}from"./app-0.0.0-dataease.js";import{_ as S}from"./lodash-0.0.0-dataease.js";import{l as st,g as it}from"./dataset-0.0.0-dataease.js";import{a as lt,u as Z,g as O}from"./index-0.0.0-dataease.js";import{d as nt}from"./dvMain-0.0.0-dataease.js";import{t as mt}from"./treeSortUtils-0.0.0-dataease.js";import{_ as ct}from"./_plugin-vue_export-helper-0.0.0-dataease.js";import"./@vueuse-0.0.0-dataease.js";import"./lodash-es-0.0.0-dataease.js";import"./dayjs-0.0.0-dataease.js";import"./@amap-0.0.0-dataease.js";import"./@popperjs-0.0.0-dataease.js";import"./async-validator-0.0.0-dataease.js";import"./@ctrl-0.0.0-dataease.js";import"./normalize-wheel-es-0.0.0-dataease.js";import"./memoize-one-0.0.0-dataease.js";import"./pinia-0.0.0-dataease.js";import"./vue-demi-0.0.0-dataease.js";import"./axios-0.0.0-dataease.js";import"./qs-0.0.0-dataease.js";import"./side-channel-0.0.0-dataease.js";import"./es-errors-0.0.0-dataease.js";import"./object-inspect-0.0.0-dataease.js";import"./crypto-js-0.0.0-dataease.js";import"./side-channel-list-0.0.0-dataease.js";import"./side-channel-map-0.0.0-dataease.js";import"./get-intrinsic-0.0.0-dataease.js";import"./es-object-atoms-0.0.0-dataease.js";import"./math-intrinsics-0.0.0-dataease.js";import"./gopd-0.0.0-dataease.js";import"./es-define-property-0.0.0-dataease.js";import"./has-symbols-0.0.0-dataease.js";import"./get-proto-0.0.0-dataease.js";import"./dunder-proto-0.0.0-dataease.js";import"./call-bind-apply-helpers-0.0.0-dataease.js";import"./function-bind-0.0.0-dataease.js";import"./hasown-0.0.0-dataease.js";import"./call-bound-0.0.0-dataease.js";import"./side-channel-weakmap-0.0.0-dataease.js";import"./jspdf-0.0.0-dataease.js";import"./@babel-0.0.0-dataease.js";import"./fflate-0.0.0-dataease.js";import"./fast-png-0.0.0-dataease.js";import"./iobuffer-0.0.0-dataease.js";import"./pako-0.0.0-dataease.js";import"./vue-router_2-0.0.0-dataease.js";import"./vue-0.0.0-dataease.js";import"./vue-i18n-0.0.0-dataease.js";import"./@intlify-0.0.0-dataease.js";import"./echarts-0.0.0-dataease.js";import"./zrender-0.0.0-dataease.js";import"./tinymce-0.0.0-dataease.js";import"./web-storage-cache-0.0.0-dataease.js";import"./login-0.0.0-dataease.js";import"./mitt-0.0.0-dataease.js";import"./vue-types-0.0.0-dataease.js";import"./is-plain-object-0.0.0-dataease.js";import"./js-base64-0.0.0-dataease.js";import"./chart-0.0.0-dataease.js";import"./chart-0.0.0-dataease2.js";import"./decimal.js-0.0.0-dataease.js";import"./dataVisualization-0.0.0-dataease2.js";import"./util-0.0.0-dataease.js";import"./snowflake-id-0.0.0-dataease.js";import"./index-0.0.0-dataease12.js";import"./@antv-0.0.0-dataease.js";import"./eventemitter3-0.0.0-dataease.js";import"./@mapbox-0.0.0-dataease.js";import"./pbf-0.0.0-dataease.js";import"./ieee754-0.0.0-dataease.js";import"./supercluster-0.0.0-dataease.js";import"./gl-matrix-0.0.0-dataease.js";import"./tslib-0.0.0-dataease.js";import"./detect-browser-0.0.0-dataease.js";import"./size-sensor-0.0.0-dataease.js";import"./d3-regression-0.0.0-dataease.js";import"./d3-hierarchy-0.0.0-dataease.js";import"./fmin-0.0.0-dataease.js";import"./pdfast-0.0.0-dataease.js";import"./d3-ease-0.0.0-dataease.js";import"./d3-interpolate-0.0.0-dataease.js";import"./d3-color-0.0.0-dataease.js";import"./d3-timer-0.0.0-dataease.js";import"./fecha-0.0.0-dataease.js";import"./topojson-client-0.0.0-dataease.js";import"./viewport-mercator-project-0.0.0-dataease.js";import"./@turf-0.0.0-dataease.js";import"./polygon-clipping-0.0.0-dataease.js";import"./splaytree-0.0.0-dataease.js";import"./robust-predicates-0.0.0-dataease.js";import"./d3-scale-0.0.0-dataease.js";import"./d3-collection-0.0.0-dataease.js";import"./d3-format-0.0.0-dataease.js";import"./d3-time-format-0.0.0-dataease.js";import"./d3-time-0.0.0-dataease.js";import"./d3-array-0.0.0-dataease.js";import"./earcut-0.0.0-dataease.js";import"./regl-0.0.0-dataease.js";import"./mapbox-gl-0.0.0-dataease.js";import"./d3-dsv-0.0.0-dataease.js";import"./geojson-vt-0.0.0-dataease.js";import"./hammerjs-0.0.0-dataease.js";import"./element-resize-detector-0.0.0-dataease.js";import"./batch-processor-0.0.0-dataease.js";import"./d3-hexbin-0.0.0-dataease.js";import"./mathjs-0.0.0-dataease.js";import"./typed-function-0.0.0-dataease.js";import"./complex.js-0.0.0-dataease.js";import"./sysParameter-0.0.0-dataease.js";import"./TableTooltip-0.0.0-dataease.js";import"./exceljs-0.0.0-dataease.js";import"./file-saver-0.0.0-dataease.js";import"./appearance-0.0.0-dataease.js";import"./font-0.0.0-dataease.js";import"./less-0.0.0-dataease.js";import"./copy-anything-0.0.0-dataease.js";import"./is-what-0.0.0-dataease.js";const pt={key:0,class:"m-loading"},ut={key:1,class:"empty-info"},dt=["title"],ft={class:"m-icon"},_t={class:"footer-container"},vt=Je({__name:"DatasetSelect",props:{themes:{default:"dark"},modelValue:{},stateObj:{},disabled:{type:Boolean,default:!1},viewId:{},sourceType:{default:"dataset"}},emits:["update:modelValue","update:stateObj","onDatasetChange","addDsWindow"],setup(ee,{expose:te,emit:oe}){const W=nt(),{wsCache:T}=lt("localStorage"),A=qe(),{t:m}=Ye(),c=ee,g=n(null),d=n(!1),y=n(!0),f=n([]),ae=c.sourceType==="datasource"?m("visualization.select_datasource"):m("visualization.select_dataset"),re=c.sourceType==="datasource"?m("visualization.new_datasource"):m("visualization.new_dataset"),E=s(()=>c.sourceType==="datasource"?m("datasource.datasource"):m("visualization.dataset")),se=e=>{const t=T.get(O("TreeSort-dataset"))||"time_desc";f.value=mt(e,t)},M=()=>{d.value=!0;const e=c.sourceType==="datasource"?st:it,t=c.sourceType==="datasource"?null:{};e(t).then(r=>{se(r||[])}).finally(()=>{var r;d.value=!1,(r=U.value)==null||r.validate()})},V=oe,_=s({get(){return c.modelValue},set(e){V("update:modelValue",e)}}),ie={label:"name",children:"children",value:"id",isLeaf:e=>{var t;return!((t=e.children)!=null&&t.length)}},U=n(),N=n();Ke(N,e=>{g.value.filter(e)});const I=s(()=>f.value&&f.value.length>0&&!d.value&&y.value),le=s(()=>y.value?"暂无"+E.value:"已切换至新组织，无权访问其他组织的资源"),ne=s(()=>!I.value&&!d.value&&!y.value),H=s(()=>I.value&&f.value[0].id==="0"?f.value[0].children:f.value),me=s(()=>S.filter(j(H.value),e=>e.leaf)),L=s(()=>S.find(me.value,e=>e.id===_.value)),R=s(()=>!(_.value&&L.value===void 0)),x=s(()=>{var e;return R.value?(e=L.value)==null?void 0:e.name:E.value+"不存在"}),ce=s(()=>({name:x.value})),pe=n([{validator:(...e)=>{R.value?e[2]():e[2](new Error)},trigger:["change","blur"]}]);function j(e){let t=S.cloneDeep(e);return S.forEach(e,r=>{r.children&&r.children.length>0&&(t=S.union(t,j(r.children)))}),t}const ue=e=>{V("onDatasetChange",e)},de=(e,t)=>{var r;return e?(r=t.name)==null?void 0:r.includes(e):!0},$=()=>{M()},fe=()=>{V("addDsWindow")},q=n(),Y=e=>{var t;e.leaf&&(_.value!==e.id&&ue(e.id),_.value=e.id,(t=q.value)==null||t.hide())},z=n(!1);function _e(){z.value=!0}function ve(){z.value=!1}function he(e){var t;return(t=g==null?void 0:g.value)==null?void 0:t.getNode(e)}const ge=s(()=>c.sourceType==="dataset"&&W.curComponent&&["rich-text","picture-group"].includes(W.curComponent.innerType)),ye=e=>{e.preventDefault(),e.stopPropagation(),Y({leaf:!0,id:null}),Z().emitter.emit("clear-remove",["xAxis","yAxis","drillFields"])},ke=()=>{c.sourceType==="dataset"&&A.getOid&&T.get(O("user.oid"))&&A.getOid!==T.get(O("user.oid"))?y.value=!1:y.value=!0};te({getNode:he});const G=rt(),we=s(()=>G.getIsDataEaseBi||G.getIsIframe);return Qe(()=>{M(),Z({name:"refresh-dataset-selector",callback:()=>$()})}),(e,t)=>{const r=Q("ArrowDown"),k=Fe,be=Q("CircleClose"),J=Pe,Se=Oe,K=We,Ce=Ae,B=Ge,De=Me,Te=Ue,Ee=He,Ve=Le,Ne=Re,Ie=je,xe=$e,ze=Xe("permission");return i(),F("div",null,[a(Ie,{ref_key:"datasetSelectorPopover",ref:q,trigger:"click",placement:"bottom-start",width:320,"popper-class":"customDatasetSelect","show-arrow":!1,onShow:_e,onHide:ve,disabled:e.disabled,effect:e.themes,offset:4},{reference:o(()=>[a(Se,{ref_key:"formRef",ref:U,model:ce.value},{default:o(()=>[a(l(Be),{prop:"name",rules:pe.value},{default:o(()=>[a(J,{size:"middle",effect:e.themes,modelValue:x.value,"onUpdate:modelValue":t[0]||(t[0]=v=>x.value=v),class:"data-set-dark",onFocus:ke,disabled:e.disabled,placeholder:l(ae)},{suffix:o(()=>[D(a(k,{class:h(["input-arrow-icon",{reverse:z.value}])},{default:o(()=>[a(r)]),_:1},8,["class"]),[[X,!e.disabled]]),ge.value?D((i(),u(k,{key:0,class:"input-custom-clear-icon",onClick:ye},{default:o(()=>[a(be)]),_:1},512)),[[X,!e.disabled]]):p("",!0)]),_:1},8,["effect","modelValue","disabled","placeholder"])]),_:1},8,["rules"])]),_:1},8,["model"])]),default:o(()=>[a(Ne,{class:h(e.themes)},{default:o(()=>[a(Ce,null,{default:o(()=>[w("div",{class:h(["m-title",{dark:e.themes==="dark"}])},[w("div",null,b(E.value),1),a(K,{type:"primary",link:"",class:"refresh-btn",onClick:$},{default:o(()=>[P(b(l(m)("commons.refresh")),1)]),_:1})],2),a(J,{size:"middle",effect:e.themes,modelValue:N.value,"onUpdate:modelValue":t[1]||(t[1]=v=>N.value=v),placeholder:l(m)("dataset.search"),"prefix-icon":l(ot),clearable:""},null,8,["effect","modelValue","placeholder","prefix-icon"])]),_:1}),a(Ee,{class:h({dark:e.themes==="dark"})},{default:o(()=>[a(Te,{"max-height":"252px",always:""},{default:o(()=>[d.value?D((i(),F("div",pt,null,512)),[[xe,d.value]]):p("",!0),ne.value?(i(),F("div",ut,b(le.value),1)):p("",!0),I.value?(i(),u(De,{key:2,class:h({dark:e.themes==="dark"}),ref_key:"datasetSelector",ref:g,"node-key":"id",data:H.value,teleported:!1,props:ie,"render-after-expand":!1,filterable:"",onNodeClick:Y,"filter-node-method":de,"empty-text":"暂无相关数据"},{default:o(({node:v,data:C})=>[w("div",{class:h(["tree-row-item",{dark:e.themes==="dark",active:_.value===C.id}]),title:v.label},[w("div",ft,[C.leaf?p("",!0):(i(),u(k,{key:0},{default:o(()=>[a(B,{name:"dv-folder"},{default:o(()=>[a(l(Ze),{class:"svg-icon"})]),_:1})]),_:1})),C.leaf?(i(),u(k,{key:1},{default:o(()=>[a(B,{name:"icon_dataset"},{default:o(()=>[a(l(et),{class:"svg-icon"})]),_:1})]),_:1})):p("",!0)]),P(" "+b(v.label)+" ",1),_.value===C.id?(i(),u(k,{key:0,class:"checked-item"},{default:o(()=>[a(B,{name:"icon_done_outlined"},{default:o(()=>[a(l(tt),{class:"svg-icon"})]),_:1})]),_:1})):p("",!0)],10,dt)]),_:1},8,["class","data"])):p("",!0)]),_:1})]),_:1},8,["class"]),we.value?p("",!0):(i(),u(Ve,{key:0},{default:o(()=>[w("div",_t,[D((i(),u(K,{type:"primary",icon:l(at),link:"",class:"add-btn",onClick:fe},{default:o(()=>[P(b(l(re)),1)]),_:1},8,["icon"])),[[ze,e.sourceType==="datasource"?["datasource"]:["dataset"]]])])]),_:1}))]),_:1},8,["class"])]),_:1},8,["disabled","effect"])])}}});const Fa=ct(vt,[["__scopeId","data-v-51b1a3e6"]]);export{Fa as default};
