import b from"./html2canvas-0.0.0-dataease.js";import{E as v}from"./jspdf-0.0.0-dataease.js";import{d as E}from"./dvMain-0.0.0-dataease.js";import{f as O,l as V}from"./index-0.0.0-dataease.js";import{s as P}from"./pinia-0.0.0-dataease.js";import{k as S}from"./ConfigGlobal.vue_vue_type_script_setup_true_lang-0.0.0-dataease.js";import{g as T}from"./util-0.0.0-dataease.js";import{E as m}from"./element-plus-secondary-0.0.0-dataease.js";import{F as g}from"./file-saver-0.0.0-dataease.js";import{t as A}from"./html-to-image-0.0.0-dataease.js";const C="/static-resource/",N=(t,o)=>S.post({url:"/staticResource/upload/"+t,headersType:"multipart/form-data",loading:!0,data:o});function k(t){const o=t.type.startsWith("image/"),e=t.size/1024/1024<15;return o?e?!0:(m.error("图片大小不能超过15M"),!1):(m.error("请上传图片"),!1)}function K(t,o){const e=T(),n=t.name,s=e+n.substr(n.lastIndexOf("."),n.length),r=C+s,i=new FormData;return i.append("file",t),N(e,i).then(()=>{o(r)})}function U(t){return S.post({url:"/staticResource/findResourceAsBase64",data:t})}const h=O(),R=E(),{canvasStyleData:f,componentData:w,canvasViewInfo:x,canvasViewDataInfo:D,dvInfo:F}=P(R),d="/iic-dae-dataease2/de2api";function y(t){return t.replace("//de2api","/de2api")}function Q(t){if(t)if(typeof t=="string"&&t.indexOf("static-resource")>-1){const o=t?(d.endsWith("/")?d.substring(0,d.length-1):d)+t:null;return y(h.baseUrl?`${h.baseUrl}${o.startsWith("/api")?o.slice(5):o}`.replace("com//","com/"):o)}else return y(t.replace("com//","com/"))}function X(t,o,e,n,s){try{W(function(r){b(o).then(i=>{const a=V(x.value);Object.keys(a).forEach(p=>{a[p].data=D.value[p]});const c=i.toDataURL("image/jpeg",.1);if(c!==""){const p={name:e,templateType:"self",snapshot:c,dvType:F.value.type,nodeType:t,version:3,canvasStyleData:JSON.stringify(f.value),componentData:JSON.stringify(w.value),dynamicData:JSON.stringify(a),staticResource:JSON.stringify(r||{}),appData:n?JSON.stringify(n):null},u=new Blob([JSON.stringify(p)],{type:""});t==="template"?g.saveAs(u,e+"-TEMPLATE.DET2"):t==="app"&&g.saveAs(u,e+"-APP.DET2APP")}s&&s()})})}catch(r){s&&s(),console.error(r)}}function Y(t,o,e,n){A(o).then(s=>{if(t==="img"){const r=document.createElement("a");r.setAttribute("download",e+".png"),r.href=s,document.body.appendChild(r),r.click(),document.body.removeChild(r)}else{const r=o.offsetWidth,i=o.offsetHeight,a=r>i?"l":"p",c=new v(a,"pt",[r,i]);c.addImage(s,"PNG",0,0,r,i),c.save(e+".pdf")}n&&n()}).catch(s=>{n&&n(),console.error("oops, something went wrong!",s)})}function Z(t,o,e,n){o&&b(o).then(s=>{const r=document.body.appendChild(s);r.style.display="none",document.body.removeChild(r);const i=r.toDataURL("image/png",1);if(t==="img"){const a=document.createElement("a");a.setAttribute("download",e),a.href=i,document.body.appendChild(a),a.click(),document.body.removeChild(a)}else{const a=o.offsetWidth,c=o.offsetHeight,p=a>c?"l":"p",u=new v(p,"pt",[a,c]);u.addImage(i,"PNG",0,0,a,c),u.save(e+".pdf")}n&&n()}).catch(s=>{console.error("oops, something went wrong!",s),n&&n()})}function l(t,o){t==null||t.forEach(e=>{typeof e.commonBackground.outerImage=="string"&&e.commonBackground.outerImage.indexOf("static-resource")>-1&&o.push(e.commonBackground.outerImage),e.component==="Picture"&&e.propValue.url&&typeof e.propValue.url=="string"&&e.propValue.url.indexOf("static-resource")>-1?o.push(e.propValue.url):e.component==="UserView"&&e.innerType==="picture-group"&&e.propValue.urlList&&e.propValue.urlList.length>0?e.propValue.urlList.forEach(n=>{n.url.indexOf("static-resource")>-1&&o.push(n.url)}):e.component==="Group"?l(e.propValue,o):e.component==="DeTabs"&&e.propValue.forEach(n=>{l(n.componentData,o)})})}function W(t){const o=[];if(typeof f.value.background=="string"&&f.value.background.indexOf("static-resource")>-1&&o.push(f.value.background),l(w.value,o),o.length>0)try{U({resourcePathList:o}).then(e=>{t(e.data)})}catch(e){console.error("findResourceAsBase64 error",e),t()}else setTimeout(()=>{t()},0)}export{Y as a,k as b,X as c,Z as d,Q as i,K as u};
