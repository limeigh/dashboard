import"./index-0.0.0-dataease.js";import{o as xe,y as ye,F as te}from"./ConfigGlobal.vue_vue_type_script_setup_true_lang-0.0.0-dataease.js";import{d as _e}from"./dvMain-0.0.0-dataease.js";import{v as Me,M as ke}from"./chart-0.0.0-dataease.js";import{X as Ie,N as j,B as Te}from"./antv-0.0.0-dataease.js";import{u as ne}from"./index.esm-0.0.0-dataease.js";import{f as q,i as be,j as b}from"./index-0.0.0-dataease21.js";import{h as we,e as Se,n as Ne,K as Ee}from"./lodash-0.0.0-dataease.js";import{d as De,y as W,o as Be,ai as ze,f as He,O as Ae,P as X,S as Le,j as oe,i as re,a3 as ie,a4 as ae,u as se,W as Oe,n as Ke}from"./vue-0.0.0-dataease.js";import{_ as Ve}from"./_plugin-vue_export-helper-0.0.0-dataease.js";import"./axios-0.0.0-dataease.js";import"./library-0.0.0-dataease.js";import"./echarts-0.0.0-dataease.js";import"./tinymce-0.0.0-dataease.js";import"./dataVisualization-0.0.0-dataease2.js";import"./util-0.0.0-dataease.js";import"./appearance-0.0.0-dataease.js";import"./font-0.0.0-dataease.js";import"./tslib.es6-0.0.0-dataease.js";import"./dataset-0.0.0-dataease.js";import"./chart-0.0.0-dataease2.js";import"./app-0.0.0-dataease.js";import"./decimal-0.0.0-dataease.js";import"./index-0.0.0-dataease22.js";import"./pureFunctionsAny.generated-0.0.0-dataease.js";import"./extends-0.0.0-dataease.js";import"./sysParameter-0.0.0-dataease.js";import"./TableTooltip-0.0.0-dataease.js";import"./el-col-0.0.0-dataease.js";import"./constants-0.0.0-dataease.js";import"./el-row-0.0.0-dataease.js";import"./_commonjs-dynamic-modules-0.0.0-dataease.js";const Re=["id"],Ge={class:"button-group"},Pe=["id"],Fe=1,Ue=De({__name:"TableHeaderGroupConfig",props:{chart:{type:Object,required:!0},themes:{type:String,default:"dark"},propertyInner:{type:Array}},emits:["onConfigChange","onCancelConfig"],setup(F,{emit:ce}){const{t:C}=xe(),le=_e(),B=F,Y=ce,de=()=>{Y("onCancelConfig")},O=W(()=>{const s=[...B.chart.xAxis];return B.chart.type==="table-normal"&&s.push(...B.chart.yAxis),s}),fe=()=>{var k;const s=(k=O.value)==null?void 0:k.map(f=>f.hide!==!0&&f.dataeaseName).filter(f=>f),{fields:o,meta:l}=e.dataCfg,u=l.filter(f=>!s.includes(f.field));Y("onConfigChange",{columns:o.columns,meta:u})},he=()=>{var u,k;const s=Se(B.chart),{headerGroupConfig:o}=s.customAttr.tableHeader,l=[];if((u=O.value)==null||u.forEach(f=>{f.hide!==!0&&l.push({key:f.dataeaseName})}),!!l.length){if((k=o==null?void 0:o.columns)!=null&&k.length){const f=l.map(w=>w.key),U=q(o.columns).map(w=>w.key);if(!Ne(f,U)){const{columns:w,meta:V}=o;w.splice(0,w.length,...l),V.splice(0,V.length)}}else s.customAttr.tableHeader.headerGroupConfig={columns:[...l],meta:[]};Ke(()=>{ue(s)})}},v=W(()=>"menu-group-"+B.chart.id),K=W(()=>"table-container-"+B.chart.id);let e;const ue=s=>{var Z,$,ee;const o=le.getViewDataDetails(s.id),l=document.getElementById(K.value);let u=[];(Z=o==null?void 0:o.tableRow)!=null&&Z.length&&(u=o.tableRow.slice(0,10));const{headerGroupConfig:k}=s.customAttr.tableHeader,f=[...k.meta],Q=k.columns,U=O.value.reduce((r,n)=>(r[n.dataeaseName]=n,r),{});($=o==null?void 0:o.fields)!=null&&$.length?o.fields.forEach(r=>{const n=U[r.dataeaseName];(n==null?void 0:n.hide)!==!0&&f.push({field:r.dataeaseName,name:r.chartShowName??r.name,formatter:function(t){if(!n||t==null||![2,3].includes(n.deType)||!Ee(t))return t;let _=n.formatterCfg;return _||(_=ke),Me(t,_)}})}):(ee=O.value)==null||ee.forEach(r=>{r.hide!==!0&&f.push({field:r.dataeaseName,name:r.chartShowName??r.name})});const w={fields:{columns:Q},meta:f,data:u},V={width:l.getBoundingClientRect().width,height:l.offsetHeight,tooltip:{getContainer:()=>l,renderTooltip:r=>new ge(r),style:{position:"absolute",borderRadius:"4px"}},interaction:{rangeSelection:!1,resize:{colCellHorizontal:!1,colCellVertical:!1,rowCellVertical:!1}}};e=new Ie(l,w,V);const Ce=be(s);e.setTheme(Ce);const D=document.getElementById(v.value);e.on(j.COL_CELL_CONTEXT_MENU,r=>{var A,L,R,G,P;r.preventDefault();const n=e.dataCfg.fields.columns,t=e.dataCfg.meta,_=e.interaction.getActiveCells(),S=_==null?void 0:_.map(y=>y.getMeta().field),p=b(S,n),c=e.getCell(r.target);if(D.innerText="",p!=null&&p.length&&p.findIndex(N=>N.key===c.getMeta().field)===-1){e.interaction.clearState(),e.hideTooltip();return}if((p==null?void 0:p.length)===1&&c.getMeta().colIndex===-1){e.interaction.clearState(),e.interaction.selectHeaderCell({cell:c});const y=document.createElement("span");D.appendChild(y),y.innerText=C("chart.cancel_group"),y.onclick=()=>{var i,x;e.hideTooltip();const d=c.getMeta().parent;if((d==null?void 0:d.id)==="root"){const m=n.findIndex(a=>a.key===c.getMeta().field),[T]=b([c.getMeta().field],n);n.splice(m,1,...T.children);const I=t.findIndex(a=>a.field===c.getMeta().field);t.splice(I,1),e.setDataCfg({fields:{columns:n},meta:t}),e.render(!0)}else{const[m]=b([d.field],n);if(m){const T=(i=m.children)==null?void 0:i.findIndex(g=>g.key===c.getMeta().field),[I]=b([c.getMeta().field],m.children);(x=m.children)==null||x.splice(T,1,...I.children);const a=t.findIndex(g=>g.field===c.getMeta().field);t.splice(a,1),e.setDataCfg({fields:{columns:n},meta:t}),e.render(!0)}}e.interaction.clearState()};const N=document.createElement("span");D.appendChild(N),N.innerText=C("chart.cancel_all_group"),N.onclick=()=>{var i,x;e.hideTooltip();const d=c.getMeta().parent;if((d==null?void 0:d.id)==="root"){const[m]=b([c.getMeta().field],n),T=q(m.children),I=n.findIndex(M=>M.key===c.getMeta().field);n.splice(I,1,...T);const a=J([m]),g=t.filter(M=>!a.includes(M.field));e.setDataCfg({fields:{columns:n},meta:g}),e.render(!0)}else{const[m]=b([d.field],n);if(m){const[T]=b([c.getMeta().field],m.children),I=q(T.children),a=(i=m.children)==null?void 0:i.findIndex(z=>z.key===c.getMeta().field);(x=m.children)==null||x.splice(a,1,...I);const g=J([T]),M=t.filter(z=>!g.includes(z.field));e.setDataCfg({fields:{columns:n},meta:M}),e.render(!0)}}e.interaction.clearState()};const h=document.createElement("span");D.appendChild(h),h.innerText=C("chart.rename"),h.onclick=()=>{e.hideTooltip();const d=t.find(i=>i.field===c.getMeta().field);te.prompt("",C("chart.group_name"),{confirmButtonText:C("chart.confirm"),cancelButtonText:C("chart.cancel"),showClose:!1,showInput:!0,inputPlaceholder:C("chart.group_name_edit_tip"),inputValue:d.name,inputErrorMessage:C("chart.group_name_error_tip"),inputValidator:i=>(i==null?void 0:i.length)<1||(i==null?void 0:i.length)>50?C("chart.group_name_error_tip"):!0}).then(i=>{d.name=i.value,e.setDataCfg({meta:t}),e.render(!0)}).catch(()=>{})},e.showTooltip({position:{x:r.x,y:r.y},content:D});return}if((p==null?void 0:p.length)>1){if(!_.every(a=>a.getMeta().parent.id===c.getMeta().parent.id))return;let N=-1,h=c;for(;(L=(A=h==null?void 0:h.getMeta)==null?void 0:A.call(h))!=null&&L.parent||h!=null&&h.parent;)N++,h=((G=(R=h==null?void 0:h.getMeta)==null?void 0:R.call(h))==null?void 0:G.parent)||(h==null?void 0:h.parent);let d=-1,i=-1;const x=c.getMeta().parent;x.colIndex!==-1?p.forEach(a=>{const g=x.children.findIndex(M=>M.getMeta().field===a.key);(g<d||d===-1)&&(d=g),(g>i||i===-1)&&(i=g)}):p.forEach(a=>{const g=x.children.findIndex(M=>M.key===a.key);(g<d||d===-1)&&(d=g),(g>i||i===-1)&&(i=g)});const m=[];if((x==null?void 0:x.id)==="root")m.push(...n.slice(d,i+1));else{const[a]=b([x.field],n);m.push(...(P=a.children)==null?void 0:P.slice(d,i+1))}if(pe(m)+N>1)return;const I=document.createElement("span");D.appendChild(I),I.innerText=C("chart.merge_group"),I.onclick=()=>{e.hideTooltip(),te.prompt("",C("chart.group_name"),{confirmButtonText:C("chart.confirm"),cancelButtonText:C("chart.cancel"),showClose:!1,showInput:!0,inputPlaceholder:C("chart.group_name_edit_tip"),inputErrorMessage:C("chart.group_name_error_tip"),inputValue:C("chart.group"),inputValidator:a=>(a==null?void 0:a.length)<1||(a==null?void 0:a.length)>50?C("chart.group_name_error_tip"):!0}).then(a=>{var g;if((x==null?void 0:x.id)==="root"){const M=ne.v4();n==null||n.splice(d,i-d+1,{key:M,children:m}),t.push({field:M,name:a.value}),e.setDataCfg({fields:{columns:n},meta:t}),e.render(!0)}else{const[M]=b([x.field],n),z=ne.v4();(g=M.children)==null||g.splice(d,i-d+1,{key:z,children:m}),t.push({field:z,name:a.value}),e.setDataCfg({fields:{columns:n},meta:t}),e.render(!0)}e.interaction.clearState()}).catch(()=>{})},e.showTooltip({position:{x:r.x,y:r.y},content:D});return}}),e.on(j.COL_CELL_CLICK,r=>{const n=e.store.get("lastClickedCell"),t=r.originalEvent;if(!n||!(t!=null&&t.ctrlKey||t!=null&&t.metaKey||t!=null&&t.shiftKey)){const _=e.getCell(r.target);e.store.set("lastClickedCell",_);return}if(t!=null&&t.shiftKey){if(!n){const y=e.getCell(r.target);e.store.set("lastClickedCell",y);return}const _=e.getCell(r.target),S=n.getMeta(),p=_.getMeta();if(S.key===p.key||S.level!==p.level||S.parent!==p.parent)return;const c=p.parent,A=c.children.findIndex(y=>y.key===S.key),L=c.children.findIndex(y=>y.key===p.key),R=Math.min(A,L),G=Math.max(A,L),P=c.children.slice(R,G+1);e.interaction.clearState(),P.forEach(y=>{e.interaction.selectHeaderCell({cell:y.belongsCell,isMultiSelection:!0})})}}),e.once(j.LAYOUT_AFTER_HEADER_LAYOUT,r=>{var t;if(!e.store.get("initialized")){e.store.set("initialized",!0),e.changeSheetSize(r.colsHierarchy.width);const _=((t=e.dataCfg.data)==null?void 0:t.length)||0,S=r.colsHierarchy.height,p=e.options.style.cellCfg.height,c=S+p*_;l.offsetHeight>c&&(l.style.height=c+"px"),e.render(!1)}}),e.render()},J=s=>{const o=[],l=u=>{var k;if(((k=u.children)==null?void 0:k.length)>0){o.push(u.key);for(let f=0;f<u.children.length;f++)l(u.children[f])}};return s.forEach(u=>l(u)),o},pe=s=>{if(!(s!=null&&s.length))return 0;const o=u=>{if(!u.children||u.children.length===0)return 0;const k=u.children.map(f=>o(f));return Math.max(...k)+1},l=s.map(u=>o(u));return Math.max(...l)},me=we(s=>{if(e){const o=e.container.cfg.height;if(s>o){const l=document.getElementById(K.value);l.style.height=o+"px"}e.changeSheetSize(void 0,s),e.render(!1)}},500),E=[0,0];let H;Be(()=>{he(),H=new ResizeObserver(([s]=[])=>{const[o]=s.borderBoxSize||[];E[0]||E[1]||(E[0]=o.inlineSize,E[1]=o.blockSize),!(Math.abs(o.blockSize-E[1])<Fe)&&(E[0]=o.inlineSize,E[1]=o.blockSize,me(Math.round(o.blockSize)))}),H.observe(document.getElementById(K.value))}),ze(()=>{H==null||H.disconnect()});class ge extends Te{show(o){super.show(o),this.container.style.display="flex"}hide(){this.container&&(this.container.style.display="none")}}return(s,o)=>{const l=ye;return He(),Ae(Oe,null,[X("div",{id:K.value,class:Le(["table-container",{dark:F.themes==="dark"}])},null,10,Re),X("div",Ge,[oe(l,{effect:F.themes,onClick:de},{default:re(()=>[ie(ae(se(C)("chart.cancel")),1)]),_:1},8,["effect"]),oe(l,{type:"primary",onClick:fe},{default:re(()=>[ie(ae(se(C)("chart.confirm")),1)]),_:1})]),X("div",{id:v.value,class:"group-menu"},null,8,Pe)],64)}}});const kt=Ve(Ue,[["__scopeId","data-v-996aa40d"]]);export{kt as default};
