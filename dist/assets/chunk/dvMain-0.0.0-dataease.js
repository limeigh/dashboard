import{a1 as U}from"./vue-0.0.0-dataease.js";import{ag as W,a as P}from"./index-0.0.0-dataease.js";import{o as R,N as V,D as H}from"./ConfigGlobal.vue_vue_type_script_setup_true_lang-0.0.0-dataease.js";import{S as J,B as E,l as z,m as Y}from"./chart-0.0.0-dataease.js";import{c as B,f as G,C as A,a as M,d as I,D as j,b as X}from"./dataVisualization-0.0.0-dataease2.js";import{c as x}from"./index-0.0.0-dataease21.js";import{v as K,a as w,s as S}from"./lodash-0.0.0-dataease.js";import{u as Z}from"./appearance-0.0.0-dataease.js";import{C as $}from"./dataset-0.0.0-dataease.js";const Q=(e,t)=>{const a=t==="y_M_d_H"?e+":":e;if(new Date(a).toString()==="Invalid Date")return a;switch(t){case"year":case"y":return ee(a);case"month":case"y_M":return te(a);case"date":case"y_M_d":case"M_d":return ae(a);case"hour":case"y_M_d_H":return se(a);case"minute":case"y_M_d_H_m":return ie(a);case"y_M_d_H_m_s":return ne(a);case"datetime":return[+new Date(a),+new Date(a)];default:return a}},ee=e=>{const t=new Date(e);return[+new Date(t.getFullYear(),0,1),+new Date(t.getFullYear(),11,31)+60*1e3*60*24-1e3]},te=e=>{const t=new Date(e),a=new Date(t.getFullYear(),t.getMonth(),1);return a.setDate(1),a.setMonth(a.getMonth()+1),[+new Date(t.getFullYear(),t.getMonth(),1),+new Date(a.getTime()-1e3)]},ae=e=>{const t=oe(e);return[+t,+t+60*1e3*60*24-1e3]},se=e=>[+new Date(e),+new Date(e)+60*1e3*60-1e3],ie=e=>[+new Date(e),+new Date(e)+60*1e3-1e3],ne=e=>[+new Date(e),+new Date(e)+999],oe=e=>{if(e){const t=new Date(e);return new Date(t.getUTCFullYear(),t.getUTCMonth(),t.getUTCDate(),t.getUTCHours(),t.getUTCMinutes(),t.getUTCSeconds())}else return e};function le(e,t){var a,i,s,n;if(e&&t&&t.dimensionList){const o=e.fields?e.fields:(a=e.left)!=null&&a.fields||(i=e.right)!=null&&i.fields?K((s=e.left)==null?void 0:s.fields,(n=e.right)==null?void 0:n.fields):[],l=o.reduce((c,h)=>(c[h.id]=h.dataeaseName,c),{}),m=o.reduce((c,h)=>(c[h.dataeaseName]=h.deType,c),{}),u=o.reduce((c,h)=>(c[h.dataeaseName]=h.dateStyle,c),{});t.dimensionList.forEach(c=>{const h=l[c.id];m[h]===1&&(c.timeValue=Q(c.value,u[h]))})}}let F={};const re=async e=>{const t=e.queryId,a=e.displayId,i=await $({queryId:t,displayId:a,searchText:""});return i==null?void 0:i.reduce((s,n)=>(s[n[a]]=n[t],s),{})},_=(e,t)=>{const a=F[t];if(a){const i=[];return e.forEach(s=>{i.push(a[s]||s)}),i}else return e},ye=async e=>{F={};for(const t of e)if(t.component==="VQuery")for(const a of t.propValue){const{optionValueSource:i,field:s,displayId:n}=a;i===1&&s.id&&(F[s.id]=await re({queryId:s.id,displayId:n,searchText:""}))}},{t:L}=R(),ce=U("dataVisualization",{state:()=>({canvasAttachInfo:{},fullscreenFlag:!1,staticResourcePath:"/static-resource/",canvasCollapse:{defaultSide:!1,realTimeComponent:!1,canvas:!1,componentProp:!1,chartAreaCollapse:!1,datasetAreaCollapse:!1},canvasState:{curPointArea:"base"},embeddedCallBack:"no",editMode:"preview",mobileInPc:!1,inMobile:!1,firstLoadMap:[],canvasStyleData:{...V(B),backgroundColor:null},appData:null,componentDataCache:null,pcComponentData:[],mobileComponentData:[],isInEditor:!1,componentData:[],curComponent:null,curTabName:null,curComponentIndex:null,curCanvasScaleMap:{},previewCanvasScale:{scalePointWidth:1,scalePointHeight:1},isClickComponent:!1,dvInfo:{dataState:null,optType:null,id:null,name:null,pid:null,status:null,selfWatermarkStatus:null,watermarkInfo:{},type:null,mobileLayout:!1},canvasViewInfo:{},canvasViewDataInfo:{},canvasViewInstanceInfo:{},canvasViewOriginDataInfo:{},lastViewRequestInfo:{},bashMatrixInfo:{baseWidth:0,baseHeight:0,baseMarginLeft:0,baseMarginTop:0},curActiveTabInner:null,linkageSettingStatus:!1,curLinkageView:null,targetLinkageInfo:[],nowPanelTrackInfo:{},nowPanelJumpInfo:{},nowPanelJumpInfoTargetPanel:{},nowPanelOuterParamsInfoV2:{},nowPanelOuterParamsBaseInfoV2:{},dragComponentInfo:null,mobileLayoutStatus:!1,publicLinkStatus:!1,pcTabMatrixCount:{x:36,y:36},basePcScreenSize:{width:1920,height:1080},pcMatrixCount:{x:72,y:36},mobileMatrixCount:{x:6,y:12},mobileLayoutStyle:{x:300,y:600},scrollAutoMove:0,isCollapse:!1,panelViewEditInfo:{},panelViewDetailsInfo:{},batchOptComponentType:null,batchOptStatus:!1,hiddenListStatus:!1,lastHiddenComponent:[],curBatchOptComponents:[],curMultiplexingComponents:{},mixProperties:[],mixPropertiesInner:{},batchOptComponentInfo:null,batchOptComponents:{},changeProperties:{customStyle:{},customAttr:{}},allViewRender:[],tabCollisionActiveId:null,tabMoveInActiveId:null,tabMoveOutActiveId:null,tabMoveOutComponentId:null,tabActiveTabNameMap:{},mousePointShadowMap:{mouseX:0,mouseY:0,width:0,height:0},previewVisible:!1,previewComponentData:[],currentCanvasNewId:[],curOriginThemes:"light",baseCellInfo:{},dataPrepareState:!1,multiplexingStyleAdapt:!0,mainScrollTop:0,isIframe:!1,isPopWindow:!1,viewPageInfo:{}}),actions:{setLastHiddenComponent(e){e?this.lastHiddenComponent=[e]:this.lastHiddenComponent.length>0&&(this.lastHiddenComponent=[])},setIframeFlag(e){this.isIframe=e},setIsPopWindow(e){this.isPopWindow=e},setCanvasAttachInfo(e){this.canvasAttachInfo=e},setEmbeddedCallBack(e){this.embeddedCallBack=e},setPublicLinkStatus(e){this.publicLinkStatus=e},setFirstLoadMap(e){this.firstLoadMap=e},setDataPrepareState(e){this.dataPrepareState=e},setBaseCellInfo(e){this.baseCellInfo=e},aceSetCanvasData(e){this.canvasStyleData=e},setInMobile(e){this.inMobile=e},aceSetCurComponent(e){for(let t=0;t<this.componentData.length;t++)this.componentData[t].id===e.id&&this.componentData.splice(t,1);this.componentData.push(e),this.curComponent=e},setClickComponentStatus(e){this.isClickComponent=e},setEditMode(e){this.editMode=e},setMobileInPc(e){this.mobileInPc=e},setInEditorStatus(e){this.isInEditor=e},setCanvasStyle(e){e.component.seniorStyleSetting=e.component.seniorStyleSetting||V(J),this.canvasStyleData=e},setCanvasStyleScale(e){this.canvasStyleData.scale=e},setCanvasViewInfo(e){this.canvasViewInfo=e},getAppDataInfo(){return this.appData},setAppDataInfo(e){this.appData=e},setCurComponentMobileConfig(e){this.curComponent=e},setCurTabName(e){this.curTabName=e},setCurComponent({component:e,index:t}){var a,i;this.setCurTabName(null),this.setHiddenListStatus(!1),!e&&this.curComponent&&(this.curComponent.editing=!1,this.curComponent.resizing=!1,this.curComponent.dragging=!1,this.curComponent.canvasActive=!1,this.curComponent.canvasId!=="canvas-main"&&this.componentData.forEach(s=>{this.curComponent.canvasId.includes(s.id)&&(s.canvasActive=!1)})),this.curComponent||this.componentData.forEach(s=>{s.canvasActive=!1}),e&&(this.componentData.forEach(s=>{e.canvasId.includes(s.id)||(s.canvasActive=!1)}),this.curComponent?e.id!==this.curComponent.id&&(e.editing=!1):e.editing=!1),this.curComponent=e,this.curComponentIndex=t,this.curComponent&&this.curComponent.category&&(this.curComponent.component!=="Picture"||this.curComponent.component==="Picture"&&(!((a=this.curComponent.events)!=null&&a.checked)||((i=this.curComponent.events)==null?void 0:i.type)!=="displayChange"))&&(this.canvasState.curPointArea=this.curComponent.category),this.mobileInPc&&P().emitter.emit("curComponentChange",{type:"curComponentChange",value:this.curComponent?JSON.parse(JSON.stringify(this.curComponent)):null})},setBashMatrixInfo(e){this.bashMatrixInfo=e},setShapeStyle({top:e,left:t,width:a,height:i,rotate:s},n=[],o="move",l={}){if(this.curComponent.component==="GroupArea"&&n.length>0){const m=e-this.curComponent.style.top,u=t-this.curComponent.style.left,c=a-this.curComponent.style.width,h=i-this.curComponent.style.height;o==="move"?n.forEach(f=>{f.style.top=f.style.top+m,f.style.left=f.style.left+u,f.style.width=f.style.width+c,f.style.height=f.style.height+h}):n.forEach(f=>{const g=l[f.id];g&&(f.style.top=e+i*g.topRadio,f.style.left=t+a*g.leftRadio,f.style.width=a*g.widthRadio,f.style.height=i*g.heightRadio)})}this.dvInfo.type==="dashboard"?(e&&(this.curComponent.style.top=e<0?0:Math.round(e)),t&&(this.curComponent.style.left=t<0?0:Math.round(t)),a&&(this.curComponent.style.width=Math.round(a)),i&&(this.curComponent.style.height=Math.round(i)),s&&(this.curComponent.style.rotate=Math.round(s))):(e&&(this.curComponent.style.top=e),t&&(this.curComponent.style.left=t),a&&(this.curComponent.style.width=a),i&&(this.curComponent.style.height=i),s&&(this.curComponent.style.rotate=s))},setShapeSingleStyle({key:e,value:t}){this.curComponent.style[e]=t},setComponentData(e=[]){this.componentData=e},addCopyComponent(e,t,a=this.canvasViewInfo){e.canvasId==="canvas-main"?this.componentData.push(e):this.componentData.forEach(i=>{e.canvasId.includes(i.id)&&i.component=="DeTabs"&&i.propValue.forEach(s=>{e.canvasId.includes(s.name)&&s.componentData.push(e)})}),this.updateCopyCanvasView(t,a)},updateCopyCanvasView(e,t=this.canvasViewInfo){const a=this;e&&Object.keys(e).forEach(function(i){if(t[i]){const s=e[i],n={...V(t[i]),id:s,linkageActive:!1,jumpActive:!1};n.customAttrMobile=null,n.customStyleMobile=null,a.canvasViewInfo[s]=n}})},addComponent({component:e,index:t,isFromGroup:a=!1,componentData:i=this.componentData}){if(a){i.push(e);return}t!==void 0?(i.splice(t,0,e),this.setCurComponent({component:e,index:t})):(i.push(e),this.setCurComponent({component:e,index:i.length-1}));const s=Z().fontList.find(n=>n.isDefault);if(e.component==="UserView"){const n=JSON.parse(JSON.stringify(E));e.innerType==="bar-range"&&(n.customStyle.xAxis.axisLine.show=!1,n.customStyle.xAxis.splitLine.show=!0,n.customStyle.yAxis.axisLine.show=!0,n.customStyle.yAxis.splitLine.show=!1);let o={...n,id:e.id,type:e.innerType,render:e.render,isPlugin:e.isPlugin,plugin:{isPlugin:e.isPlugin,staticMap:e.staticMap}};const l=x.getChartView(o.render,o.type);l&&(o=l.setupDefaultOptions(o),o.title=e.name),s&&(o.customStyle.text.fontFamily=s.name),this.canvasViewInfo[e.id]=o}if(e.component==="VQuery"){const{color:n,titleColor:o,labelColor:l,borderColor:m,bgColor:u,text:c,titleLayout:h,layout:f}=this.canvasStyleData.component.filterStyle||{},g={...JSON.parse(JSON.stringify(E)),id:e.id,title:L("visualization.query_component"),type:e.innerType,customStyle:{component:{show:!0,color:n,titleShow:!1,text:c,textColorShow:!1,labelColor:l,borderColor:m,title:"",borderWidth:1,bgColor:u,titleColor:o,titleLayout:h,layout:f,btnList:["sure"],fontSize:"14",labelShow:!0,fontWeight:"",fontStyle:"",fontSizeBtn:"14",fontWeightBtn:"",fontStyleBtn:"",queryConditionWidth:227,nameboxSpacing:8,placeholderShow:!0,placeholderSize:14,queryConditionSpacing:16,queryConditionHeight:32,labelColorBtn:"#ffffff",btnColor:"#3370ff"}}};this.canvasViewInfo[e.id]=g}},setLinkageTargetInfo(e){this.linkageSettingStatus=!0,this.curLinkageView=this.curComponent,this.targetLinkageInfo=e},setFullscreenFlag(e){this.fullscreenFlag=e},removeViewFilter(e){this.componentData=this.componentData.map(t=>{const a=t;return a.filters=a.filters&&a.filters.filter(i=>i.componentId!==e)||[],a})},deleteComponentById(e,t=this.componentData,a=!1){if(e){const i=[];t.forEach((s,n)=>{e===s.id?i.push(n):a&&s.component==="Group"?this.deleteComponentById(e,s.propValue||[]):a&&s.innerType==="DeTabs"&&s.propValue.forEach(o=>{this.deleteComponentById(e,o.componentData||[])})}),i.forEach(s=>{this.deleteComponent(s,t)})}},deleteComponent(e,t=this.componentData){e===void 0&&(e=this.curComponentIndex),/\d/.test(e)&&(this.curComponentIndex=null,t.splice(e,1))},updateCurDvInfo(e){this.dvInfo=e,this.curOriginThemes=e.type==="dashboard"?"light":"dark"},matrixSizeAdaptor(){const{baseWidth:e,baseHeight:t,baseMarginLeft:a,baseMarginTop:i}=this.bashMatrixInfo;this.componentData.forEach(function(s){s.style.width=e*s.sizeX-a,s.style.height=t*s.sizeY-i,s.style.left=e*(s.x-1)+a,s.style.top=t*(s.y-1)+i})},clearTargetViewLinkage(e,t){if(t.linkageFilters&&t.linkageFilters.length>0){const a=t.linkageFilters.length,i=t.linkageFilters.filter(s=>s.sourceViewId!==e);t.linkageFilters.splice(0,t.linkageFilters.length),i.length>0&&i.forEach(s=>{t.linkageFilters.push(s)}),a!==i.length&&P().emitter.emit("query-data-"+t.id)}},clearViewLinkage(e){this.componentData.forEach(t=>{t.component==="UserView"&&t.innerType!="VQuery"?this.clearTargetViewLinkage(e,t):t.component==="Group"?t.propValue.forEach(a=>{this.clearTargetViewLinkage(e,a)}):t.component==="DeTabs"&&t.propValue.forEach(a=>{var i;(i=a.componentData)==null||i.forEach(s=>{this.clearTargetViewLinkage(e,s)})})})},addCurBatchComponent(e){var i;const t=e.id,a=e.component;if(this.curBatchOptComponents.push(t),a==="UserView"){const s=this.canvasViewInfo[t],n=x.getChartView(s.render,s.type);n&&(this.curBatchOptComponents.length===1&&(this.changeProperties.customAttr=s.customAttr,this.changeProperties.customStyle=s.customStyle,this.changeProperties.customAttr.indicator=this.changeProperties.customAttr.indicator||V(z),this.changeProperties.customAttr.indicatorName=this.changeProperties.customAttr.indicatorName||V(Y)),this.batchOptComponents[t]={properties:n.properties,propertyInner:n.propertyInner,value:n.name,componentType:a},this.setBatchOptComponentInfo())}else this.batchOptComponents[t]=G(a),this.setBatchOptComponentInfo();this.batchOptComponentType!=="UserView"&&(this.batchOptComponentInfo={collapseName:"background",commonBackground:V(this.curOriginThemes==="light"?A:M),style:{}},(i=this.mixPropertiesInner["common-style"])==null||i.forEach(s=>{this.batchOptComponentInfo.style[s]=I[s]}))},setBatchOptComponentInfo(){var e;if(this.batchOptComponents&&JSON.stringify(this.batchOptComponents)!=="{}"){const t={render:null,type:null};this.mixPropertiesAdaptor(t),this.batchOptComponentType==="UserView"?this.batchOptComponentInfo={...V(E),mode:"batchOpt",render:t.render,type:t.type,commonBackground:V(this.curOriginThemes==="light"?A:M),customAttr:this.changeProperties.customAttr,customStyle:this.changeProperties.customStyle}:(this.batchOptComponentInfo={collapseName:"background",commonBackground:V(this.curOriginThemes==="light"?A:M),style:{}},(e=this.mixPropertiesInner["common-style"])==null||e.forEach(a=>{this.batchOptComponentInfo.style[a]=I[a]}))}else this.batchOptComponentInfo=null},mixPropertiesAdaptor(e){this.mixProperties=[],this.mixPropertiesInner={};let t=[],a={},i=null;for(const s in this.batchOptComponents){const n=this.batchOptComponents[s];i?i=i===n.componentType?n.componentType:"mix":i=n.componentType,t.length>0?(t=t.filter(o=>n.properties.indexOf(o)>-1),t.forEach(o=>{a[o]&&n.propertyInner[o]&&(a[o]=a[o].filter(l=>n.propertyInner[o].indexOf(l)>-1))})):(t=V(n.properties),a=V(n.propertyInner)),e.type=e.type===null||e.type===n.value?n.value:"mix"}t.forEach(s=>{a[s]&&(this.mixPropertiesInner[s]=a[s],this.mixProperties.push(s))}),this.batchOptComponentType=i},setChangeProperties(e){if(this.batchOptComponentType==="UserView"){if(e.subProp){const t=w(e.value,e.subProp),a=this.changeProperties[e.custom][e.property];S(a,e.subProp,t)}else this.changeProperties[e.custom][e.property]=e.value;this.curBatchOptComponents.forEach(t=>{const a=this.canvasViewInfo[t];if(a.type.includes("chart-mix")&&e.property==="basicStyle"&&e.subProp){const i=w(e.value,e.subProp),s=a[e.custom][e.property];switch(S(s,e.subProp,i),e.subProp){case"alpha":const n=w(e.value,"subAlpha");S(s,"subAlpha",n);break;case"colorScheme":const o=w(e.value,"subColorScheme");S(s,"subColorScheme",o);break;case"seriesColor":const l=w(e.value,"subSeriesColor");S(s,"subSeriesColor",l);break;case"colors":const m=w(e.value,"subColors");S(s,"subColors",m);break;case"lineWidth":const u=w(e.value,"leftLineWidth");S(s,"leftLineWidth",u);break;case"lineSymbol":const c=w(e.value,"leftLineSymbol");S(s,"leftLineSymbol",c);break;case"lineSymbolSize":const h=w(e.value,"leftLineSymbolSize");S(s,"leftLineSymbolSize",h);break;case"lineSmooth":const f=w(e.value,"leftLineSmooth");S(s,"leftLineSmooth",f);break}}else if(e.subProp){const i=w(e.value,e.subProp),s=a[e.custom][e.property];S(s,e.subProp,i)}else a[e.custom][e.property]=e.value;["tablePageMode","tablePageSize"].includes(e.subProp)?P().emitter.emit("calcData-"+t,a):setTimeout(()=>{P().emitter.emit("renderChart-"+t,a)},0)})}else this.componentData.forEach(t=>{this.curBatchOptComponents.includes(t.id)&&(e.custom==="commonBackground"?t.commonBackground=V(this.batchOptComponentInfo.commonBackground):e.custom==="style"&&t.style[e.property]&&(t.style[e.property]=e.value)),t.component==="Group"?t.propValue.forEach(a=>{this.curBatchOptComponents.includes(a.id)&&(e.custom==="commonBackground"?a.commonBackground=V(this.batchOptComponentInfo.commonBackground):e.custom==="style"&&a.style[e.property]&&(a.style[e.property]=e.value))}):t.component==="DeTabs"&&t.propValue.forEach(a=>{var i;(i=a.componentData)==null||i.forEach(s=>{this.curBatchOptComponents.includes(s.id)&&(e.custom==="commonBackground"?s.commonBackground=V(this.batchOptComponentInfo.commonBackground):e.custom==="style"&&s.style[e.property]&&(s.style[e.property]=e.value))})})})},setBatchChangeBackground(e){this.componentData.forEach(t=>{t.component==="UserView"?this.curBatchOptComponents.includes(t.id)&&(t.commonBackground=V(e)):t.component==="Group"?t.propValue.forEach(a=>{this.curBatchOptComponents.includes(a.id)&&(a.commonBackground=V(e))}):t.component==="DeTabs"&&t.propValue.forEach(a=>{var i;(i=a.componentData)==null||i.forEach(s=>{this.curBatchOptComponents.includes(s.id)&&(s.commonBackground=V(e))})})})},setBatchOptStatus(e){this.batchOptStatus=e,this.curBatchOptComponents=[],this.mixProperties=[],this.mixPropertiesInner={},this.batchOptComponentType=null,this.batchOptComponentInfo=null,this.batchOptComponents={},this.componentViewsData={},this.changeProperties={customStyle:{},customAttr:{}}},setHiddenListStatus(e){e!=null?this.hiddenListStatus=!!e:this.hiddenListStatus=!this.hiddenListStatus,this.dvInfo.type==="dashboard"&&this.setBatchOptStatus(!1)},removeCurBatchComponentWithId(e){for(let t=0;t<this.curBatchOptComponents.length;t++)if(this.curBatchOptComponents[t]===e){delete this.batchOptComponents[e],this.curBatchOptComponents.splice(t,1);break}if(this.curBatchOptComponents.length===1&&this.canvasViewInfo&&this.canvasViewInfo[this.curBatchOptComponents[0]]){const t=this.curBatchOptComponents[0],a=this.canvasViewInfo[t];this.changeProperties.customAttr=a.customAttr,this.changeProperties.customStyle=a.customStyle}this.curBatchOptComponents.length===0&&(this.changeProperties={customStyle:{},customAttr:{}}),this.setBatchOptComponentInfo()},removeCurMultiplexingComponentWithId(e){delete this.curMultiplexingComponents[e]},addCurMultiplexingComponent(e){e.componentId&&(this.curMultiplexingComponents[e.componentId]=e.component)},initCurMultiplexingComponents(){this.curMultiplexingComponents={}},addCanvasViewInfo(e,t){this.canvasViewInfo[e]=t},removeCanvasViewInfo(e){delete this.canvasViewInfo[e]},clearLinkageSettingInfo(){this.linkageSettingStatus=!1,this.curLinkageView=null,this.targetLinkageInfo=[]},setNowPanelTrackInfo(e){this.nowPanelTrackInfo=e},setNowPanelJumpInfo(e){this.nowPanelJumpInfo=e.baseJumpInfoMap},setNowPanelJumpInfoInner(e){this.nowPanelJumpInfo=e},setNowTargetPanelJumpInfo(e){this.nowPanelJumpInfoTargetPanel=e.baseJumpInfoVisualizationMap},setNowPanelOuterParamsInfoV2(e,t=this.dvInfo.id){this.nowPanelOuterParamsInfoV2[t]=e.outerParamsInfoMap,this.nowPanelOuterParamsBaseInfoV2[t]=e.outerParamsInfoBaseMap},addViewTrackFilter(e){var o,l;const t=e.viewId;let a;e.option==="linkage"?(le(this.canvasViewDataInfo[t],e),a=this.nowPanelTrackInfo):a=this.nowPanelJumpInfoTargetPanel;const i=[],s=[...e.dimensionList,...e.quotaList],n=e.customFilter;for(let m=0;m<this.componentData.length;m++){const u=this.componentData[m];u.id!==t&&(["UserView","VQuery"].includes(u.component)?(this.trackFilterCursor(u,s,a,i,t,n),this.componentData[m]=u):u.component==="Group"?(o=u.propValue)==null||o.forEach((c,h)=>{this.trackFilterCursor(c,s,a,i,t,n),u.propValue[h]=c}):u.component==="DeTabs"&&((l=u.propValue)==null||l.forEach(c=>{var h;(h=c.componentData)==null||h.forEach((f,g)=>{this.trackFilterCursor(f,s,a,i,t,n),c.componentData[g]=f})})))}i.forEach(m=>{P().emitter.emit("query-data-"+m)})},addWebParamsFilter(e,t=this.componentData){var a,i;if(e)for(let s=0;s<t.length;s++){const n=t[s];["UserView"].includes(n.component)?(this.trackWebFilterCursor(n,e),this.componentData[s]=n):n.component==="Group"?(a=n.propValue)==null||a.forEach((o,l)=>{this.trackWebFilterCursor(o,e),n.propValue[l]=o}):n.component==="DeTabs"&&((i=n.propValue)==null||i.forEach(o=>{var l;(l=o.componentData)==null||l.forEach((m,u)=>{this.trackWebFilterCursor(m,e),o.componentData[u]=m})}))}},addOuterParamsFilter(e,t=this.componentData,a="inner",i=this.dvInfo.id){var o,l;const s={},n=e&&e.outerParamsVersion||"v1";if(this.nowPanelOuterParamsBaseInfoV2[i]){let m=0,u="";if(Object.keys(this.nowPanelOuterParamsBaseInfoV2[i]).forEach(c=>{const h=this.nowPanelOuterParamsBaseInfoV2[i][c],f=e?e[c]:null,g=!f||f.length===0;h.required&&g?(m++,u=u+"["+c+"]"):g&&h.enabledDefault&&h.defaultValue&&h.defaultValue.length>0?s[c]=JSON.parse(h.defaultValue):g||(s[c]=e[c])}),m>0)throw H.error("参数"+u+"不能为空"),new Error("参数"+u+"不能为空")}else return;if(s){const m=[],u=this.nowPanelOuterParamsInfoV2[i];for(let c=0;c<t.length;c++){const h=t[c];["UserView","VQuery"].includes(h.component)?(this.trackOuterFilterCursor(h,s,m,u,a,n),this.componentData[c]=h):h.component==="Group"?(o=h.propValue)==null||o.forEach((f,g)=>{this.trackOuterFilterCursor(f,s,m,u,a,n),h.propValue[g]=f}):h.component==="DeTabs"&&((l=h.propValue)==null||l.forEach(f=>{var g;(g=f.componentData)==null||g.forEach((b,p)=>{this.trackOuterFilterCursor(b,s,m,u,a,n),f.componentData[p]=b})}))}}},trackWebFilterCursor(e,t){t[e.id]&&(e.webParamsFilters=t[e.id],P().emitter.emit("query-data-"+e.id))},trackOuterFilterCursor(e,t,a,i,s,n="v1"){if(!["UserView","VQuery"].includes(e.component)||e.category==="hidden"&&!this.canvasStyleData.popupAvailable)return;const o=[];Object.keys(t).forEach(function(l){let m,u,c,h;n==="v2"?(m=t[l].operator,u=t[l].value,c=t[l].value,h=t[l].value):(u=t[l],c=t[l],h=t[l]);let f="in";u&&!Array.isArray(u)?(u=[u],f="eq"):u&&Array.isArray(u)&&(u.length===1&&(f="eq"),c="",u.forEach((b,p)=>{p===0?c=b:c=c+","+b})),(i[l]||[]).forEach(b=>{var v,O;const p=b.split("#"),C=p[0];if(e.component==="UserView"&&e.id===C){if(c!=="DE_EMPTY"){const T=p[1],r={fieldId:T,operator:m||f,value:u,viewIds:[C]};let d=o.length;for(;d--;){const y=o[d];T===y.fieldId&&y.viewIds.includes(C)&&o.splice(d,1)}o.push(r)}a.push(e.id)}if(e.component==="VQuery"){const T={};(v=e.propValue)==null||v.forEach(r=>{if(r.id===C){let d=u;if(["1","7"].includes(r.displayType)||(d=u.map(y=>String(y))),r.defaultMapValue=[],r.mapValue=[],r.defaultValueCheck=!0,r.timeType="fixed",["0","2"].includes(r.displayType)){const{optionValueSource:y,field:k,displayId:N}=r,q=y===1&&k.id!==N;let D=d;q&&(D=_(d,k.id)),r.multiple?(r.selectValue=d,r.defaultValue=d):(r.selectValue=d[0],r.defaultValue=d[0]),r.defaultMapValue=D,r.mapValue=D}else r.displayType==="1"?(r.selectValue=d[0],r.defaultValue=d[0]):r.displayType==="7"?(r.selectValue=d,r.defaultValue=d):r.displayType==="8"?(r.conditionValueF=h+"",r.defaultConditionValueF=h+""):r.displayType==="9"?r.multiple?(r.selectValue=d,r.defaultValue=d):(r.selectValue=d[0],r.defaultValue=d[0]):r.displayType==="22"&&(r.defaultNumValueStart=d[0],r.defaultNumValueEnd=d[1],r.numValueStart=d[0],r.numValueEnd=d[1]);c==="DE_EMPTY"&&(r.selectValue=null,r.defaultValue=null,r.conditionValueF=null,r.defaultConditionValueF=null),r.defaultValue&&(T[r.id]=r.defaultValue)}}),(O=e.cascade)!=null&&O.length&&Object.keys(T).length&&e.cascade.forEach(r=>{Object.keys(T).forEach(d=>{const y=T[d];r.length&&r.forEach(k=>{k.datasetId.includes(d)&&y?(k.currentSelectValue=Array.isArray(y)?y:[y],k.selectValue=Array.isArray(y)?y:[y]):(k.currentSelectValue=[],k.selectValue=[])})})})}})}),e.component==="UserView"&&(e.outerParamsFilters=o),s==="outer"&&a.forEach(l=>{P().emitter.emit("query-data-"+l)})},trackFilterCursor(e,t,a,i,s,n){let o=e.linkageFilters||[];if(["table-info","table-normal"].includes(e.innerType)&&(o=[]),o.length)for(let l=o.length-1;l>=0;l--)o[l].filterType===3&&o.splice(l,1);t.forEach(l=>{const m=s+"#"+l.id,u=a[m]||[],c=[l.value];u.forEach(h=>{var b;const f=h.split("#"),g=f[0];if(e.component==="UserView"&&e.id===g){if(n)o.push({filterType:3,customFilter:n});else{const p=f[1];let C;l.timeValue&&Array.isArray(l.timeValue)?C={fieldId:p,operator:"between",value:l.timeValue,viewIds:[g],sourceViewId:s}:l.value!==null&&l.value!==""&&(C={fieldId:p,operator:"eq",value:[l.value],viewIds:[g],sourceViewId:s});let v=o.length;for(;v--;){const O=o[v];p===O.fieldId&&O.viewIds.includes(g)&&o.splice(v,1)}o.push(C)}i.includes(e.id)||i.push(e.id)}e.component==="VQuery"&&Array.isArray(e.propValue)&&((b=e.propValue)==null||b.forEach(p=>{if(p.id===g){let C=c;if(["1","7"].includes(p.displayType)||(C=c.map(v=>String(v))),p.defaultValueCheck=!0,p.timeType="fixed",["0","2"].includes(p.displayType)){const{optionValueSource:v,field:O,displayId:T}=p,r=v===1&&O.id!==T;let d=C;r&&(d=_(C,O.id)),p.multiple?(p.selectValue=C,p.defaultValue=C):(p.selectValue=C[0],p.defaultValue=C[0]),p.defaultMapValue=d,p.mapValue=d}else p.displayType==="1"?(p.selectValue=C[0],p.defaultValue=C[0]):p.displayType==="7"?l.timeValue&&Array.isArray(l.timeValue)?(p.selectValue=l.timeValue,p.defaultValue=l.timeValue):(p.selectValue=C,p.defaultValue=C):p.displayType==="8"&&(p.conditionValueF=C[0],p.defaultConditionValueF=C[0])}}))})}),e.linkageFilters=o},clearPanelLinkageInfo(){this.componentData.forEach(e=>{e.component==="UserView"?e.linkageFilters&&e.linkageFilters.length>0&&(e.linkageFilters.splice(0,e.linkageFilters.length),P().emitter.emit("query-data-"+e.id)):e.component==="Group"?e.propValue.forEach(t=>{t.linkageFilters&&t.linkageFilters.length>0&&(t.linkageFilters.splice(0,t.linkageFilters.length),P().emitter.emit("query-data-"+t.id))}):e.component==="DeTabs"&&e.propValue.forEach(t=>{var a;(a=t.componentData)==null||a.forEach(i=>{i.linkageFilters&&i.linkageFilters.length>0&&(i.linkageFilters.splice(0,i.linkageFilters.length),P().emitter.emit("query-data-"+i.id))})})})},setTabCollisionActiveId(e){this.tabCollisionActiveId=e},setTabMoveInActiveId(e){this.tabMoveInActiveId=e},setMousePointShadowMap(e){this.mousePointShadowMap.mouseX=e.mouseX,this.mousePointShadowMap.mouseY=e.mouseY,this.mousePointShadowMap.width=e.width,this.mousePointShadowMap.height=e.height},setTabMoveOutComponentId(e){this.tabMoveOutComponentId=e},resetDvInfo(){this.dvInfo={dataState:null,optType:null,id:null,name:null,pid:null,status:null,selfWatermarkStatus:null,watermarkInfo:{},type:null,mobileLayout:!1,contentId:0},this.mainScrollTop=0},setViewDataDetails(e,t){this.canvasViewDataInfo[e]=t.data;const a=this.canvasViewInfo[e];if(a){const i=a.calParams?a.calParams.reduce((s,n)=>(s[n.id]=n.value,s),{}):{};t.calParams&&t.calParams.forEach(s=>{i[s.id]&&(s.value=i[s.id])}),this.canvasViewInfo[e].calParams=t.calParams||null}},getViewDataDetails(e){return this.canvasViewDataInfo[e]},setViewOriginData(e,t){this.canvasViewOriginDataInfo[e]=t},getViewOriginData(e){return this.canvasViewOriginDataInfo[e]},setViewInstanceInfo(e,t){this.canvasViewInstanceInfo[e]=t},getViewInstanceInfo(e){return this.canvasViewInstanceInfo[e]},setLastViewRequestInfo(e,t){this.lastViewRequestInfo[e]=t},getLastViewRequestInfo(e){return this.lastViewRequestInfo[e]},getViewDetails(e){return this.canvasViewInfo[e]},updateDvInfoCall(e=1,t,a){this.dvInfo&&(this.dvInfo.dataState="ready",this.dvInfo.optType=null,t&&(this.dvInfo.id=t),a&&(this.dvInfo.contentId=a),this.dvInfo.status=e)},popAreaActiveSwitch(){this.canvasState.curPointArea==="base"?this.canvasState.curPointArea="hidden":this.canvasState.curPointArea="base"},canvasStateChange({key:e,value:t}){this.canvasState[e]&&t&&(this.canvasState[e]=t)},createInit(e,t,a,i,s){const n=L(e==="dashboard"?"visualization.new_dashboard":"visualization.new_screen"),o=s||n;this.hiddenListStatus=!1,this.dvInfo={dataState:"prepare",optType:null,id:t,name:o,pid:a,type:e,status:0,selfWatermarkStatus:!0,watermarkInfo:i,mobileLayout:!1,contentId:"0",weight:9};const l=e==="dashboard"?j:X;this.canvasStyleData=V(l),this.componentData=[],this.canvasViewInfo={}},removeLinkageInfo(e){e&&this.nowPanelTrackInfo&&(Object.keys(this.nowPanelTrackInfo).forEach(t=>{const a=this.nowPanelTrackInfo[t];for(let i=0;i<a.length;i++)a[i].indexOf(e)>-1&&(a.splice(i,1),i--)}),Object.keys(this.nowPanelTrackInfo).forEach(t=>{(t.indexOf(e)>-1||this.nowPanelTrackInfo[t].length===0)&&delete this.nowPanelTrackInfo[t]}))},canvasDataInit(){this.canvasViewInfo={},this.componentData=[],this.dvInfo={dataState:null,optType:null,id:null,name:null,pid:null,status:null,selfWatermarkStatus:null,watermarkInfo:{},type:null,mobileLayout:!1,contentId:"0"},this.canvasStyleData={...V(B),backgroundColor:null}},removeGroupArea(e=this.componentData){const t=e==null?void 0:e.filter(a=>(a==null?void 0:a.component)==="GroupArea");t&&t.length>0&&t.forEach(a=>{this.deleteComponentById(a.id,e)})},setViewPageInfo(e,t){this.canvasViewInfo[e]&&(this.canvasViewInfo[e].pageInfo=t)},getViewPageInfo(e){var t;return(t=this.canvasViewInfo[e])==null?void 0:t.pageInfo}}}),we=()=>ce(W);export{we as d,ye as f,le as v};
