import{s as C,d as I}from"./pinia-0.0.0-dataease.js";import{a as f,l as t,o as u,u as p,g as m}from"./index-0.0.0-dataease.js";import{d as v}from"./dvMain-0.0.0-dataease.js";import{B as w}from"./dataVisualization-0.0.0-dataease2.js";import{e as S}from"./eventBus-0.0.0-dataease.js";const{wsCache:V}=f("localStorage"),s=v(),{dvInfo:n,curComponent:h,componentData:T,canvasStyleData:D,canvasViewInfo:g,curOriginThemes:y,dataPrepareState:l,nowPanelTrackInfo:x,nowPanelJumpInfo:P,mobileInPc:r}=C(s);let b={componentData:[],canvasStyleData:t(w[y.value]),canvasViewInfo:{},cacheViewIdInfo:{snapshotCacheViewCalc:[],snapshotCacheViewRender:[]}};const R=I("snapshot",{state:()=>({snapshotDisableTime:1,styleChangeTimes:-1,cacheStyleChangeTimes:0,snapshotCacheTimes:0,cacheViewIdInfo:{snapshotCacheViewCalc:[],snapshotCacheViewRender:[]},snapshotData:[],snapshotIndex:-1}),actions:{initSnapShot(){this.styleChangeTimes=-1,this.cacheStyleChangeTimes=0,this.snapshotCacheTimes=0,this.cacheViewIdInfo={snapshotCacheViewCalc:[],snapshotCacheViewRender:[]},this.snapshotData=[],this.snapshotIndex=-1},snapshotCatchToStore(){this.snapshotCacheTimes&&this.recordSnapshot("snapshotCatchToStore")},recordSnapshotCacheToMobile(e,a=h.value,o=null){r.value&&a&&p().emitter.emit("onMobileStatusChange",{type:"componentStyleChange",value:{type:e,component:JSON.parse(JSON.stringify(a)),otherComponent:o}}),this.recordSnapshotCache(e)},recordSnapshotCacheWithPositionChange(e,a="all"){s.setLastHiddenComponent(),this.recordSnapshotCache(e,a)},recordSnapshotCache(e,a="all"){l.value&&(e==="calcData"?this.cacheViewIdInfo.snapshotCacheViewCalc.push(a):e==="renderChart"&&this.cacheViewIdInfo.snapshotCacheViewRender.push(a),this.snapshotCacheTimes++)},undo(){if(this.snapshotIndex>0){this.snapshotIndex--;const e=t(this.snapshotData[this.snapshotIndex])||E();e.dvInfo.id=n.value.id,e.dvInfo.pid=n.value.pid,e.dvInfo.dataState=n.value.dataState,e.dvInfo.contentId=n.value.contentId,this.snapshotPublish(e),this.styleChangeTimes++,this.snapshotDisableTime=Date.now()+3e3}},redo(){if(this.snapshotIndex<this.snapshotData.length-1){this.snapshotIndex++;const e=t(this.snapshotData[this.snapshotIndex]);e.dvInfo.id=n.value.id,e.dvInfo.pid=n.value.pid,e.dvInfo.dataState=n.value.dataState,e.dvInfo.contentId=n.value.contentId,this.snapshotPublish(e),this.styleChangeTimes++,this.snapshotDisableTime=Date.now()+3e3}},snapshotPublish(e){s.updateCurDvInfo(e.dvInfo),s.setComponentData(e.componentData),s.setCanvasStyle(e.canvasStyleData),s.setCanvasViewInfo(e.canvasViewInfo),s.setNowPanelJumpInfoInner(e.nowPanelJumpInfo),s.setNowPanelTrackInfo(e.nowPanelTrackInfo);const a=t(this.cacheViewIdInfo);if(this.cacheViewIdInfo=e.cacheViewIdInfo,h.value){let i=!1;e.componentData.forEach((c,d)=>{h.value.id===c.id&&(i=!0,s.setCurComponent({component:c,index:d}))}),(!i||h.value.innerType&&h.value.innerType==="rich-text")&&s.setCurComponent({component:null,index:null})}const o={snapshotCacheViewCalc:[...a.snapshotCacheViewCalc,...this.cacheViewIdInfo.snapshotCacheViewCalc],snapshotCacheViewRender:[...a.snapshotCacheViewRender,...this.cacheViewIdInfo.snapshotCacheViewRender],canvasViewInfo:e.canvasViewInfo};S.emit("snapshotChange"),(o.snapshotCacheViewCalc.length>0||o.snapshotCacheViewRender.length>0)&&p().emitter.emit("snapshotChangeToView",o)},resetStyleChangeTimes(){this.styleChangeTimes=0,this.snapshotCacheTimes=0},resetSnapshot(){this.styleChangeTimes=-1,this.cacheStyleChangeTimes=0,this.snapshotCacheTimes=0,this.cacheViewIdInfo={snapshotCacheViewCalc:[],snapshotCacheViewRender:[]},this.snapshotData=[],this.snapshotIndex=-1,this.recordSnapshot()},recordSnapshot(){if(l.value&&!r.value&&Date.now()>this.snapshotDisableTime){this.styleChangeTimes=++this.styleChangeTimes;const e=t(T.value);s.removeGroupArea(e);const a={componentData:e,canvasStyleData:t(D.value),canvasViewInfo:t(g.value),cacheViewIdInfo:t(this.cacheViewIdInfo),nowPanelTrackInfo:t(x.value),nowPanelJumpInfo:t(P.value),dvInfo:t(n.value)};this.snapshotData[++this.snapshotIndex]=a,this.snapshotIndex<this.snapshotData.length-1&&(this.snapshotData=this.snapshotData.slice(0,this.snapshotIndex+1)),this.snapshotCacheTimes=0,this.snapshotData.length>1&&V.set(m("DE-DV-CATCH-"+n.value.id),a)}}}});function E(){return b}const A=()=>R(u);export{A as s};
