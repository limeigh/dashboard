import{l as Z,j as J,C as R,a as I,M as ee,k as ae,A as te,m as re}from"./dataVisualization-0.0.0-dataease2.js";import{e as P}from"./eventBus-0.0.0-dataease.js";import{d as ie}from"./dvMain-0.0.0-dataease.js";import{g as W,h as se,i as oe,j as ne,k as B,l as le,m as ue,n as de}from"./dataVisualization-0.0.0-dataease.js";import{s as fe}from"./pinia-0.0.0-dataease.js";import{k as b,h as ce}from"./ConfigGlobal.vue_vue_type_script_setup_true_lang-0.0.0-dataease.js";import{n as pe,S as M}from"./chart-0.0.0-dataease.js";import{s as he}from"./snapshot-0.0.0-dataease.js";import{a as ge,l as D,g as L,x as ye}from"./index-0.0.0-dataease.js";import{q as be,E as ve}from"./element-plus-secondary-0.0.0-dataease.js";import{g as F}from"./util-0.0.0-dataease.js";import{useAppearanceStoreWithOut as De}from"./appearance-0.0.0-dataease.js";import{i as Te}from"./ModelUtil-0.0.0-dataease.js";import{h as S}from"./lodash-es-0.0.0-dataease.js";const Ye=e=>b.post({url:"/linkage/getViewLinkageGatherArray",data:e}),qe=e=>b.post({url:"/linkage/saveLinkage",data:e}),H=(e,a="snapshot")=>b.get({url:"/linkage/getVisualizationAllLinkageInfo/"+e+"/"+a}),Xe=e=>b.post({url:"/linkage/updateLinkageActive",data:e}),je=e=>b.post({url:"/linkage/removeLinkage",data:e});function Ke(e,a){return b.get({url:"/linkJump/queryWithViewId/"+e+"/"+a})}function Qe(e){return b.post({url:"/linkJump/updateJumpSet",data:e,loading:!0})}function $e(e){return b.post({url:"/linkJump/queryTargetVisualizationJumpInfo",data:e,loading:!0})}function U(e,a="snapshot"){return b.get({url:"/linkJump/queryVisualizationJumpInfo/"+e+"/"+a,loading:!1})}function Ze(e){return b.get({url:"/linkJump/viewTableDetailList/"+e,loading:!1})}function Re(e){return b.post({url:"/linkJump/updateJumpSetActive",data:e,loading:!0})}function Ie(e){return b.post({url:"/linkJump/removeJumpSet",data:e,loading:!0})}const f=ie(),{inMobile:ke,dvInfo:y,canvasStyleData:Y,componentData:p,canvasViewInfo:T,appData:G}=fe(f),Ee=he(),{t:V}=ce(),Ce=De(),{wsCache:q}=ge();function ea(e){const a=e.split("&"),t=a[0],r=a[1];return we(t,r)}function we(e,a,t){let r;if(Z.forEach(i=>{(i.component===e||i.component===a)&&(r=S(i),["DeTabs","DeScreen"].includes(r.component)&&(r.propValue[0].name=F(),r.titleBackground=D(J)),r.innerType=a,r.innerType==="richText"&&(r.propValue={textValue:""}),f.curOriginThemes==="light"?r.commonBackground=S(R):r.commonBackground=S(I))}),e==="UserView"){const i=pe(a);r.name=i==null?void 0:i.title,r.label=i==null?void 0:i.title,r.render=i==null?void 0:i.render,r.isPlugin=!!t,r.isPlugin&&(r.staticMap=t)}else["DeDecoration","DynamicBackground"].includes(e)&&(r.style.borderWidth=0,r.style.innerPadding=0);return r}function aa(e,a){const t=e.target.dataset.id;a==="dashboard"?P.emit("handleDragStartMoveIn-canvas-main",t):e.dataTransfer.setData("id",t)}function ta(e,a){a==="dashboard"&&P.emit("handleDragEnd-canvas-main",e)}function A(e){var a,t;e.x=1+(e.x-1)*2,e.y=1+(e.y-1)*2,e.sizeX=e.sizeX*2,e.sizeY=e.sizeY*2,e.mx=1+(e.mx-1)*2,e.my=1+(e.my-1)*2,e.mSizeX=e.mSizeX*2,e.mSizeY=e.mSizeY*2,e.component==="Group"?(a=e.propValue)==null||a.forEach(r=>{A(r)}):e.component==="DeTabs"&&((t=e.propValue)==null||t.forEach(r=>{var i;(i=r.componentData)==null||i.forEach(n=>{A(n)})}))}function N(e,a,t,r,i){var n,u,s,l;e.canvasActive=!1,e.component==="VQuery"&&(e.freeze=e.freeze||!1),e.component==="VQuery"&&(t==null?void 0:t.source)==="report"&&a&&((n=e.propValue)!=null&&n.forEach)&&((u=e.propValue)==null||u.forEach((o,d)=>{a[o.id]&&(e.propValue[d]=JSON.parse(a[o.id].filterInfo))})),e.component==="DeTabs"&&(e.editableTabsValue=e.editableTabsValue||"",e.style.showTabTitle=e.style.showTabTitle===void 0?!0:e.style.showTabTitle),e.expand=e.expand||!1,e.resizeInnerKeep=e.resizeInnerKeep||!1,e.component==="Picture"&&(e.style.adaptation=e.style.adaptation||"adaptation"),e.style.adaptation=e.style.adaptation||"adaptation",e.style.borderActive===void 0?(e.style.borderActive=!1,e.style.borderWidth=1,e.style.borderRadius=5,e.style.borderStyle="solid",e.style.borderColor="#cccccc"):(e.style.borderWidth=e.style.borderWidth===void 0?1:e.style.borderWidth,e.style.borderRadius=e.style.borderRadius===void 0?5:e.style.borderRadius,e.style.borderStyle=e.style.borderStyle===void 0?"solid":e.style.borderStyle,e.style.borderColor=e.style.borderColor===void 0?"#cccccc":e.style.borderColor),e.dashboardHidden=e.dashboardHidden||!1,e.maintainRadio=e.maintainRadio||!1,e.multiDimensional=e.multiDimensional||D(ee),e.carousel=e.carousel||D(ae),e.aspectRatio=e.aspectRatio||1,e.component==="UserView"&&(e.actionSelection=e.actionSelection||D(te)),(!r||r===2)&&(i==null?void 0:i.type)==="dashboard"&&A(e),e.events=e.events&&e.events.checked!==void 0&&e.events.type!=="displayChange"?e.events:D(re),e.events.jump.type=e.events.jump.type||"_blank",e.category=e.category||"base",e.component==="DeTabs"?(e.titleBackground=e.titleBackground||D(J),e.style.fontStyle=e.style.fontStyle||"normal",e.style.fontWeight=e.style.fontWeight||"normal",e.style.textDecoration=e.style.textDecoration||"none",(s=e.propValue)==null||s.forEach(o=>{var d;(d=o.componentData)==null||d.forEach(c=>{N(c,a,t,r,i)})})):e.component==="Group"&&((l=e.propValue)==null||l.forEach(o=>{N(o,a,t,r,i)}))}function X(e,a,t,r,i){(r==null?void 0:r.resourceTable)==="snapshot"&&a.forEach(s=>{s.canvasId="canvas-main"});const n=q.get(L("x-de-execute-version")),u=t==null?void 0:t.reportFilterInfo;(t==null?void 0:t.checkVersion)===n&&!u||(e.component.seniorStyleSetting=e.component.seniorStyleSetting||D(M),e.fontFamily=e.fontFamily||"PingFang",e.dashboard.showGrid=e.dashboard.showGrid||!1,e.dashboard.matrixBase=e.dashboard.matrixBase||4,e.dashboard.gapMode=e.dashboard.gapMode||"middle",e.component.seniorStyleSetting=e.component.seniorStyleSetting||D(M),e.suspensionButtonAvailable=e.suspensionButtonAvailable===void 0?!1:e.suspensionButtonAvailable,e.screenAdaptor=e.screenAdaptor||"widthFirst",e.dashboardAdaptor=e.dashboardAdaptor||"keepHeightAndWidth",e.refreshBrowserEnable=e.refreshBrowserEnable===void 0?!1:e.refreshBrowserEnable,e.refreshBrowserUnit=e.refreshBrowserUnit||"minute",e.refreshBrowserTime=e.refreshBrowserTime||5,e.scaleWidth=e.scale,e.scaleHeight=e.scale,e.popupAvailable=e.popupAvailable===void 0?!0:e.popupAvailable,e.popupButtonAvailable=e.popupButtonAvailable===void 0?!0:e.popupButtonAvailable,a.forEach(s=>{N(s,u,r,i,t)}))}function ra(e,a){const t=p.value.filter(r=>["ScrollText"].includes(r.component)||r.innerType==="rich-text");if(t&&t.length>0){const r=t.map(i=>i.id);W(e,a,{}).then(i=>{const n=i.data,s=JSON.parse(n.componentData).reduce((l,o)=>(l[o.id]=o,l),{});for(let l=0;l<p.value.length;l++){const o=p.value[l];if(r.includes(o.id)&&s[o.id])if(ke.value)p.value[l].propValue=s[o.id].propValue;else{const{top:d,left:c,height:v,width:k,fontSize:h}=p.value[l].style,{linkageFilters:C,outerParamsFilters:w,webParamsFilters:E}=p.value[l];s[o.id].style.top=d,s[o.id].style.left=c,s[o.id].style.height=v,s[o.id].style.width=k,s[o.id].linkageFilters=C,s[o.id].outerParamsFilters=w,s[o.id].webParamsFilters=E,h&&(s[o.id].style.fontSize=h),p.value[l]=s[o.id]}}})}}function x(e,a,t){const r=a.busiFlag,i=r!=null&&r.includes("-copy"),n=i?r.split("-")[0]:r,u=i?de:W;let s={source:a.source?a.source:"main"};if(f.canvasAttachInfo&&f.canvasAttachInfo.taskId&&(s={source:"report",taskId:f.canvasAttachInfo.taskId},f.canvasAttachInfo.hasOwnProperty("showWatermark")&&typeof f.canvasAttachInfo.showWatermark<"u"&&f.canvasAttachInfo.showWatermark!==null)){const o=f.canvasAttachInfo.showWatermark==="true";s.showWatermark=o}s.resourceTable=a.resourceTable?a.resourceTable:"core",u(e,n,s).then(l=>{var E;const o=l.data,d={...o.watermarkInfo,settingContent:(E=o.watermarkInfo)!=null&&E.settingContent?JSON.parse(o.watermarkInfo.settingContent):{}},c={id:o.id,name:o.name,pid:o.pid,status:o.status,selfWatermarkStatus:o.selfWatermarkStatus,type:o.type,creatorName:o.creatorName,updateName:o.updateName,createTime:o.createTime,updateTime:o.updateTime,watermarkInfo:d,weight:o.weight,ext:o.ext,contentId:o.contentId,mobileLayout:o.mobileLayout||!1},v=o.version,k=JSON.parse(o.componentData),h=JSON.parse(o.canvasStyleData),C=o.canvasViewInfo;X(h,k,o,s,v);const w=c.type==="dashboard"&&h.dashboard.gap==="yes"?h.dashboard.gapSize:0;Ce.setCurrentFont(h.fontFamily),document.documentElement.style.setProperty("--de-canvas_custom_font",`${h.fontFamily}`),t({canvasDataResult:k,canvasStyleResult:h,dvInfo:c,canvasViewInfoPreview:C,curPreviewGap:w})})}async function ia(e,a,t){x(e,a,function({canvasDataResult:r,canvasStyleResult:i,dvInfo:n,canvasViewInfoPreview:u}){a.onlyPreview||(f.setComponentData(r),f.setCanvasStyle(i),f.updateCurDvInfo(n),f.setCanvasViewInfo(u),H(n.id,a.resourceTable).then(s=>{f.setNowPanelTrackInfo(s.data)}),U(n.id,a.resourceTable).then(s=>{f.setNowPanelJumpInfo(s.data)})),t({canvasDataResult:r,canvasStyleResult:i,dvInfo:n,canvasViewInfoPreview:u})})}async function sa(e,a,t,r){x(e,{busiFlag:t},function({canvasDataResult:i,canvasStyleResult:n,canvasViewInfoPreview:u}){const s=i.filter(d=>!!d.inMobile),l=s.map(d=>d.id);p.value.forEach(d=>{if(d.inMobile=l.includes(d.id),d.inMobile){const{mx:c,my:v,mSizeX:k,mSizeY:h,mPropValue:C,mEvents:w,mCommonBackground:E}=s.find(m=>m.id===d.id);d.mx=c,d.my=v,d.mSizeX=k,d.mSizeY=h,d.mEvents=w,d.mCommonBackground=E,d.component==="VQuery"&&(d.mPropValue=C)}}),Object.keys(u).forEach(d=>{if(T.value[d]&&u[d]){const{customAttrMobile:c,customStyleMobile:v}=u[d];T.value[d].customStyleMobile=v,T.value[d].customAttrMobile=c}}),f.setComponentData(p.value);const o=S(Y.value);o.mobileSetting?o.mobileSetting=n.mobileSetting:o.mobileSetting={backgroundColorSelect:!1,background:"",color:"#ffffff",backgroundImageEnable:!1,customSetting:!1},f.setCanvasStyle(o),r()})}function oa(e,a,t){x(e,a,function({canvasDataResult:r,canvasStyleResult:i,dvInfo:n,canvasViewInfoPreview:u}){const s=r.filter(l=>!!l.inMobile);r.forEach(l=>{var z;const{mx:o,my:d,mSizeX:c,mSizeY:v,mStyle:k,mPropValue:h,mEvents:C,mCommonBackground:w,style:E,propValue:m,events:K,commonBackground:Q}=l;l.x=o,l.y=d,l.sizeX=c,l.sizeY=v,l.style=k||E,l.propValue=h||m,l.events=C||K,l.commonBackground=w||Q,l.component==="DeTabs"&&((z=l.propValue)==null||z.forEach($=>{var _;(_=$.componentData)==null||_.forEach(g=>{g.style=g.mStyle||g.style,g.propValue=g.mPropValue||g.propValue,g.events=g.mEvents||g.events,g.commonBackground=g.mCommonBackground||g.commonBackground})}))}),u&&Object.keys(u).forEach(l=>{const o=u[l],{customAttrMobile:d,customStyleMobile:c}=o;o.customAttr=d||o.customAttr,o.customStyle=c||o.customStyle}),f.setComponentData(s),f.setCanvasStyle(i),f.updateCurDvInfo(n),f.setCanvasViewInfo(u),H(n.id,a.resourceTable).then(l=>{f.setNowPanelTrackInfo(l.data)}),U(n.id).then(l=>{f.setNowPanelJumpInfo(l.data)}),t({canvasDataResult:s,canvasStyleResult:i,dvInfo:n,canvasViewInfoPreview:u})})}function na(e){if(y.value.id&&y.value.optType!=="copy"&&!Te()){const t={...y.value,watermarkInfo:null},r=(y.value.type==="dashboard"?V("work_branch.dashboard"):V("work_branch.big_data_screen"))+V("visualization.save_conflict_tips");oe(t).then(i=>{i&&i.data==="Repeat"?be.confirm(r,{confirmButtonType:"danger",type:"warning",autofocus:!1,showClose:!1}).then(()=>{e()}):e()})}else e()}async function la(e){await Se(null,e)}async function Se(e,a){f.removeGroupArea();const t=S(p.value);t.forEach(s=>{var l,o;s.component==="UserView"?s.linkageFilters=[]:s.component==="Group"?(l=s.propValue)==null||l.forEach(d=>{d.linkageFilters=[]}):s.component==="DeTabs"&&((o=s.propValue)==null||o.forEach(d=>{var c;(c=d.componentData)==null||c.forEach(v=>{v.linkageFilters=[]})}))});const r=F(),i={canvasStyleData:JSON.stringify(Y.value),componentData:JSON.stringify(t),canvasViewInfo:T.value,appData:G.value,...y.value,checkVersion:q.get(L("x-de-execute-version")),contentId:r,watermarkInfo:null};let n="success";if(G.value&&await ne({datasetFolderPid:i.datasetFolderPid,datasetFolderName:i.datasetFolderName}).then(s=>{n=s.data}),n==="repeat"){ve.error("数据集分组名称已存在");return}ye(y.value,V("components.length_1_64_characters"));const u=y.value.id&&y.value.optType!=="copy"?B:le;u===B&&await ue({opt:"edit",nodeType:"leaf",name:y.value.name,type:y.value.type,id:y.value.id}),u(i).then(s=>{var l;if(u===B){const o=e!=null&&e.status?e==null?void 0:e.status:(l=s.data)==null?void 0:l.status;f.updateDvInfoCall(o,null,r)}else f.updateDvInfoCall(0,s.data,r);Ee.resetStyleChangeTimes(),a(s)})}function ua(e){return e&&(/^(http(s)?:\/\/)/.test(e.toLowerCase())?e:"http://"+e)}function da(e,a,t,r){if(!t)return t;let i=t;const n=r.reduce((s,l)=>(s[l[e]]=l[a],s),{}),u=(t==null?void 0:t.match(/\[(.+?)\]/g))||[];return u&&u.forEach(s=>{const l=s.slice(1,-1);i=i.replace(s,n[l])}),i}function j(e){return e==="canvas-main"}function fa(e){var a;if(e.component==="DeTabs"){let t=!0;return(a=e.propValue)==null||a.forEach(r=>{var i;(i=r.componentData)==null||i.forEach(n=>{n.component==="Group"&&(t=!1)})}),t}else return!0}function ca(e){var a;if(e.component==="Group"){let t=!0;return(a=e.propValue)==null||a.forEach(r=>{r.component==="DeTabs"&&(t=!1)}),t}else return!0}function pa(e,a){if(a==="canvas-main")return j(e.canvasId);const t={};return p.value.forEach(r=>{O(r,null,t)}),a==="pTabGroup"?!!(t[e.id]&&t[e.id].component==="DeTabs"&&t[t[e.id].id]&&t[t[e.id].id].component==="Group"):a==="groupInTab"?!!(e.component==="Group"&&t[t[e.id].id]&&t[t[e.id].id].component==="DeTabs"):a==="tabInGroup"?!!(e.component==="DeTabs"&&t[e.id]&&t[e.id].component==="Group"):!1}function O(e,a,t){var r,i;t[e.id]=a,e.component==="DeTabs"?(r=e.propValue)==null||r.forEach(n=>{var u;(u=n.componentData)==null||u.forEach(s=>{O(s,e,t)})}):e.component==="Group"&&((i=e.propValue)==null||i.forEach(n=>{O(n,e,t)}))}function ha(e,a){return e.canvasId===a}function ga(e){return Ve(e)||Ae(e)}function Ve(e){return e&&e.includes("Group")}function Ae(e){return e&&!e.includes("Group")&&!j(e)}function ya(e,a=p.value){let t=-1;return a.forEach((r,i)=>{r.id===e&&(t=i)}),t}function ba(e,a,t=!1){const r=document.querySelector(t?"#point-shadow-main":"#shape-id-"+e.id),i=r.offsetWidth,n=r.offsetHeight;if(e.sizeX=Math.round(i/a.baseWidth),e.sizeY=Math.round(n/a.baseHeight),e.style.width=i,e.style.height=n,t){const u=r.offsetLeft,s=r.offsetTop;e.x=Math.round(u/a.baseWidth),e.y=Math.round(s/a.baseHeight),e.style.left=u,e.style.height=s}}function va(e,a){e.forEach(t=>{var r,i;t.component==="UserView"&&t.innerType!="VQuery"?a.push(t.id):t.component==="Group"?(r=t.propValue)==null||r.forEach(n=>{a.push(n.id)}):t.component==="DeTabs"&&((i=t.propValue)==null||i.forEach(n=>{var u;(u=n.componentData)==null||u.forEach(s=>{a.push(s.id)})}))})}function me(e){return e.filter(a=>a.leaf?!0:a.children&&a.children.length>0?(a.children=me(a.children),!0):!1)}function Da(e,a){function t(r,i){if(r.children)for(const n of r.children){if(n.id===i)return r.id;const u=t(n,i);if(u!==null)return u}return null}for(const r of e){const i=t(r,a);if(i!==null)return i}return null}async function Ta(e,a){let t;await se(e).then(r=>{const i=r.data,n=JSON.parse(i.componentData),u=i.appData,s=JSON.parse(i.canvasStyleData);n.forEach(l=>{(!i.version||i.version===2)&&i.type==="dashboard"&&A(l)}),s.component.seniorStyleSetting=s.component.seniorStyleSetting||D(M),s.scaleWidth=s.scale,s.scaleHeight=s.scaleHeight,t={canvasStyleData:s,componentData:n,canvasViewInfo:i.canvasViewInfo,appData:u,baseInfo:{preName:i.name}}}).catch(r=>{console.error(r)}),X(t.canvasStyleData,t.componentData,null,{resourceTable:"snapshot"},null),a(t)}function ka(){return y.value.type==="dashboard"}function Ea(e,a,t,r){const{width:i,height:n}=e.style,u=i,s=n;function l(d){return d===2?75:75+Math.floor(d-2)*35}a.left<0?a.left=0:u-a.left<60&&(a.left=a.left-60);const o=l(r);a.top<0?a.top=0:a.top+o+60>s&&(a.top=a.top-o)}function Be(e){e&&Array.isArray(e)&&(e.sort((a,t)=>a.y-t.y),e.forEach(a=>{var t;a.component==="DeTabs"&&((t=a.propValue)==null||t.forEach(r=>{Be(r.componentData)}))}))}function Ca(){return p.value.length===0?1:p.value.filter(e=>e.y).map(e=>e.y+e.sizeY).reduce((e,a)=>Math.max(e,a),0)}function wa(e){let a;return p.value.forEach(t=>{var r,i;t.id===e?a=t:t.component==="Group"?(r=t.propValue)==null||r.forEach(n=>{n.id===e&&(a=n)}):t.component==="DeTabs"&&((i=t.propValue)==null||i.forEach(n=>{var u;(u=n.componentData)==null||u.forEach(s=>{s.id===e&&(a=s)})}))}),a}function Sa(e,a="canvas_init_ready"){try{console.info("event:"+a);const t={type:"dataease-embedded-interactive",eventName:a,args:e};window.parent.postMessage(t,"*")}catch{console.warn("de_inner_params send error")}}function Va(e){if(e){const a=T.value[e.id];a.customStyle=e.customStyle,a.customAttr=e.customAttr,a.title=e.title,a.name=e.name}}function Aa(e){e&&T.value[e.id]&&(["UserView"].includes(e.component)?T.value[e.id].title=e.name:["VQuery"].includes(e.component)&&(T.value[e.id].title=e.name,T.value[e.id].customStyle.component.title=e.name))}export{Be as A,ba as B,ya as C,$e as D,me as E,ra as F,Da as G,Re as H,Xe as I,je as J,Ie as K,Ke as L,Qe as M,Ze as N,Ye as O,Ea as P,da as Q,ua as R,x as S,wa as T,sa as U,oa as V,Va as W,ta as a,na as b,aa as c,la as d,Se as e,va as f,fa as g,Ta as h,ia as i,we as j,ea as k,qe as l,H as m,Ae as n,Sa as o,O as p,U as q,Ca as r,Aa as s,Ve as t,j as u,pa as v,ca as w,ka as x,ga as y,ha as z};
