import{e as J,E as O,q as ze,i as Be,L as Ue,w as $e,r as Me,x as Re,T as qe,U as Ae,W as Ce,A as Ge,y as We,B as Xe,z as Je,V as Pe,v as Ye}from"./element-plus-secondary-0.0.0-dataease.js";import{i as He}from"./icon_upload_outlined-0.0.0-dataease.js";import{f as Qe,e as C}from"./ConfigGlobal.vue_vue_type_script_setup_true_lang-0.0.0-dataease.js";import{f as j}from"./attr-0.0.0-dataease23.js";import{e as Ze,b as et,u as tt}from"./datasource-0.0.0-dataease.js";import{g as at}from"./js-base64-0.0.0-dataease.js";import lt from"./ExcelInfo-0.0.0-dataease.js";import st from"./SheetTabs-0.0.0-dataease.js";import{u as ot}from"./index-0.0.0-dataease.js";import{i as P}from"./field-list-0.0.0-dataease.js";import{h as I,d as nt}from"./lodash-es-0.0.0-dataease.js";import{d as ct,l as Y,t as it,r as y,x as H,k as rt,n as fe,b as dt,e as ut,o as f,c as z,a as B,$ as pt,T,U as i,u as l,W as n,_ as q,Y as k,R as F,z as U,S as he,V as _e,a8 as mt,h as ft,s as ht}from"./@vue-0.0.0-dataease.js";import{b as _t}from"./mathjs-0.0.0-dataease.js";const vt={class:"excel-detail"},yt={class:"detail-inner"},gt={class:"upload-tip",style:{width:"100%"}},xt={key:0,class:"ed-form-item__error"},Et={class:"title-form_primary"},Tt={key:0,class:"table-select_mode"},bt={class:"btn-select"},kt={style:{float:"left"}},wt={style:{float:"left","font-size":"12px",color:"#8492a6"}};function Dt($){return typeof $=="function"||Object.prototype.toString.call($)==="[object Object]"&&!ht($)}const Rt=ct({__name:"ExcelDetail",props:{param:{required:!1,default(){return Y({id:"0",name:"",desc:"",type:"Excel",editType:0})},type:Object},isSupportSetKey:{type:_t,required:!0}},setup($,{expose:ve}){const b=$,{param:_,isSupportSetKey:ye}=it(b),{t:o}=Qe(),{emitter:ge}=ot(),N=y(!1),w=H([]),g=H([]),A=y(),K={tableName:" ",sheetExcelId:"",fields:[],jsonArray:[],nameExist:!1,empty:"",overLength:!1},S=Y(I(K)),h=Y({excelData:[],defaultExpandedKeys:[],defaultCheckedKeys:[],fileList:null,sheets:[]}),M=rt(()=>{const[e={}]=h.excelData;return{name:e.excelLabel,size:e.excelLabel}}),Q=y(!1),Z={TEXT:"text",DATETIME:"time",LONG:"value",DOUBLE:"value"},xe={0:"TEXT",2:"LONG",3:"DOUBLE"},Ee=e=>e.map(a=>({key:a.originName,fieldType:a.fieldType,deExtractType:a.deExtractType,dataKey:a.originName,title:a.name,checked:a.checked,primaryKey:a.primaryKey,length:a.length,width:150,headerCellRenderer:({column:s})=>{let t;return n("div",{class:"flex-align-center icon"},[n(J,null,{default:()=>[n(C,null,Dt(t=ft(P[Z[s.fieldType]],{class:`svg-icon field-icon-${Z[s.fieldType]}`}))?t:{default:()=>[t]})]}),n("span",{class:"ellipsis",title:s.title,style:{width:"100px"}},[s.title])])}})),ee=e=>{e.sheet&&(Object.assign(S,e),w.value=Ee(e.fields),g.value=w.value.filter(a=>a.checked),R.value="preview")},te=()=>{Q.value=!0},ae=e=>{var s;v.value=e.value;const a=(s=h.excelData[0])==null?void 0:s.sheets.find(t=>t.sheetId===e.value);ee(a)},le=e=>{h.excelData=[],v.value="",V.value=[],Object.assign(S,I(K)),e.toString().replace("Error: ","")},V=H([]),v=y(""),Te=()=>{h.excelData=[],v.value="",V.value=[],Object.assign(S,I(K))},se=e=>{if(!e)return;if((e==null?void 0:e.code)!==0){h.excelData=[],v.value="",V.value=[],Object.assign(S,I(K)),O.warning(e.msg);return}w.value=[],Object.assign(S,I(K)),g.value=[],Q.value=!1,_.value.name||(_.value.name=e.data.excelLabel),V.value=e.data.sheets.map(s=>{const{sheetId:t,tableName:r,newSheet:u}=s;return{value:t,label:r,newSheet:u}}),h.excelData=[e.data];const[a]=V.value;a&&ae(a)},be=(e,a,s)=>{var D;let t=[],r=[],u=!1,x=!1,m=(D=h.excelData[0])==null?void 0:D.sheets;for(let d=0;d<m.length;d++)if(m[d].sheet){if(m[d].effectExtField&&(u=!0),m[d].changeFiled&&(x=!0),m[d].fields.filter(E=>E.checked).length==0){O({message:m[d].excelLabel+o("datasource.api_field_not_empty"),type:"error"}),s==null||s();return}for(let E=0;E<m[d].fields.length;E++)if(m[d].fields[E].checked&&m[d].fields[E].primaryKey&&!m[d].fields[E].length&&m[d].fields[E].deExtractType===0){O({message:o("datasource.primary_key_length")+m[d].excelLabel+": "+m[d].fields[E].name,type:"error"}),s==null||s();return}t.push(m[d]),r.push(m[d].fieldsMd5)}if(!t.length){O({message:o("dataset.ple_select_excel"),type:"error"}),s==null||s();return}let L={};e&&(_.value.name=e.name),b.param.id?L={id:b.param.id,name:b.param.name,type:"Excel",sheets:t,editType:b.param.editType?b.param.editType:0}:L={id:b.param.id,name:b.param.name,type:"Excel",sheets:t,editType:0},b.param.editType===0&&b.param.id&&(u||x)?ze.confirm(o("deDataset.replace_the_data"),{confirmButtonText:o("dataset.confirm"),tip:o("data_source.to_replace_it"),cancelButtonText:"Cancel",confirmButtonType:"primary",type:"warning",autofocus:!1,showClose:!1,callback:d=>{d==="confirm"&&oe(r,L,e,a,s)}}):oe(r,L,e,a,s)},oe=(e,a,s,t,r)=>{for(let x=0;x<a.sheets.length;x++)a.sheets[x].data=[],a.sheets[x].jsonArray=[];a.configuration=at.encode(JSON.stringify(a.sheets));let u=et;!a.id||a.id==="0"?(delete a.id,a.pid=s.pid):u=tt,!N.value&&(N.value=!0,u(a).then(x=>{ge.emit("showFinishPage",x),t==null||t(),O({message:o("commons.save_success"),type:"success"})}).finally(()=>{r==null||r(),N.value=!1}))},ne=e=>{h.fileList=e},G=y(!0),ce=nt(()=>{G.value=!1,fe(()=>{G.value=!0})},500);dt(()=>{window.addEventListener("resize",ce)}),ut(()=>{window.removeEventListener("resize",ce)});const ie=y(),re=y(),de=()=>{const e=new FormData;return e.append("file",h.fileList.raw),e.append("type",""),e.append("editType",_.value.editType),e.append("id",_.value.id||0),N.value=!0,Ze(e).then(a=>{var s,t;(s=ie.value)==null||s.clearFiles(),(t=re.value)==null||t.clearFiles(),se(a),N.value=!1}).catch(a=>{h.excelData=[],v.value="",V.value=[],Object.assign(S,I(K)),a.code==="ECONNABORTED"&&O({type:"error",message:a.message,showClose:!0}),N.value=!1})},ue=y(),ke=()=>ue.value.validate,pe=y(!0),we=e=>{pe.value=!1,se(e)},W=y(!1),X=y(!1),R=y("preview"),De=e=>{var s;e.deType=e.deExtractType,((s=h.excelData[0])==null?void 0:s.sheets.find(t=>t.sheetId===v.value)).fields.forEach(t=>{t.originName===e.dataKey&&(t.deExtractType=e.deExtractType,t.deType=e.deExtractType,t.fieldType=xe[e.deExtractType])})},Ne=e=>{var s;((s=h.excelData[0])==null?void 0:s.sheets.find(t=>t.sheetId===v.value)).fields.forEach(t=>{t.originName===e.dataKey&&(t.length=e.length)})},Se=e=>{var s;((s=h.excelData[0])==null?void 0:s.sheets.find(t=>t.sheetId===v.value)).fields.forEach(t=>{t.originName===e.dataKey&&(t.primaryKey=e.primaryKey)})},Ve=[{label:o("dataset.text"),value:0},{label:o("dataset.value"),value:2},{label:o("dataset.value")+"("+o("dataset.float")+")",value:3}],Fe=e=>{var a;X.value||(g.value=e,g.value.forEach(t=>{t.checked=!0}),w.value.forEach(t=>{let r;for(let u=0;u<g.value.length;u++)t.dataKey===g.value[u].dataKey&&(r=g.value[u]);r?t.checked=r.checked:t.checked=!1}),((a=h.excelData[0])==null?void 0:a.sheets.find(t=>t.sheetId===v.value)).fields.forEach(t=>{let r;for(let u=0;u<g.value.length;u++)t.originName===g.value[u].dataKey&&(r=g.value[u]);r?t.checked=r.checked:t.checked=!1}))},Ke=e=>{if(!e.checked||e.deExtractType!==0)return!0},me=e=>{var a;if(R.value=e,e==="select")fe(()=>{var s;X.value=!0;for(let t=0;t<w.value.length;t++)w.value[t].checked&&((s=A==null?void 0:A.value)==null||s.toggleRowSelection(w.value[t],!0));X.value=!1});else{const s=(a=h.excelData[0])==null?void 0:a.sheets.find(t=>t.sheetId===v.value);ee(s)}};return ve({saveExcelDs:be,submitForm:ke,sheetFile:M,appendReplaceExcel:we,uploadStatus:e=>{W.value=e}}),(e,a)=>{const s=Be,t=Ue,r=$e,u=Me,x=Re,m=qe,L=Ae,D=Ce,d=Ge,E=We,Le=Xe,Oe=Je,je=Pe,Ie=Ye;return f(),z("div",vt,[B("div",yt,[pt((f(),T(x,{ref_key:"excelForm",ref:ue,"require-asterisk-position":"right",model:l(_),"label-position":"top"},{default:i(()=>[M.value.name?(f(),T(r,{prop:"id",label:l(o)("data_source.document"),key:"sheetFile",rules:[{required:!0}]},{default:i(()=>[n(lt,{onDel:Te,"show-del":"",name:M.value.name,size:M.value.size},null,8,["name","size"]),n(t,{action:"",multiple:!1,ref_key:"uploadAgain",ref:re,"show-file-list":!1,accept:".xls,.xlsx,.csv","before-upload":te,"on-change":ne,"http-request":de,"on-error":le,name:"file"},{trigger:i(()=>[n(s,{text:""},{default:i(()=>[q(k(l(o)("data_source.reupload")),1)]),_:1})]),_:1},512)]),_:1},8,["label"])):(f(),T(r,{prop:"id",key:"sheetId",label:l(o)("data_source.document"),rules:[{required:!0}]},{default:i(()=>[n(t,{multiple:!1,action:"",ref_key:"upload",ref:ie,"show-file-list":!1,accept:".xls,.xlsx,.csv","before-upload":te,"on-change":ne,"http-request":de,"on-error":le,name:"file"},{trigger:i(()=>[n(s,{secondary:""},{icon:i(()=>[n(l(C),{name:"icon_upload_outlined"},{default:i(()=>[n(l(He),{class:"svg-icon"})]),_:1})]),default:i(()=>[q(" "+k(l(o)("dataset.upload_file")),1)]),_:1})]),_:1},512),B("p",gt,k(l(o)("data_source.and_csv_formats")),1),W.value?(f(),z("div",xt,k(l(o)("data_source.please_upload_files")),1)):F("",!0)]),_:1},8,["label"])),pe.value?(f(),T(r,{class:U(W.value&&!M.value.name&&"error-status"),prop:"name",key:"name",rules:[{required:!0,message:l(o)("common.please_input")+l(o)("common.empty")+l(o)("datasource.datasource")+l(o)("common.empty")+l(o)("common.name")}],label:l(o)("visualization.custom")+l(o)("common.empty")+l(o)("datasource.datasource")+l(o)("common.empty")+l(o)("common.name")},{default:i(()=>[n(u,{modelValue:l(_).name,"onUpdate:modelValue":a[0]||(a[0]=c=>l(_).name=c),placeholder:l(o)("common.please_input")+l(o)("common.empty")+l(o)("datasource.datasource")+l(o)("common.empty")+l(o)("common.name")},null,8,["modelValue","placeholder"])]),_:1},8,["class","rules","label"])):F("",!0)]),_:1},8,["model"])),[[Ie,N.value]]),v.value?(f(),z(he,{key:0},[B("div",Et,k(l(o)("chart.data_preview")),1),n(st,{activeTab:v.value,onTabClick:ae,"tab-list":V.value},null,8,["activeTab","tab-list"]),l(_).editType===0?(f(),z("div",Tt,[B("div",bt,[n(s,{onClick:a[1]||(a[1]=c=>me("preview")),class:U([R.value==="preview"&&"is-active"]),text:""},{default:i(()=>[q(k(l(o)("chart.data_preview")),1)]),_:1},8,["class"]),n(s,{onClick:a[2]||(a[2]=c=>me("select")),class:U([R.value==="select"&&"is-active"]),text:""},{default:i(()=>[q(k(l(o)("data_set.field_selection")),1)]),_:1},8,["class"])])])):F("",!0),G.value?(f(),z("div",{key:1,class:U(["info-table",l(_).editType===0&&"info-table_height"])},[R.value==="preview"?(f(),T(L,{key:0},{default:i(({height:c,width:p})=>[n(m,{columns:g.value,"header-class":"excel-header-cell",data:S.jsonArray,width:p,height:c,fixed:""},null,8,["columns","data","width","height"])]),_:1})):(f(),T(je,{key:1,"header-class":"header-cell",ref_key:"multipleTable",ref:A,data:w.value,style:{width:"100%"},onSelectionChange:Fe},{default:i(()=>[n(D,{type:"selection",width:"55"}),n(D,{label:l(o)("data_set.field_name")},{default:i(c=>[q(k(c.row.title),1)]),_:1},8,["label"]),n(D,{prop:"deExtractType",label:l(o)("datasource.field_type")},{default:i(c=>[n(E,{modelValue:c.row.deExtractType,"onUpdate:modelValue":p=>c.row.deExtractType=p,class:"select-type",style:{display:"inline-block",width:"120px"},onChange:p=>De(c.row)},{prefix:i(()=>[n(l(J),null,{default:i(()=>[n(l(C),{className:`field-icon-${l(j)[c.row.deExtractType]}`},{default:i(()=>[(f(),T(_e(l(P)[l(j)[c.row.deExtractType]]),{class:U(["svg-icon",`field-icon-${l(j)[c.row.deExtractType]}`])},null,8,["class"]))]),_:2},1032,["className"])]),_:2},1024)]),default:i(()=>[(f(),z(he,null,mt(Ve,p=>n(d,{key:p.value,label:p.label,value:p.value},{default:i(()=>[B("span",kt,[n(l(J),null,{default:i(()=>[n(l(C),{className:`field-icon-${l(j)[p.value]}`},{default:i(()=>[(f(),T(_e(l(P)[l(j)[p.value]]),{class:U(["svg-icon",`field-icon-${l(j)[p.value]}`])},null,8,["class"]))]),_:2},1032,["className"])]),_:2},1024)]),B("span",wt,k(p.label),1)]),_:2},1032,["label","value"])),64))]),_:2},1032,["modelValue","onUpdate:modelValue","onChange"])]),_:1},8,["label"]),l(_).editType===0?(f(),T(D,{key:0,prop:"length",label:l(o)("datasource.length")},{default:i(c=>[n(Le,{disabled:Ke(c.row),modelValue:c.row.length,"onUpdate:modelValue":p=>c.row.length=p,autocomplete:"off","step-strictly":"",class:"text-left edit-all-line",min:1,max:512,placeholder:l(o)("common.inputText"),"controls-position":"right",type:"number",onChange:p=>Ne(c.row)},null,8,["disabled","modelValue","onUpdate:modelValue","placeholder","onChange"])]),_:1},8,["label"])):F("",!0),l(_).editType===0&&l(ye)?(f(),T(D,{key:1,prop:"primaryKey","class-name":"checkbox-table",label:l(o)("datasource.set_key"),width:"100"},{default:i(c=>[(f(),T(Oe,{key:c.row.dataKey,modelValue:c.row.primaryKey,"onUpdate:modelValue":p=>c.row.primaryKey=p,disabled:!c.row.checked,onChange:p=>Se(c.row)},null,8,["modelValue","onUpdate:modelValue","disabled","onChange"]))]),_:1},8,["label"])):F("",!0)]),_:1},8,["data"]))],2)):F("",!0)],64)):F("",!0)])])}}});export{Rt as _};
