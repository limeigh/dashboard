import{a as ze,z as Be}from"./index-0.0.0-dataease.js";import{a as Ue,E as $e}from"./el-table-0.0.0-dataease.js";import{E as Me}from"./el-checkbox-0.0.0-dataease.js";import"./el-tooltip-0.0.0-dataease.js";import"./el-popper-0.0.0-dataease.js";import{o as Re,n as C,j as J,D as L,F as qe,y as Ae,G as Ce}from"./ConfigGlobal.vue_vue_type_script_setup_true_lang-0.0.0-dataease.js";import"./el-input-number-0.0.0-dataease.js";import"./el-tag-0.0.0-dataease.js";import{a as Ge,E as Xe}from"./el-select-0.0.0-dataease.js";import"./el-empty-0.0.0-dataease.js";import"./el-virtual-list-0.0.0-dataease.js";import{E as Pe,a as Je}from"./el-table-v2-0.0.0-dataease.js";import"./el-form-0.0.0-dataease.js";import{E as We,a as He}from"./el-form-item-0.0.0-dataease.js";import{E as Qe}from"./el-upload-0.0.0-dataease.js";import"./el-progress-0.0.0-dataease.js";import{i as Ye}from"./icon_upload_outlined-0.0.0-dataease.js";import{f as j}from"./attr-0.0.0-dataease23.js";import{e as Ze,b as et,u as tt}from"./datasource-0.0.0-dataease.js";import{g as at}from"./dataset-0.0.0-dataease.js";import lt from"./ExcelInfo-0.0.0-dataease.js";import st from"./SheetTabs-0.0.0-dataease.js";import{i as W}from"./field-list-0.0.0-dataease.js";import{e as I,h as ot}from"./lodash-0.0.0-dataease.js";import{E as nt}from"./index-0.0.0-dataease20.js";import{d as it,X as H,t as rt,r as y,s as Q,y as ct,n as fe,o as dt,a as ut,f,O as z,P as B,R as pt,g as T,i as r,u as l,j as n,a3 as q,a4 as b,_ as K,S as U,W as he,l as _e,a6 as mt,h as ft,ak as ht}from"./vue-0.0.0-dataease.js";import{b as _t}from"./pureFunctionsAny.generated-0.0.0-dataease.js";const vt={class:"excel-detail"},yt={class:"detail-inner"},gt={class:"upload-tip",style:{width:"100%"}},xt={key:0,class:"ed-form-item__error"},Et={class:"title-form_primary"},Tt={key:0,class:"table-select_mode"},kt={class:"btn-select"},bt={style:{float:"left"}},wt={style:{float:"left","font-size":"12px",color:"#8492a6"}};function Dt($){return typeof $=="function"||Object.prototype.toString.call($)==="[object Object]"&&!ht($)}const ta=it({__name:"ExcelDetail",props:{param:{required:!1,default(){return H({id:"0",name:"",desc:"",type:"Excel",editType:0})},type:Object},isSupportSetKey:{type:_t,required:!0}},setup($,{expose:ve}){const k=$,{param:_,isSupportSetKey:ye}=rt(k),{t:o}=Re(),{emitter:ge}=ze(),N=y(!1),w=Q([]),g=Q([]),A=y(),O={tableName:" ",sheetExcelId:"",fields:[],jsonArray:[],nameExist:!1,empty:"",overLength:!1},S=H(I(O)),h=H({excelData:[],defaultExpandedKeys:[],defaultCheckedKeys:[],fileList:null,sheets:[]}),M=ct(()=>{const[e={}]=h.excelData;return{name:e.excelLabel,size:e.excelLabel}}),Y=y(!1),Z={TEXT:"text",DATETIME:"time",LONG:"value",DOUBLE:"value"},xe={0:"TEXT",2:"LONG",3:"DOUBLE"},Ee=e=>e.map(a=>({key:a.originName,fieldType:a.fieldType,deExtractType:a.deExtractType,dataKey:a.originName,title:a.name,checked:a.checked,primaryKey:a.primaryKey,length:a.length,width:150,headerCellRenderer:({column:s})=>{let t;return n("div",{class:"flex-align-center icon"},[n(J,null,{default:()=>[n(C,null,Dt(t=ft(W[Z[s.fieldType]],{class:`svg-icon field-icon-${Z[s.fieldType]}`}))?t:{default:()=>[t]})]}),n("span",{class:"ellipsis",title:s.title,style:{width:"100px"}},[s.title])])}})),ee=e=>{e.sheet&&(Object.assign(S,e),w.value=Ee(e.fields),g.value=w.value.filter(a=>a.checked),R.value="preview")},te=()=>{Y.value=!0},ae=e=>{var s;v.value=e.value;const a=(s=h.excelData[0])==null?void 0:s.sheets.find(t=>t.sheetId===e.value);ee(a)},le=e=>{h.excelData=[],v.value="",F.value=[],Object.assign(S,I(O)),e.toString().replace("Error: ","")},F=Q([]),v=y(""),Te=()=>{h.excelData=[],v.value="",F.value=[],Object.assign(S,I(O))},se=e=>{if(!e)return;if((e==null?void 0:e.code)!==0){h.excelData=[],v.value="",F.value=[],Object.assign(S,I(O)),L.warning(e.msg);return}w.value=[],Object.assign(S,I(O)),g.value=[],Y.value=!1,_.value.name||(_.value.name=e.data.excelLabel),F.value=e.data.sheets.map(s=>{const{sheetId:t,tableName:c,newSheet:u}=s;return{value:t,label:c,newSheet:u}}),h.excelData=[e.data];const[a]=F.value;a&&ae(a)},ke=(e,a,s)=>{var D;let t=[],c=[],u=!1,x=!1,m=(D=h.excelData[0])==null?void 0:D.sheets;for(let d=0;d<m.length;d++)if(m[d].sheet){if(m[d].effectExtField&&(u=!0),m[d].changeFiled&&(x=!0),m[d].fields.filter(E=>E.checked).length==0){L({message:m[d].excelLabel+o("datasource.api_field_not_empty"),type:"error"}),s==null||s();return}for(let E=0;E<m[d].fields.length;E++)if(m[d].fields[E].checked&&m[d].fields[E].primaryKey&&!m[d].fields[E].length&&m[d].fields[E].deExtractType===0){L({message:o("datasource.primary_key_length")+m[d].excelLabel+": "+m[d].fields[E].name,type:"error"}),s==null||s();return}t.push(m[d]),c.push(m[d].fieldsMd5)}if(!t.length){L({message:o("dataset.ple_select_excel"),type:"error"}),s==null||s();return}let V={};e&&(_.value.name=e.name),k.param.id?V={id:k.param.id,name:k.param.name,type:"Excel",sheets:t,editType:k.param.editType?k.param.editType:0}:V={id:k.param.id,name:k.param.name,type:"Excel",sheets:t,editType:0},k.param.editType===0&&k.param.id&&(u||x)?qe.confirm(o("deDataset.replace_the_data"),{confirmButtonText:o("dataset.confirm"),tip:o("data_source.to_replace_it"),cancelButtonText:"Cancel",confirmButtonType:"primary",type:"warning",autofocus:!1,showClose:!1,callback:d=>{d==="confirm"&&oe(c,V,e,a,s)}}):oe(c,V,e,a,s)},oe=(e,a,s,t,c)=>{for(let x=0;x<a.sheets.length;x++)a.sheets[x].data=[],a.sheets[x].jsonArray=[];a.configuration=at.encode(JSON.stringify(a.sheets));let u=et;!a.id||a.id==="0"?(delete a.id,a.pid=s.pid):u=tt,!N.value&&(N.value=!0,u(a).then(x=>{ge.emit("showFinishPage",x),t==null||t(),L({message:o("commons.save_success"),type:"success"})}).finally(()=>{c==null||c(),N.value=!1}))},ne=e=>{h.fileList=e},G=y(!0),ie=ot(()=>{G.value=!1,fe(()=>{G.value=!0})},500);dt(()=>{window.addEventListener("resize",ie)}),ut(()=>{window.removeEventListener("resize",ie)});const re=y(),ce=y(),de=()=>{const e=new FormData;return e.append("file",h.fileList.raw),e.append("type",""),e.append("editType",_.value.editType),e.append("id",_.value.id||0),N.value=!0,Ze(e).then(a=>{var s,t;(s=re.value)==null||s.clearFiles(),(t=ce.value)==null||t.clearFiles(),se(a),N.value=!1}).catch(a=>{h.excelData=[],v.value="",F.value=[],Object.assign(S,I(O)),a.code==="ECONNABORTED"&&L({type:"error",message:a.message,showClose:!0}),N.value=!1})},ue=y(),be=()=>ue.value.validate,pe=y(!0),we=e=>{pe.value=!1,se(e)},X=y(!1),P=y(!1),R=y("preview"),De=e=>{var s;e.deType=e.deExtractType,((s=h.excelData[0])==null?void 0:s.sheets.find(t=>t.sheetId===v.value)).fields.forEach(t=>{t.originName===e.dataKey&&(t.deExtractType=e.deExtractType,t.deType=e.deExtractType,t.fieldType=xe[e.deExtractType])})},Ne=e=>{var s;((s=h.excelData[0])==null?void 0:s.sheets.find(t=>t.sheetId===v.value)).fields.forEach(t=>{t.originName===e.dataKey&&(t.length=e.length)})},Se=e=>{var s;((s=h.excelData[0])==null?void 0:s.sheets.find(t=>t.sheetId===v.value)).fields.forEach(t=>{t.originName===e.dataKey&&(t.primaryKey=e.primaryKey)})},Fe=[{label:o("dataset.text"),value:0},{label:o("dataset.value"),value:2},{label:o("dataset.value")+"("+o("dataset.float")+")",value:3}],Ke=e=>{var a;P.value||(g.value=e,g.value.forEach(t=>{t.checked=!0}),w.value.forEach(t=>{let c;for(let u=0;u<g.value.length;u++)t.dataKey===g.value[u].dataKey&&(c=g.value[u]);c?t.checked=c.checked:t.checked=!1}),((a=h.excelData[0])==null?void 0:a.sheets.find(t=>t.sheetId===v.value)).fields.forEach(t=>{let c;for(let u=0;u<g.value.length;u++)t.originName===g.value[u].dataKey&&(c=g.value[u]);c?t.checked=c.checked:t.checked=!1}))},Oe=e=>{if(!e.checked||e.deExtractType!==0)return!0},me=e=>{var a;if(R.value=e,e==="select")fe(()=>{var s;P.value=!0;for(let t=0;t<w.value.length;t++)w.value[t].checked&&((s=A==null?void 0:A.value)==null||s.toggleRowSelection(w.value[t],!0));P.value=!1});else{const s=(a=h.excelData[0])==null?void 0:a.sheets.find(t=>t.sheetId===v.value);ee(s)}};return ve({saveExcelDs:ke,submitForm:be,sheetFile:M,appendReplaceExcel:we,uploadStatus:e=>{X.value=e}}),(e,a)=>{const s=Ae,t=Qe,c=We,u=Ce,x=He,m=Pe,V=Je,D=Ue,d=Ge,E=Xe,Ve=nt,Le=Me,je=$e,Ie=Be;return f(),z("div",vt,[B("div",yt,[pt((f(),T(x,{ref_key:"excelForm",ref:ue,"require-asterisk-position":"right",model:l(_),"label-position":"top"},{default:r(()=>[M.value.name?(f(),T(c,{prop:"id",label:l(o)("data_source.document"),key:"sheetFile",rules:[{required:!0}]},{default:r(()=>[n(lt,{onDel:Te,"show-del":"",name:M.value.name,size:M.value.size},null,8,["name","size"]),n(t,{action:"",multiple:!1,ref_key:"uploadAgain",ref:ce,"show-file-list":!1,accept:".xls,.xlsx,.csv","before-upload":te,"on-change":ne,"http-request":de,"on-error":le,name:"file"},{trigger:r(()=>[n(s,{text:""},{default:r(()=>[q(b(l(o)("data_source.reupload")),1)]),_:1})]),_:1},512)]),_:1},8,["label"])):(f(),T(c,{prop:"id",key:"sheetId",label:l(o)("data_source.document"),rules:[{required:!0}]},{default:r(()=>[n(t,{multiple:!1,action:"",ref_key:"upload",ref:re,"show-file-list":!1,accept:".xls,.xlsx,.csv","before-upload":te,"on-change":ne,"http-request":de,"on-error":le,name:"file"},{trigger:r(()=>[n(s,{secondary:""},{icon:r(()=>[n(l(C),{name:"icon_upload_outlined"},{default:r(()=>[n(l(Ye),{class:"svg-icon"})]),_:1})]),default:r(()=>[q(" "+b(l(o)("dataset.upload_file")),1)]),_:1})]),_:1},512),B("p",gt,b(l(o)("data_source.and_csv_formats")),1),X.value?(f(),z("div",xt,b(l(o)("data_source.please_upload_files")),1)):K("",!0)]),_:1},8,["label"])),pe.value?(f(),T(c,{class:U(X.value&&!M.value.name&&"error-status"),prop:"name",key:"name",rules:[{required:!0,message:l(o)("common.please_input")+l(o)("common.empty")+l(o)("datasource.datasource")+l(o)("common.empty")+l(o)("common.name")}],label:l(o)("visualization.custom")+l(o)("common.empty")+l(o)("datasource.datasource")+l(o)("common.empty")+l(o)("common.name")},{default:r(()=>[n(u,{modelValue:l(_).name,"onUpdate:modelValue":a[0]||(a[0]=i=>l(_).name=i),placeholder:l(o)("common.please_input")+l(o)("common.empty")+l(o)("datasource.datasource")+l(o)("common.empty")+l(o)("common.name")},null,8,["modelValue","placeholder"])]),_:1},8,["class","rules","label"])):K("",!0)]),_:1},8,["model"])),[[Ie,N.value]]),v.value?(f(),z(he,{key:0},[B("div",Et,b(l(o)("chart.data_preview")),1),n(st,{activeTab:v.value,onTabClick:ae,"tab-list":F.value},null,8,["activeTab","tab-list"]),l(_).editType===0?(f(),z("div",Tt,[B("div",kt,[n(s,{onClick:a[1]||(a[1]=i=>me("preview")),class:U([R.value==="preview"&&"is-active"]),text:""},{default:r(()=>[q(b(l(o)("chart.data_preview")),1)]),_:1},8,["class"]),n(s,{onClick:a[2]||(a[2]=i=>me("select")),class:U([R.value==="select"&&"is-active"]),text:""},{default:r(()=>[q(b(l(o)("data_set.field_selection")),1)]),_:1},8,["class"])])])):K("",!0),G.value?(f(),z("div",{key:1,class:U(["info-table",l(_).editType===0&&"info-table_height"])},[R.value==="preview"?(f(),T(V,{key:0},{default:r(({height:i,width:p})=>[n(m,{columns:g.value,"header-class":"excel-header-cell",data:S.jsonArray,width:p,height:i,fixed:""},null,8,["columns","data","width","height"])]),_:1})):(f(),T(je,{key:1,"header-class":"header-cell",ref_key:"multipleTable",ref:A,data:w.value,style:{width:"100%"},onSelectionChange:Ke},{default:r(()=>[n(D,{type:"selection",width:"55"}),n(D,{label:l(o)("data_set.field_name")},{default:r(i=>[q(b(i.row.title),1)]),_:1},8,["label"]),n(D,{prop:"deExtractType",label:l(o)("datasource.field_type")},{default:r(i=>[n(E,{modelValue:i.row.deExtractType,"onUpdate:modelValue":p=>i.row.deExtractType=p,class:"select-type",style:{display:"inline-block",width:"120px"},onChange:p=>De(i.row)},{prefix:r(()=>[n(l(J),null,{default:r(()=>[n(l(C),{className:`field-icon-${l(j)[i.row.deExtractType]}`},{default:r(()=>[(f(),T(_e(l(W)[l(j)[i.row.deExtractType]]),{class:U(["svg-icon",`field-icon-${l(j)[i.row.deExtractType]}`])},null,8,["class"]))]),_:2},1032,["className"])]),_:2},1024)]),default:r(()=>[(f(),z(he,null,mt(Fe,p=>n(d,{key:p.value,label:p.label,value:p.value},{default:r(()=>[B("span",bt,[n(l(J),null,{default:r(()=>[n(l(C),{className:`field-icon-${l(j)[p.value]}`},{default:r(()=>[(f(),T(_e(l(W)[l(j)[p.value]]),{class:U(["svg-icon",`field-icon-${l(j)[p.value]}`])},null,8,["class"]))]),_:2},1032,["className"])]),_:2},1024)]),B("span",wt,b(p.label),1)]),_:2},1032,["label","value"])),64))]),_:2},1032,["modelValue","onUpdate:modelValue","onChange"])]),_:1},8,["label"]),l(_).editType===0?(f(),T(D,{key:0,prop:"length",label:l(o)("datasource.length")},{default:r(i=>[n(Ve,{disabled:Oe(i.row),modelValue:i.row.length,"onUpdate:modelValue":p=>i.row.length=p,autocomplete:"off","step-strictly":"",class:"text-left edit-all-line",min:1,max:512,placeholder:l(o)("common.inputText"),"controls-position":"right",type:"number",onChange:p=>Ne(i.row)},null,8,["disabled","modelValue","onUpdate:modelValue","placeholder","onChange"])]),_:1},8,["label"])):K("",!0),l(_).editType===0&&l(ye)?(f(),T(D,{key:1,prop:"primaryKey","class-name":"checkbox-table",label:l(o)("datasource.set_key"),width:"100"},{default:r(i=>[(f(),T(Le,{key:i.row.dataKey,modelValue:i.row.primaryKey,"onUpdate:modelValue":p=>i.row.primaryKey=p,disabled:!i.row.checked,onChange:p=>Se(i.row)},null,8,["modelValue","onUpdate:modelValue","disabled","onChange"]))]),_:1},8,["label"])):K("",!0)]),_:1},8,["data"]))],2)):K("",!0)],64)):K("",!0)])])}}});export{ta as _};
