import{e as Q,E as b,ag as ta,ah as sa,r as na,w as oa,A as ra,y as ia,i as da,W as ua,V as ca,x as ma,p as fa,z as pa,B as _a,T as ha,U as va,Z as ya,v as ga}from"./element-plus-secondary-0.0.0-dataease.js";import{d as ba,l as S,r as m,x as ie,q as wa,o as v,T as k,U as i,W as d,_ as E,Y as _,u as s,$ as w,a0 as N,a as p,c as G,S as de,a8 as ue,R as H,z as B,V as Ee,Z as ka,n as Ce}from"./@vue-0.0.0-dataease.js";import{i as Pe}from"./icon_expand-right_filled-0.0.0-dataease.js";import{f as xa,e as W,n as Z}from"./ConfigGlobal.vue_vue_type_script_setup_true_lang-0.0.0-dataease.js";import Va from"./ApiHttpRequestForm-0.0.0-dataease.js";import{g as U}from"./js-base64-0.0.0-dataease.js";import{E as Na}from"./EmptyBackground-0.0.0-dataease.js";import{c as ce}from"./datasource-0.0.0-dataease.js";import{f as D}from"./attr-0.0.0-dataease23.js";import{i as Te}from"./field-list-0.0.0-dataease.js";import"./index-0.0.0-dataease.js";import"./web-storage-cache-0.0.0-dataease.js";import"./echarts-0.0.0-dataease.js";import"./tinymce-0.0.0-dataease.js";import{_ as Ea}from"./PluginComponent.vue_vue_type_script_setup_true_lang-0.0.0-dataease.js";import{h as Ca}from"./lodash-es-0.0.0-dataease.js";const Pa={style:{display:"flex",width:"100%","justify-content":"center"}},Ta={class:"title-form_primary base-info"},ja={class:"title-form_primary request-info"},Fa={class:"title-form_primary request-info"},qa={class:"title-form_primary request-info"},Sa={class:"table-container de-svg-in-table"},Ua={class:"name"},Da={class:"de-svg-in-table"},Ja=["title"],Oa={style:{float:"left"}},$a={style:{float:"left","font-size":"12px",color:"#8492a6"}},Ma={class:"name"},tl=ba({__name:"ApiHttpRequestDraw",emits:["returnItem"],setup(Ka,{expose:je,emit:Fe}){const{t:o}=xa(),me=S({jsonFields:[],fields:[]});let $=S([]),y=S([]),C=S([]),a=S({status:"",name:"",type:"table",url:"",method:"GET",request:{changeId:"",rest:[],headers:[],arguments:[],body:{typeChange:"",raw:"",kvs:[]},authManager:{verification:"",username:"",password:""}},fields:[],jsonFields:[],useJsonPath:!1,apiQueryTimeout:10,showApiStructure:!1,jsonPath:"",serialNumber:-1}),M=[];const qe=m(),Y=m(!1),F=m(!1),x=m(1),X=m(!1),P=m(!1),fe=ie([]),K=ie([]),ee=ie([]),J=m(),f=m(),pe=m(!1),Se=(l,e,t)=>{if(!e){t(new Error(o("datasource.please_input_query_timeout")));return}let n=!1;var u=/^\d+$/;if(n=u.test(e),!n){t(new Error(o("datasource.please_input_query_timeout")));return}if(e<=0||e>300){t(new Error(o("datasource.please_input_query_timeout")));return}t()},_e=S({name:[{required:!0,message:o("datasource.input_name"),trigger:"blur"},{min:2,max:64,message:o("datasource.input_limit_2_25",[2,64]),trigger:"blur"}],apiQueryTimeout:[{required:!0,validator:Se,trigger:["blur","change"]}],url:[{required:!0,message:o("data_source.the_request_address"),trigger:"blur"}],desc:[{required:!0,trigger:"blur"}]}),z=m("table"),ae=m(!1),le=m(!1),T=m("API"),he=m(""),j=m(!1),te=m([]),se=m(""),ne=m(!1);wa("api-active-name",z);const Ue=(l,e,t,n,u,g,O,q)=>{if(te.value=g,se.value=O,q)j.value=q;else{const h=te.value.filter(V=>V.type===e.type);h&&h.length>0&&(j.value=!0)}if(le.value=l.copy,ne.value=e.copy,T.value=e.type,pe.value=u,z.value=t,ae.value=n,$=e.apiConfiguration,C=l.fields,e.paramsConfiguration&&(y=e.paramsConfiguration),j.value&&(he.value=Ze()),K.value=[],y)for(let h=0;h<y.length;h++)K.value=K.value.concat(y[h].fields);Object.assign(a,l),F.value=!0,x.value=0,Ce(()=>{var h,V;j.value?((h=f==null?void 0:f.value)==null||h.invokeMethod({methodName:"clearForm",args:[]}),(V=f==null?void 0:f.value)==null||V.invokeMethod({methodName:"initForm",args:[]})):J.value.clearValidate()})},De=()=>{J.value.validate(l=>{var e,t;if(l){const n=U.encode(JSON.stringify(a)),u=U.encode(JSON.stringify(y));X.value=!0,(t=(e=Z)["/datasource/checkApiDatasource"])==null||t.call(e),ce({dsType:T.value,data:n,type:"apiStructure",paramsList:u}).then(g=>{me.jsonFields=g.data.jsonFields}).catch(g=>{console.warn(g==null?void 0:g.message)}),X.value=!1}else return!1})},Je=[{id:"GET",label:"GET"},{id:"POST",label:"POST"}],Oe=[{id:!0,label:o("common.yes")},{id:!1,label:o("common.no")}],$e=[{label:o("dataset.text"),value:0},{label:o("dataset.value"),value:2},{label:o("dataset.value")+"("+o("dataset.float")+")",value:3}],L=m(!1),Me=()=>{var l;if(a.type!=="params"&&a.fields.length===0){b.error(o("datasource.api_field_not_empty"));return}if(a.type==="params"){for(let e=0;e<a.fields.length;e++)for(let t=0;t<y.length;t++)for(let n=0;n<y[t].fields.length;n++)if(a.fields[e].name===y[t].fields[n].name&&a.serialNumber!==y[t].serialNumber){b.error(o("data_source.name_already_exists")+a.fields[e].name);return}}for(let e=0;e<a.fields.length-1;e++)for(let t=e+1;t<a.fields.length;t++)if(a.fields[e].name===a.fields[t].name){b.error(a.fields[e].name+", "+o("datasource.has_repeat_field_name"));return}if(ae.value){let e="";for(let t=0;t<a.fields.length;t++)if(a.fields[t].primaryKey){let n=!1;for(let u=0;u<C.length;u++)C[u].name===a.fields[t].name&&C[u].primaryKey&&(n=!0);n||(e=e+" "+a.fields[t].name)}for(let t=0;t<C.length;t++)if(C[t].primaryKey){let n=!1;for(let u=0;u<a.fields.length;u++)C[t].name===a.fields[u].name&&a.fields[u].primaryKey&&(n=!0);n||(e=e+" "+C[t].name)}if(e!==""&&!(ne.value||le.value)){b.error(o("datasource.primary_key_change")+e);return}for(let t=0;t<a.fields.length;t++)if(a.fields[t].primaryKey&&!a.fields[t].length&&a.fields[t].deExtractType===0){b.error(o("datasource.primary_key_length")+a.fields[t].name);return}}else for(let e=0;e<a.fields.length;e++)if(a.fields[e].primaryKey&&!a.fields[e].length&&a.fields[e].deExtractType===0){b.error(o("datasource.primary_key_length")+a.fields[e].name);return}Ye("returnItem",Ca(a)),j.value&&((l=f==null?void 0:f.value)==null||l.invokeMethod({methodName:"resetForm",args:[]})),F.value=!1},Ke=()=>{x.value-=1},ze=()=>{var l;j.value?(l=f==null?void 0:f.value)==null||l.invokeMethod({methodName:"submitForm",args:[{eventName:"stepNext",args:a}]}):J.value.validate(e=>{e&&ve()})},ve=()=>{var e,t;if(a.useJsonPath&&!a.jsonPath){b.error(o("datasource.please_input_dataPath"));return}if(a.type==="params"){for(let n=0;n<y.length;n++)if(y[n].name===a.name&&a.serialNumber!==y[n].serialNumber){b.error(o("data_source.name_already_exists_de"));return}}else for(let n=0;n<$.length;n++)if($[n].name===a.name&&a.serialNumber!==$[n].serialNumber){b.error(o("datasource.has_repeat_name"));return}(t=(e=Z)["/datasource/checkApiDatasource"])==null||t.call(e);const l=U.encode(JSON.stringify(y));L.value=!0,P.value=!0,ce({dsType:T.value,data:U.encode(JSON.stringify(a)),paramsList:l}).then(n=>{L.value=!1,P.value=!1,a.jsonFields=n.data.jsonFields,a.fields=[],a.name=n.data.name,oe(a),A(),x.value+=1}).catch(n=>{L.value=!1,P.value=!1,console.warn(n==null?void 0:n.message)})},Le=()=>{var l;j.value?(l=f==null?void 0:f.value)==null||l.invokeMethod({methodName:"submitForm",args:[{eventName:"validateItem",args:a}]}):J.value.validate(e=>{if(e)ye();else return})},ye=()=>{var e,t;if(a.useJsonPath&&!a.jsonPath){b.error(o("datasource.please_input_dataPath"));return}(t=(e=Z)["/datasource/checkApiDatasource"])==null||t.call(e);const l=U.encode(JSON.stringify(y));P.value=!0,ce({dsType:T.value,data:U.encode(JSON.stringify(a)),paramsList:l}).then(n=>{P.value=!1,a.jsonFields=n.data.jsonFields,a.fields=[],a.name=n.data.name,oe(a),A(),b.success(o("datasource.validate_success"))}).catch(()=>{P.value=!1,b.error(o("data_source.verification_failed"))})},Ae=l=>{const e=l.validate;e(t=>{t&&(l.eventName==="validateItem"?ye():ve())})},ge=()=>{var l,e,t;(e=(l=Z)["/datasource/checkApiDatasource"])==null||e.call(l),j.value&&((t=f==null?void 0:f.value)==null||t.invokeMethod({methodName:"resetForm",args:[]})),F.value=!1},Re=l=>!!(l.hasOwnProperty("children")&&l.children.length>0),Ie=l=>l.hasOwnProperty("children")&&l.children.length>0?!0:l.deExtractType!==0,Qe=l=>l.hasOwnProperty("children")&&l.children.length>0?!0:le.value||ne.value?!1:!!(ae.value||!l.checked),Ge=l=>!!(a.type=="params"||l.hasOwnProperty("children")&&l.children.length>0),He=l=>{l.deExtractType!==0&&(l.length="")},A=()=>{Y.value=!1;const l=[],e=[];let t=0;for(let n=0;n<a.fields.length;n++)a.fields[n].value&&a.fields[n].value.length>t&&(t=a.fields[n].value.length);for(let n=0;n<t;n++)l.push({});for(let n=0;n<a.fields.length;n++){for(let u=0;u<a.fields[n].value.length;u++)l[u][a.fields[n].name]=a.fields[n].value[u];e.push({key:a.fields[n].name,dataKey:a.fields[n].name,title:a.fields[n].name,width:150})}ee.value=l,fe.value=e,Y.value=a.fields.length===0},be=(l,e)=>{var t;(t=e.children)!=null&&t.length&&e.children.forEach(n=>{n.checked=e.checked,be(l,n)})},oe=l=>{for(var e=0;e<l.jsonFields.length;e++)l.jsonFields[e].checked&&l.jsonFields[e].children===void 0&&l.fields.push(l.jsonFields[e]),l.jsonFields[e].children!==void 0&&we(l,l.jsonFields[e].children)},we=(l,e)=>{var u;for(var t=0;t<e.length;t++){if(e[t].checked&&e[t].children===void 0){for(var n=0;n<l.fields.length;n++)l.fields[n].name===e[t].name&&(e[t].checked=!1,Ce(()=>{e[t].checked=!1}),M.push(e[t].name));l.fields.push(e[t])}(u=e[t].children)!=null&&u.length&&we(l,e[t].children)}},Be=l=>{M=[],be(a,l),a.fields=[],oe(a),A(),M.length&&b.error([...new Set(M)].join(",")+", "+o("datasource.has_repeat_field_name"))},We=l=>{a.request.body.typeChange=l},R=m(!0),I=m(!0),Ze=()=>{var e;const l=te.value.filter(t=>t.type===T.value);return se.value?se.value:l&&l.length>0?(e=l[0].staticMap)==null?void 0:e.index:null},Ye=Fe;return je({initApiItem:Ue}),(l,e)=>{const t=ta,n=sa,u=na,g=oa,O=ra,q=ia,h=da,V=ua,ke=ca,xe=ma,re=fa,Ve=pa,Xe=_a,ea=ha,aa=va,la=ya,Ne=ga;return v(),k(la,{title:z.value==="table"?s(o)("datasource.data_table"):s(o)("data_source.interface_parameters"),modelValue:F.value,"onUpdate:modelValue":e[9]||(e[9]=r=>F.value=r),"modal-class":"api-datasource-drawer",size:"1000px","before-close":ge,direction:"rtl"},{footer:i(()=>[d(h,{secondary:"",onClick:ge},{default:i(()=>[E(_(s(o)("common.cancel")),1)]),_:1}),w(d(h,{disabled:P.value,secondary:"",onClick:Le},{default:i(()=>[E(_(s(o)("commons.validate")),1)]),_:1},8,["disabled"]),[[N,x.value===0]]),w(d(h,{type:"primary",disabled:L.value,onClick:ze},{default:i(()=>[E(_(s(o)("common.next")),1)]),_:1},8,["disabled"]),[[N,x.value===0]]),w(d(h,{secondary:"",onClick:Ke},{default:i(()=>[E(_(s(o)("common.prev")),1)]),_:1},512),[[N,x.value===1]]),w(d(h,{type:"primary",onClick:Me},{default:i(()=>[E(_(s(o)("commons.save")),1)]),_:1},512),[[N,x.value===1]])]),default:i(()=>[p("div",Pa,[d(n,{custom:"",style:{"max-width":"400px",flex:"1"},active:x.value,"align-center":""},{default:i(()=>[d(t,null,{title:i(()=>[E(_(s(o)("datasource.api_step_1")),1)]),_:1}),d(t,null,{title:i(()=>[E(_(z.value==="table"?s(o)("datasource.api_step_2"):s(o)("data_source.extract_parameters")),1)]),_:1})]),_:1},8,["active"])]),w(d(re,null,{default:i(()=>[w((v(),k(xe,{ref_key:"apiItemBasicInfo",ref:J,model:s(a),"label-position":"top","label-width":"100px","require-asterisk-position":"right",rules:_e},{default:i(()=>[p("div",Ta,[p("span",null,_(s(o)("datasource.base_info")),1)]),d(g,{label:s(o)("common.name"),prop:"name"},{default:i(()=>[d(u,{modelValue:s(a).name,"onUpdate:modelValue":e[0]||(e[0]=r=>s(a).name=r),placeholder:s(o)("common.input_name"),autocomplete:"off"},null,8,["modelValue","placeholder"])]),_:1},8,["label"]),d(g,{label:s(o)("datasource.request"),prop:"url"},{default:i(()=>[d(u,{modelValue:s(a).url,"onUpdate:modelValue":e[2]||(e[2]=r=>s(a).url=r),placeholder:s(o)("datasource.path_all_info"),class:"input-with-select"},{prepend:i(()=>[d(q,{modelValue:s(a).method,"onUpdate:modelValue":e[1]||(e[1]=r=>s(a).method=r)},{default:i(()=>[(v(),G(de,null,ue(Je,r=>d(O,{key:r.id,label:r.label,value:r.id},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1},8,["modelValue","placeholder"])]),_:1},8,["label"]),w((v(),G("div",null,[p("div",ja,[p("span",null,_(s(o)("datasource.req_param")),1)]),d(g,{class:"line-height_18"},{default:i(()=>[F.value?(v(),k(Va,{key:0,request:s(a).request,"value-list":K.value,onChangeId:We},null,8,["request","value-list"])):H("",!0)]),_:1})])),[[Ne,X.value]]),d(g,{label:l.$t("datasource.query_timeout"),prop:"apiQueryTimeout"},{default:i(()=>[d(u,{modelValue:s(a).apiQueryTimeout,"onUpdate:modelValue":e[3]||(e[3]=r=>s(a).apiQueryTimeout=r),autocomplete:"off",type:"number",min:0},{append:i(()=>[E(_(l.$t("chart.second")),1)]),_:1},8,["modelValue"])]),_:1},8,["label"]),p("div",Fa,[p("span",null,_(s(o)("datasource.isUseJsonPath")),1)]),d(g,null,{default:i(()=>[d(u,{modelValue:s(a).jsonPath,"onUpdate:modelValue":e[5]||(e[5]=r=>s(a).jsonPath=r),placeholder:s(o)("datasource.jsonpath_info"),class:"input-with-select"},{prepend:i(()=>[d(q,{modelValue:s(a).useJsonPath,"onUpdate:modelValue":e[4]||(e[4]=r=>s(a).useJsonPath=r),style:{width:"100px"}},{default:i(()=>[(v(),G(de,null,ue(Oe,r=>d(O,{key:r.label,label:r.label,value:r.id},null,8,["label","value"])),64))]),_:1},8,["modelValue"])]),append:i(()=>[d(h,{onClick:De},{default:i(()=>[E(_(s(o)("data_source.view_data_structure")),1)]),_:1})]),_:1},8,["modelValue","placeholder"])]),_:1}),w(p("div",qa,[p("span",null,_(s(o)("datasource.column_info")),1)],512),[[N,s(a).useJsonPath]]),w(p("div",Sa,[d(ke,{data:me.jsonFields,style:{width:"100%"},"row-key":"jsonPath"},{default:i(()=>[d(V,{"class-name":"checkbox-table",prop:"originName",label:s(o)("datasource.parse_filed"),"show-overflow-tooltip":""},{default:i(r=>[E(_(r.row.originName),1)]),_:1},8,["label"])]),_:1},8,["data"])],512),[[N,s(a).useJsonPath]])]),_:1},8,["model","rules"])),[[Ne,P.value]])]),_:1},512),[[N,x.value===0&&T.value==="API"]]),w(d(re,null,{default:i(()=>[T.value!=="API"?(v(),k(s(Ea),{key:0,jsname:he.value,"api-item":s(a),ref_key:"xpackApiItemBasicInfo",ref:f,onSubmitForm:Ae},null,8,["jsname","api-item"])):H("",!0)]),_:1},512),[[N,x.value===0&&T.value!=="API"]]),w(d(re,null,{default:i(()=>[d(xe,{style:{width:"100%"},ref_key:"apiItemForm",ref:qe,model:s(a),"label-position":"top","label-width":"100px",rules:_e},{default:i(()=>[p("p",{class:B([R.value?"active":"deactivate","column-info-title"]),onClick:e[6]||(e[6]=r=>R.value=!R.value)},[d(s(Q),{style:{"font-size":"10px"}},{default:i(()=>[d(s(W),{name:"icon_expand-right_filled"},{default:i(()=>[d(s(Pe),{class:"svg-icon"})]),_:1})]),_:1}),p("span",Ua,_(s(o)("datasource.column_info")),1)],2),w(p("div",Da,[d(ke,{"header-cell-class-name":"header-cell",data:s(a).jsonFields,style:{width:"100%"},"row-key":"jsonPath"},{default:i(()=>[d(V,{"class-name":"checkbox-table",prop:"originName",label:s(o)("datasource.parse_filed"),width:"200"},{default:i(r=>[(v(),k(Ve,{style:{display:"inline-block","max-width":"80px","white-space":"nowrap"},key:r.row.jsonPath,modelValue:r.row.checked,"onUpdate:modelValue":c=>r.row.checked=c,disabled:s(a).useJsonPath,onChange:c=>Be(r.row)},{default:i(()=>[p("span",{title:r.row.originName,class:"ellipsis",style:{display:"inline-block","max-width":"80px"}},_(r.row.originName),9,Ja)]),_:2},1032,["modelValue","onUpdate:modelValue","disabled","onChange"]))]),_:1},8,["label"]),d(V,{prop:"name",label:s(o)("datasource.field_rename")},{default:i(r=>[d(u,{modelValue:r.row.name,"onUpdate:modelValue":c=>r.row.name=c,disabled:Re(r.row),text:"",onChange:e[7]||(e[7]=c=>A())},null,8,["modelValue","onUpdate:modelValue","disabled"])]),_:1},8,["label"]),d(V,{prop:"deExtractType",label:s(o)("datasource.field_type"),disabled:s(a).type==="params"},{default:i(r=>[d(q,{modelValue:r.row.deExtractType,"onUpdate:modelValue":c=>r.row.deExtractType=c,disabled:Ge(r.row),class:"select-type",style:{display:"inline-block",width:"120px"},onChange:c=>He(r.row)},{prefix:i(()=>[d(s(Q),null,{default:i(()=>[d(s(W),{className:`field-icon-${s(D)[r.row.deExtractType]}`},{default:i(()=>[(v(),k(Ee(s(Te)[s(D)[r.row.deExtractType]]),{class:B(["svg-icon",`field-icon-${s(D)[r.row.deExtractType]}`])},null,8,["class"]))]),_:2},1032,["className"])]),_:2},1024)]),default:i(()=>[(v(),G(de,null,ue($e,c=>d(O,{key:c.value,label:c.label,value:c.value},{default:i(()=>[p("span",Oa,[d(s(Q),null,{default:i(()=>[d(s(W),{className:`field-icon-${s(D)[c.value]}`},{default:i(()=>[(v(),k(Ee(s(Te)[s(D)[c.value]]),{class:B(["svg-icon",`field-icon-${s(D)[c.value]}`])},null,8,["class"]))]),_:2},1032,["className"])]),_:2},1024)]),p("span",$a,_(c.label),1)]),_:2},1032,["label","value"])),64))]),_:2},1032,["modelValue","onUpdate:modelValue","disabled","onChange"])]),_:1},8,["label","disabled"]),s(a).type!=="params"?(v(),k(V,{key:0,prop:"length",label:s(o)("datasource.length")},{default:i(r=>[d(Xe,{disabled:Ie(r.row),modelValue:r.row.length,"onUpdate:modelValue":c=>r.row.length=c,autocomplete:"off","step-strictly":"",class:"text-left edit-all-line",min:1,max:512,placeholder:s(o)("common.inputText"),"controls-position":"right",type:"number"},null,8,["disabled","modelValue","onUpdate:modelValue","placeholder"])]),_:1},8,["label"])):H("",!0),s(a).type!=="params"&&pe.value?(v(),k(V,{key:1,prop:"primaryKey","class-name":"checkbox-table",label:s(o)("datasource.set_key"),width:"100"},{default:i(r=>[(v(),k(Ve,{key:r.row.jsonPath,modelValue:r.row.primaryKey,"onUpdate:modelValue":c=>r.row.primaryKey=c,disabled:Qe(r.row)},null,8,["modelValue","onUpdate:modelValue","disabled"]))]),_:1},8,["label"])):H("",!0)]),_:1},8,["data"])],512),[[N,R.value]]),p("p",{class:B([I.value?"active":"deactivate","column-info-title"]),onClick:e[8]||(e[8]=r=>I.value=!I.value)},[d(s(Q),{style:{"font-size":"10px"}},{default:i(()=>[d(s(W),{name:"icon_expand-right_filled"},{default:i(()=>[d(s(Pe),{class:"svg-icon"})]),_:1})]),_:1}),p("span",Ma,_(s(o)("datasource.data_preview")),1)],2),w(p("div",{class:"info-table",style:ka({height:Math.min(ee.value.length,20)*40+"px"})},[Y.value?(v(),k(Na,{key:0,description:s(o)("data_source.the_data_structure"),"img-type":"select"},null,8,["description"])):(v(),k(aa,{key:1},{default:i(({height:r,width:c})=>[d(ea,{columns:fe.value,"header-class":"header-cell",data:ee.value,width:c,height:r,fixed:""},null,8,["columns","data","width","height"])]),_:1}))],4),[[N,I.value]])]),_:1},8,["model","rules"])]),_:1},512),[[N,x.value===1]])]),_:1},8,["title","modelValue"])}}});export{tl as _};
