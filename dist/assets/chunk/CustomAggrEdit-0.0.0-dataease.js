import{R as tt}from"./index-0.0.0-dataease.js";import{E as et}from"./el-row-0.0.0-dataease.js";import"./el-popper-0.0.0-dataease.js";import{E as ot}from"./el-popover-0.0.0-dataease.js";import{o as at,n as st,j as nt,G as it}from"./ConfigGlobal.vue_vue_type_script_setup_true_lang-0.0.0-dataease.js";import"./el-tooltip-0.0.0-dataease.js";import{d as lt,r as k,X as q,o as ct,a as rt,w as B,f as r,O as m,P as n,a4 as l,u as s,j as e,i as a,a3 as v,W as J,a6 as P,a8 as w,n as dt,g as N,l as ut,S as pt,_ as _t}from"./vue-0.0.0-dataease.js";import{i as V}from"./icon_info_outlined-0.0.0-dataease.js";import{i as j}from"./icon_search-outline_outlined-0.0.0-dataease.js";import{i as mt}from"./icon_adjustment_outlined-0.0.0-dataease.js";import{i as ft}from"./icon_edit_outlined-0.0.0-dataease.js";import{i as vt}from"./icon_delete-trash_outlined-0.0.0-dataease.js";import gt from"./CodeMirror-0.0.0-dataease.js";import{M as ht}from"./dataset-0.0.0-dataease.js";import{f as M}from"./attr-0.0.0-dataease23.js";import{i as yt}from"./field-list-0.0.0-dataease.js";import{e as S}from"./lodash-0.0.0-dataease.js";import{E as kt}from"./index-0.0.0-dataease4.js";import{_ as Ct}from"./_plugin-vue_export-helper-0.0.0-dataease.js";import"./constants-0.0.0-dataease.js";import"./dropdown-0.0.0-dataease.js";import"./axios-0.0.0-dataease.js";import"./library-0.0.0-dataease.js";import"./echarts-0.0.0-dataease.js";import"./tinymce-0.0.0-dataease.js";import"./index-0.0.0-dataease3.js";const xt={class:"calcu-cont"},Dt={style:{flex:"1"}},wt={style:{"max-width":"488px"}},Nt={class:"mb8 field-exp"},St={key:0},Tt={key:1},bt={class:"padding-lr"},Et={class:"mb8"},Ft={class:"padding-lr-content"},qt={class:"quota-btn_de"},Vt={class:"field-height"},Mt={key:0,class:"field-list"},Lt=["title","onClick"],Ot={key:2,class:"icon-right"},It={key:1,class:"class-na"},At={class:"padding-lr"},$t={class:"mb8"},Bt={key:0},Jt={key:1},Pt={class:"padding-lr-content"},jt={key:0,style:{width:"100%"}},zt=["onClick"],Rt={class:"pop-title"},Qt={class:"pop-info"},Ut={class:"pop-info"},Kt={key:1,class:"class-na"},Gt=lt({__name:"CustomAggrEdit",props:{crossDs:{type:Boolean,default:()=>!1}},setup(z,{expose:R}){const{t:c}=at(),L=k(),T=k(""),b=k(""),d=k(),O=z,I={originName:"",name:"",groupType:"d",type:"VARCHAR",deType:0,extField:2,id:"",params:[],checked:!0},u=q({functionData:[],quotaData:[]}),A=q({id:null,name:"",value:null}),Q=k(!1),f=q({...I}),U=()=>{const o=d.value.state.doc.toString(),t=[];f.originName=x("name","id",o,t)},x=(o,t,p,_)=>{let h=p;const C=u.quotaData.reduce((y,g)=>(y[g[o]]=g[t],y),{}),D=p.match(/\[(.+?)\]/g)||[];return D&&D.forEach(y=>{const g=y.slice(1,-1);_&&_.push(C[g]),h=h.replace(`[${g}]`,`[${C[g]}]`)}),h};let E=[];const K=(o,t)=>{if(A.id=null,Object.assign(f,{...I,...o}),u.quotaData=t.concat(f.params||[]),E=S(t.concat(f.params||[])),!o.originName){d.value.dispatch({changes:{from:0,to:d.value.viewState.state.doc.length,insert:""}});return}dt(()=>{d.value.dispatch({changes:{from:0,to:d.value.viewState.state.doc.length,insert:x("id","name",o.originName)}})})},G=o=>{d.value.dispatch({changes:{from:d.value.viewState.state.selection.ranges[0].from,insert:o},selection:{anchor:d.value.viewState.state.selection.ranges[0].from}})};ct(()=>{d.value=L.value.codeComInit()}),rt(()=>{var o,t;(t=(o=d.value).destroy)==null||t.call(o)});const H=o=>{d.value.dispatch({changes:{from:d.value.viewState.state.selection.ranges[0].from,insert:o},selection:{anchor:d.value.viewState.state.selection.ranges[0].from}})};let F=[];const W=()=>{ht().then(o=>{F=S(o),u.functionData=S(o)})};B(()=>T.value,o=>{o&&o!==""?u.quotaData=JSON.parse(JSON.stringify(E.filter(t=>t.name.toLocaleLowerCase().includes(o.toLocaleLowerCase())&&t.extField===0))):u.quotaData=JSON.parse(JSON.stringify(E)).filter(t=>t.extField===0)}),B(()=>b.value,o=>{o&&o!==""?u.functionData=JSON.parse(JSON.stringify(F.filter(t=>t.func.toLocaleLowerCase().includes(o.toLocaleLowerCase())))):u.functionData=S(F)}),R({initEdit:K,setFieldForm:U,fieldForm:f});const X=k(""),Y=()=>{const[o]=f.params;X.value="编辑计算参数",Object.assign(A,o||{}),Q.value=!0},Z=()=>{const[o]=f.params;f.params=[];const t=d.value.state.doc.toString(),p=[];f.originName=x("name","id",t,p).replaceAll(`[${o.id}]`,""),u.quotaData=u.quotaData.filter(_=>_.id!==o.id),d.value.dispatch({changes:{from:0,to:d.value.viewState.state.doc.length,insert:x("id","name",f.originName)}})};return W(),(o,t)=>{const p=st,_=nt,h=kt,C=it,D=tt,y=ot,g=et;return r(),m("div",{onKeydown:t[2]||(t[2]=w(()=>{},["stop"])),onKeyup:t[3]||(t[3]=w(()=>{},["stop"])),class:"calcu-field"},[n("div",xt,[n("div",Dt,[n("div",wt,[n("div",Nt,[n("span",null,l(s(c)("dataset.field_exp")),1),t[4]||(t[4]=n("span",null,"*",-1)),e(h,{class:"item",effect:"dark",placement:"top"},{content:a(()=>[O.crossDs?(r(),m("div",St,l(s(c)("dataset.calc_tips.tip1")),1)):(r(),m("div",Tt,l(s(c)("dataset.calc_tips.tip1_1")),1)),n("div",null,l(s(c)("dataset.calc_tips.tip2")),1)]),default:a(()=>[e(_,{size:"16px"},{default:a(()=>[e(p,{name:"icon_info_outlined"},{default:a(()=>[e(s(V),{class:"svg-icon"})]),_:1})]),_:1})]),_:1})]),e(gt,{quotaMap:u.quotaData.map(i=>i.name),dimensionMap:[],ref_key:"myCm",ref:L,height:"500px","dom-id":"calcField"},null,8,["quotaMap"])])]),n("div",bt,[n("span",Et,[v(l(s(c)("dataset.click_ref_field"))+" ",1),e(h,{class:"item",effect:"dark",placement:"bottom"},{content:a(()=>[v(l(s(c)("dataset.calc_tips.tip3"))+" ",1),t[5]||(t[5]=n("br",null,null,-1)),v(" "+l(s(c)("dataset.calc_tips.tip4"))+" ",1),t[6]||(t[6]=n("br",null,null,-1)),v(" "+l(s(c)("dataset.calc_tips.tip5")),1)]),default:a(()=>[e(_,{size:"16px"},{default:a(()=>[e(p,{name:"icon_info_outlined"},{default:a(()=>[e(s(V),{class:"svg-icon"})]),_:1})]),_:1})]),_:1})]),n("div",Ft,[e(C,{modelValue:T.value,"onUpdate:modelValue":t[0]||(t[0]=i=>T.value=i),placeholder:s(c)("dataset.edit_search"),clearable:""},{prefix:a(()=>[e(_,null,{default:a(()=>[e(p,{name:"icon_search-outline_outlined"},{default:a(()=>[e(s(j),{class:"svg-icon"})]),_:1})]),_:1})]),_:1},8,["modelValue","placeholder"]),n("div",qt,[n("span",null,l(s(c)("chart.quota")),1)]),n("div",Vt,[e(D,null,{default:a(()=>[u.quotaData.length?(r(),m("div",Mt,[(r(!0),m(J,null,P(u.quotaData,i=>(r(),m("span",{key:i.id,class:"item-quota flex-align-center ellipsis",title:i.name,onClick:$=>G("["+i.name+"]")},[i.groupType?(r(),N(_,{key:1},{default:a(()=>[e(p,{className:`field-icon-${s(M)[i.deType]}`},{default:a(()=>[(r(),N(ut(s(yt)[s(M)[i.deType]]),{class:pt(["svg-icon",`field-icon-${s(M)[i.deType]}`])},null,8,["class"]))]),_:2},1032,["className"])]),_:2},1024)):(r(),N(_,{key:0},{default:a(()=>[e(p,{name:"icon_adjustment_outlined"},{default:a(()=>[e(s(mt),{class:"svg-icon"})]),_:1})]),_:1})),v(" "+l(i.name)+" ",1),i.groupType?_t("",!0):(r(),m("div",Ot,[e(_,{onClick:w(Y,["stop"]),class:"hover-icon"},{default:a(()=>[e(p,{name:"icon_edit_outlined"},{default:a(()=>[e(s(ft),{class:"svg-icon"})]),_:1})]),_:1}),e(_,{onClick:w(Z,["stop"]),class:"hover-icon"},{default:a(()=>[e(p,{name:"icon_delete-trash_outlined"},{default:a(()=>[e(s(vt),{class:"svg-icon"})]),_:1})]),_:1})]))],8,Lt))),128))])):(r(),m("div",It,l(s(c)("dataset.na")),1))]),_:1})])])]),n("div",At,[n("span",$t,[v(l(s(c)("dataset.click_ref_function"))+" ",1),e(h,{class:"item",effect:"dark",placement:"bottom"},{content:a(()=>[O.crossDs?(r(),m("div",Bt,[v(l(s(c)("dataset.calc_tips.tip6"))+" ",1),t[7]||(t[7]=n("br",null,null,-1)),v(" "+l(s(c)("dataset.calc_tips.tip8"))+" ",1),t[8]||(t[8]=n("br",null,null,-1)),t[9]||(t[9]=v(" https://calcite.apache.org/docs/reference.html ",-1))])):(r(),m("div",Jt,l(s(c)("dataset.calc_tips.tip7")),1))]),default:a(()=>[e(_,{size:"16px"},{default:a(()=>[e(p,{name:"icon_info_outlined"},{default:a(()=>[e(s(V),{class:"svg-icon"})]),_:1})]),_:1})]),_:1})]),n("div",Pt,[e(C,{modelValue:b.value,"onUpdate:modelValue":t[1]||(t[1]=i=>b.value=i),style:{"margin-bottom":"8px"},placeholder:s(c)("dataset.edit_search"),clearable:""},{prefix:a(()=>[e(_,null,{default:a(()=>[e(p,{name:"icon_search-outline_outlined"},{default:a(()=>[e(s(j),{class:"svg-icon"})]),_:1})]),_:1})]),_:1},8,["modelValue","placeholder"]),e(g,{class:"function-height"},{default:a(()=>[u.functionData.length?(r(),m("div",jt,[(r(!0),m(J,null,P(u.functionData,(i,$)=>(r(),N(y,{key:$,class:"function-pop",placement:"right",width:"200",trigger:"hover","open-delay":500},{reference:a(()=>[n("span",{class:"function-style flex-align-center",onClick:Ht=>H(i.func)},l(i.func),9,zt)]),default:a(()=>[n("p",Rt,l(i.name),1),n("p",Qt,l(i.func),1),n("p",Ut,l(i.desc),1)]),_:2},1024))),128))])):(r(),m("div",Kt,l(s(c)("chart.no_function")),1))]),_:1})])])])],32)}}});const xe=Ct(Gt,[["__scopeId","data-v-aea35c14"]]);export{xe as default};
