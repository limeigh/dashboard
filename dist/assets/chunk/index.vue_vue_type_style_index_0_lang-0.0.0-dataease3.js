import{e as de,E as w,q as Fe,ag as Ge,ah as Qe,r as ea,h as aa,t as ta,i as sa,Z as la,v as ia}from"./element-plus-secondary-0.0.0-dataease.js";import{d as na,r as c,l as $,w as fe,k as me,o as h,c as I,W as d,U as g,a as k,Y as S,_ as B,u as _,R as F,$ as V,S as pe,z,a8 as oa,T as N,V as ua,a0 as j,n as X}from"./@vue-0.0.0-dataease.js";import{i as ra}from"./icon_close_outlined-0.0.0-dataease.js";import{i as ca}from"./icon_search-outline_outlined-0.0.0-dataease.js";import{a as va,u as da,g as Ne}from"./index-0.0.0-dataease.js";import fa from"./CreatDsGroup-0.0.0-dataease2.js";import ma from"./DsTypeList-0.0.0-dataease.js";import{f as pa,e as te,i as ga}from"./ConfigGlobal.vue_vue_type_script_setup_true_lang-0.0.0-dataease.js";import _a from"./EditorDetail-0.0.0-dataease.js";import{_ as ya}from"./ExcelDetail.vue_vue_type_style_index_0_lang-0.0.0-dataease.js";import{h as ha,i as Ca,f as Ta,v as Sa,a as ba,b as Da,u as xa}from"./datasource-0.0.0-dataease.js";import{g as R}from"./js-base64-0.0.0-dataease.js";import{t as se,n as Pe,d as wa}from"./option-0.0.0-dataease.js";import{b as ka}from"./vue-router_2-0.0.0-dataease.js";import{u as Ea}from"./vue-uuid-0.0.0-dataease.js";import Fa from"./FinishPage-0.0.0-dataease.js";import{_ as Na}from"./PluginComponent.vue_vue_type_script_setup_true_lang-0.0.0-dataease.js";import{i as Pa}from"./datasource-list-0.0.0-dataease.js";import Aa from"./ExcelRemoteDetail-0.0.0-dataease.js";import{h as U}from"./lodash-es-0.0.0-dataease.js";const La={key:0,class:"flex-center",style:{width:"100%"}},Oa={class:"datasource"},Ua={key:0,class:"ds-type-select"},Ia={class:"title"},Ba=["onClick"],Va=["title"],Ja={class:"custom-tree-node flex-align-center"},ja=["title"],Ra={class:"editor-footer"},vt=na({__name:"index",emits:["refresh"],setup(Ma,{expose:Ae,emit:Le}){const{t:o}=pa(),Z=c(),Oe=ka(),{wsCache:ge}=va(),b=c(!1);let _e=!1,ye=!1,le=!1;const he=e=>{le=e},Ce=$({datasourceTree:[]});Ce.datasourceTree=se.map(e=>({name:Pe[e],type:e}));const u=c(0),y=c(),C=c(),P=c(),v=c(),Te=c([]),M=c("OLTP"),H=c(""),s=c(""),ie=Le,{emitter:Ue}=da(),E=c(!1),Y=c(!1),Se=e=>{s.value=e,u.value=1,D.value=1,X(()=>{var a,t,n;(a=y==null?void 0:y.value)!=null&&a.initForm(e,Q.value,W.value,E.value)||((t=C==null?void 0:C.value)==null||t.invokeMethod({methodName:"initForm",args:e})),(n=v==null?void 0:v.value)==null||n.initForm(e),q.value&&be.value.map(l=>l.dbList).flat().some(l=>l.type===s.value?(q.value.setCurrentNode(l),E.value=l.isPlugin,!0):!1)})},Ie=e=>{e.type&&(E.value=e.isPlugin,Se(e.type))},ne=e=>{M.value=e.type};fe(H,e=>{u.value===1&&q.value.filter(e.toLocaleLowerCase())});const q=c(),Be={children:"dbList",label:"name"},Ve=(e,a)=>e?a.name.toLowerCase().includes(e):!0,G=c([]),be=me(()=>se.map((e,a)=>({name:Pe[e],dbList:G.value[a]})));(()=>{const e=[[],[],[],[],[]];wa.forEach(a=>{const t=se.findIndex(n=>n===a.catalog);t!==-1&&e[t].push(a)}),G.value=e.map(a=>a.sort((t,n)=>t.name.toLowerCase().charCodeAt(0)-n.name.toLowerCase().charCodeAt(0)))})();const W=c(""),Q=c([]),Je=e=>{Q.value=e,e.forEach(a=>{const{name:t,category:n,type:l,icon:i,extraParams:m,staticMap:x}=a,O={name:t,catalog:n,type:l,icon:i,extraParams:m,isPlugin:!0,staticMap:x},ae=se.findIndex(p=>p===O.catalog);ae!==-1&&G.value[ae].push(O)})},je=e=>{var t;const a=Q.value.filter(n=>n.type===e);return W.value?W.value:a&&a.length>0?(t=a[0].staticMap)==null?void 0:t.index:null};(()=>{ha({}).then(e=>{Te.value=e.data})})();const D=c(0),oe=()=>{D.value=u.value+1,!((s.value.includes("API")||s.value==="ExcelRemote")&&u.value===1)&&(u.value=u.value+1)},Re=()=>{var e;if(s.value===""){w.error(o("datasource.select_type"));return}if(((e=r.apiConfiguration)==null?void 0:e.length)===0&&s.value.includes("API")&&u.value!==2){w.error(o("data_source.cannot_be_empty_table"));return}if(s.value.includes("ExcelRemote")&&u.value!==2){v.value.validateExcel()&&oe();return}if(s.value.includes("API")&&u.value!==2){y.value.submitForm()(t=>{t&&oe()});return}oe()},ue=(e,a,t)=>{var n,l;(n=P==null?void 0:P.value)==null||n.saveExcelDs(e,()=>{L.value=e.pid,a()},t),(l=v==null?void 0:v.value)==null||l.saveExcelDs(e,()=>{L.value=e.pid,a()},t)},J=c(!1),re=$({name:"",id:""}),Me=()=>{Oe.push({path:"/dataset-form",query:{datasourceId:re.id}})},We=()=>{A.value=!1,ie("refresh"),J.value=!1},Ke=()=>{J.value=!1,ke(null,L.value)},ee=({id:e,name:a,pid:t})=>{Ca().then(n=>{if(f.value||!n.data){ie("refresh"),A.value=!1;return}else J.value=!0,Object.assign(re,{id:e,name:a})}).finally(()=>{t.value=t})};Ue.on("showFinishPage",ee);const $e=()=>{ze()},ze=()=>{if((s.value.includes("API")||s.value==="ExcelRemote")&&D.value===2){D.value=1,u.value=1;return}u.value===1&&(s.value=""),u.value=u.value-1},Xe=e=>{const a=e.validate;e.eventName==="saveDs"?a(t=>{t&&ce(e.args)}):a(t=>{t&&De(e.args)})},Ze=()=>{var a,t,n,l;const e=JSON.parse(JSON.stringify(r));if(s.value.includes("API")){if(r.apiConfiguration.length===0){w.error(o("data_source.add_data_table"));return}let i=[];i=i.concat(e.apiConfiguration),e.paramsConfiguration&&(i=i.concat(e.paramsConfiguration)),e.configuration=R.encode(JSON.stringify(i)),e.syncSetting.startTime=new Date(e.syncSetting.startTime).getTime(),e.syncSetting.endTime=new Date(e.syncSetting.endTime).getTime()}else e.configuration=R.encode(JSON.stringify(e.configuration));if(E.value&&!s.value.includes("API"))(a=C==null?void 0:C.value)==null||a.invokeMethod({methodName:"submitForm",args:[{eventName:"validateDs",args:e}]});else{let i=(t=y==null?void 0:y.value)==null?void 0:t.submitForm();(n=v==null?void 0:v.value)!=null&&n.submitForm()&&(i=(l=v==null?void 0:v.value)==null?void 0:l.submitForm()),i(m=>{m&&De(e)})}},De=e=>{if(b.value=!0,s.value==="ExcelRemote"){let a=JSON.parse(JSON.stringify(T.configuration));return a.datasourceId=T.id||0,a.editType=T.editType,a.userName=R.encode(a.userName),a.passwd=R.encode(a.passwd),Ta(a).then(t=>{if(b.value=!1,!t){w.warning(t.msg);return}if((t==null?void 0:t.code)!==0){w.warning(t.msg);return}w.success(o("datasource.validate_success")),b.value=!1}).catch(()=>{w.error(o("data_source.verification_failed")),b.value=!1})}Sa(e).then(a=>{if(a.data.type.includes("API")){let t=0;const n=JSON.parse(a.data.status);for(let l=0;l<n.length;l++){n[l].status==="Error"&&t++;for(let i=0;i<r.apiConfiguration.length;i++)n[l].name===r.apiConfiguration[i].name&&(r.apiConfiguration[i].status=n[l].status)}t===0?w.success(o("datasource.validate_success")):w.error(o("data_source.verification_failed"))}else w.success(o("datasource.validate_success"))}).finally(()=>{b.value=!1})},He=me(()=>{if(!s.value)return"";let e="";return G.value.some(a=>a.some(t=>t.type===s.value?(e=t.name,!0):!1)),e}),Ye=()=>{var a,t,n;le=!1;const e=JSON.parse(JSON.stringify(r));if(s.value==="Excel"){if(P.value.uploadStatus(!1),!((a=P.value.sheetFile)!=null&&a.name)){P.value.uploadStatus(!0);return}P.value.submitForm()(i=>{i&&(f.value?ue(null,null,null):Z.value.createInit("datasource",{id:L.value},"",T.name))});return}if(s.value==="ExcelRemote"){v.value.submitForm()(i=>{var m;i&&((m=v==null?void 0:v.value)==null?void 0:m.submitSyncSettingForm())(O=>{O&&(f.value&&T.id?ue(null,null,null):Z.value.createInit("datasource",{id:L.value},"",T.name))})});return}else if(s.value.includes("API")){for(let i=0;i<e.apiConfiguration.length;i++){(e.apiConfiguration[i].deTableName===""||e.apiConfiguration[i].deTableName===void 0||e.apiConfiguration[i].deTableName===null)&&(e.apiConfiguration[i].deTableName="api_"+e.apiConfiguration[i].name+"_"+Ea.v1().replaceAll("-","").substring(0,10)),e.apiConfiguration[i].jsonFields=[];for(let m=0;m<e.apiConfiguration[i].fields.length;m++)e.apiConfiguration[i].fields[m].value=[]}let l=[];l=l.concat(e.apiConfiguration),e.paramsConfiguration&&(l=l.concat(e.paramsConfiguration)),e.configuration=R.encode(JSON.stringify(l)),e.syncSetting.startTime=new Date(e.syncSetting.startTime).getTime(),e.syncSetting.endTime=new Date(e.syncSetting.endTime).getTime()}else e.configuration=R.encode(JSON.stringify(e.configuration));if(E.value&&!s.value.includes("API"))(t=C==null?void 0:C.value)==null||t.invokeMethod({methodName:"submitForm",args:[{eventName:"saveDs",args:e}]});else{const l=(n=y==null?void 0:y.value)==null?void 0:n.submitForm();e.apiConfiguration="",l(i=>{var m;i&&(s.value.includes("API")?((m=y==null?void 0:y.value)==null?void 0:m.submitApiForm())(O=>{O&&ce(e)}):ce(e))})}},ce=e=>{if(f.value&&r.id){let a={confirmButtonType:"danger",type:"warning",autofocus:!1,showClose:!1,tip:""};ba(e).then(t=>{let n=e.id===""?Da:xa;if(t)Fe.confirm(o("datasource.has_same_ds"),a).then(()=>{b.value!==!0&&(b.value=!0,n(e).then(l=>{l!==void 0&&(ee({id:l.id,name:l.name}),w.success(o("data_source.source_saved_successfully")))}).finally(()=>{b.value=!1}))});else{if(b.value===!0)return;b.value=!0,n(e).then(l=>{l!==void 0&&(ee({id:l.id,name:l.name}),w.success(o("data_source.source_saved_successfully")))}).finally(()=>{b.value=!1})}})}else Z.value.createInit("datasource",{id:L.value,request:e},"",r.name)},ve={id:"",name:"",description:"",type:"API",apiConfiguration:[],paramsConfiguration:[],enableDataFill:!1},xe={type:"",id:"0",editType:0,name:"",creator:"",configuration:{}},we=$(U(ve)),r=$(U(ve)),T=$(U(xe)),A=c(!1),f=c(!1),L=c("0");fe(()=>r,()=>{_e&&he(!0)},{deep:!0}),fe(()=>T,()=>{ye&&he(!0)},{deep:!0});const ke=(e,a,t,n)=>{var l;E.value=e==null?void 0:e.isPlugin,W.value=E.value?(l=e==null?void 0:e.staticMap)==null?void 0:l.index:null,Y.value=n,f.value=!!e,J.value=!1,e?(e.type.startsWith("Excel")?Object.assign(T,U(e)):(Object.assign(r,U(e)),Object.assign(we,U(e)),r.hasOwnProperty("configuration")&&r.configuration.urlType==null&&(r.configuration.urlType="hostName"),r.hasOwnProperty("configuration")&&r.configuration.sshType==null&&(r.configuration.sshType="password")),L.value=e.pid||"0"):(Object.assign(T,U(xe)),Object.assign(r,U(ve)),L.value=a||"0"),u.value=Number(f.value),D.value=u.value,A.value=!0,X(()=>{ye=!0,_e=!0}),e&&X(()=>{s.value=e.type,u.value=1,D.value=u.value,t&&X(()=>{P.value.appendReplaceExcel(t)}),X(()=>{var i,m,x;(i=y==null?void 0:y.value)==null||i.clearForm(),(m=v==null?void 0:v.value)==null||m.clearForm(),(x=C==null?void 0:C.value)==null||x.invokeMethod({methodName:"clearForm",args:[]})})})},qe=me(()=>{const{id:e,editType:a,creator:t}=T;return t&&e&&s.value=="Excel"?o(a===1?"data_source.append_data":"data_source.replace_data"):s.value=="ExcelRemote"?f.value?T.id?o("datasource.modify"):o("data_source.copy_data_source"):o("data_source.create_data_source"):f.value?r.id?o("datasource.modify"):o("data_source.copy_data_source"):o("data_source.create_data_source")}),Ee=()=>{ge.get(Ne("ds-new-success"))&&(ie("refresh"),ge.set(Ne("ds-new-success"),!1)),!J.value&&(!f.value&&u.value!==0||le)&&JSON.stringify(r)!==JSON.stringify(we)?Fe.confirm(o("data_source.want_to_exit"),{confirmButtonText:o("dataset.confirm"),cancelButtonText:o("common.cancel"),showCancelButton:!0,confirmButtonType:"primary",type:"warning",autofocus:!1,showClose:!1}).then(()=>{A.value=!1}):A.value=!1};return Ae({init:ke}),(e,a)=>{const t=Ge,n=Qe,l=ea,i=aa,m=ta,x=sa,O=la,ae=ia;return h(),I(pe,null,[d(O,{"close-on-click-modal":!1,size:"calc(100% - 100px)","modal-class":"datasource-drawer-fullscreen",direction:"btt","before-close":Ee,"show-close":!1,modelValue:A.value,"onUpdate:modelValue":a[3]||(a[3]=p=>A.value=p)},{header:g(({close:p})=>[k("span",null,S(qe.value),1),f.value?F("",!0):(h(),I("div",La,[d(n,{custom:"",style:{"max-width":"500px",flex:"1"},active:u.value,"align-center":""},{default:g(()=>[d(t,null,{title:g(()=>[B(S(_(o)("deDataset.select_data_source")),1)]),_:1}),d(t,null,{title:g(()=>[B(S(_(o)("data_source.configuration_information")),1)]),_:1})]),_:1},8,["active"])])),d(_(de),{onClick:p,class:"datasource-close"},{default:g(()=>[d(te,{name:"icon_close_outlined"},{default:g(()=>[d(_(ra),{class:"svg-icon"})]),_:1})]),_:1},8,["onClick"])]),default:g(()=>[V((h(),I("div",Oa,[f.value?F("",!0):(h(),I("div",Ua,[k("div",Ia,[d(l,{placeholder:_(o)("chart.search"),class:"m24 w100",modelValue:H.value,"onUpdate:modelValue":a[0]||(a[0]=p=>H.value=p),clearable:""},{prefix:g(()=>[d(_(de),null,{default:g(()=>[d(te,{name:"icon_search-outline_outlined"},{default:g(()=>[d(_(ca),{class:"svg-icon"})]),_:1})]),_:1})]),_:1},8,["placeholder","modelValue"])]),u.value===0?(h(),I(pe,{key:0},[k("p",{class:z([M.value==="latestUse"&&"active","list-item_primary"]),onClick:a[1]||(a[1]=p=>ne({type:"latestUse",name:"latestUse",id:"latestUse"}))},S(_(o)("data_source.recently_created")),3),d(i),k("p",{class:z([M.value==="all"&&"active","list-item_primary"]),onClick:a[2]||(a[2]=p=>ne({type:"all",name:"all",id:"all"}))},S(_(o)("data_source.all")),3),(h(!0),I(pe,null,oa(Ce.datasourceTree,p=>(h(),I("div",{key:p.name,onClick:K=>ne(p),class:z(["list-item_primary",M.value===p.type&&"active"])},[k("span",{title:p.name,class:"label"},S(p.name),9,Va)],10,Ba))),128))],64)):F("",!0),u.value>0?(h(),N(m,{key:1,"expand-on-click-node":!1,menu:"",ref_key:"dsTree",ref:q,data:be.value,nodeKey:"name",props:Be,"filter-node-method":Ve,onNodeClick:Ie},{default:g(({node:p,data:K})=>[k("span",Ja,[K.catalog?(h(),N(_(de),{key:0,class:"icon-border",style:{width:"18px",height:"18px"}},{default:g(()=>[K.isPlugin?(h(),N(te,{key:0,"static-content":K.icon},null,8,["static-content"])):(h(),N(te,{key:1},{default:g(()=>[(h(),N(ua(_(Pa)[K.type]),{class:"svg-icon"}))]),_:2},1024))]),_:2},1024)):F("",!0),k("span",{title:p.label,class:"label-tooltip"},S(p.label),9,ja)])]),_:1},8,["data"])):F("",!0)])),k("div",{class:z(["ds-editor",f.value&&"edit-ds"])},[V(k("div",{class:"ds-type-title"},S(He.value),513),[[j,u.value!==0&&!f.value]]),k("div",{class:z(["editor-content",(u.value===0||f.value)&&"type-title"])},[V(d(ma,{"filter-text":H.value.toLocaleLowerCase(),onSelectDsType:Se,"current-type":M.value,"latest-use-types":Te.value},null,8,["filter-text","current-type","latest-use-types"]),[[j,u.value===0]]),u.value!==0&&s.value&&!s.value.startsWith("Excel")&&A.value&&(!E.value||s.value.startsWith("API"))?(h(),N(_a,{key:0,ref_key:"detail",ref:y,form:r,"is-plugin":E.value,"plugin-ds":Q.value,"plugin-index":W.value,editDs:f.value,"active-step":D.value,"is-supportSetKey":Y.value},null,8,["form","is-plugin","plugin-ds","plugin-index","editDs","active-step","is-supportSetKey"])):F("",!0),u.value!==0&&s.value&&s.value!=="Excel"&&A.value&&E.value&&!s.value.startsWith("API")?(h(),N(_(Na),{key:1,jsname:je(s.value),ref_key:"xpack",ref:C,form:r,editDs:f.value,"active-step":D.value,onSubmitForm:Xe},null,8,["jsname","form","editDs","active-step"])):F("",!0),u.value!==0&&s.value=="Excel"?(h(),N(ya,{key:2,editDs:f.value,"is-supportSetKey":Y.value,ref_key:"excel",ref:P,param:T},null,8,["editDs","is-supportSetKey","param"])):F("",!0),u.value!==0&&s.value=="ExcelRemote"?(h(),N(Aa,{key:3,editDs:f.value,"is-supportSetKey":Y.value,ref_key:"excelRemote",ref:v,"active-step":D.value,form:T},null,8,["editDs","is-supportSetKey","active-step","form"])):F("",!0)],2)],2),k("div",Ra,[d(x,{secondary:"",onClick:Ee},{default:g(()=>[B(S(_(o)("common.cancel")),1)]),_:1}),V(d(x,{secondary:"",onClick:$e},{default:g(()=>[B(S(_(o)("common.prev")),1)]),_:1},512),[[j,!(u.value===0||f.value&&D.value<=1)]]),V(d(x,{secondary:"",onClick:Ze},{default:g(()=>[B(S(_(o)("datasource.validate")),1)]),_:1},512),[[j,u.value===1&&s.value!=="Excel"]]),V(d(x,{type:"primary",onClick:Re},{default:g(()=>[B(S(_(o)("common.next")),1)]),_:1},512),[[j,u.value===0&&!s.value.startsWith("API")&&s.value!=="ExcelRemote"||D.value!==2&&(s.value.startsWith("API")||s.value==="ExcelRemote")]]),V(d(x,{type:"primary",onClick:Ye},{default:g(()=>[B(S(_(o)("common.save")),1)]),_:1},512),[[j,u.value===1&&!s.value.startsWith("API")&&s.value!=="ExcelRemote"||D.value===2&&(s.value.startsWith("API")||s.value==="ExcelRemote")]])]),J.value?(h(),N(Fa,{key:1,onContinueCreating:Ke,onBackToDatasourceList:We,onCreateDataset:Me,name:re.name},null,8,["name"])):F("",!0),d(_(ga),{jsname:"L2NvbXBvbmVudC9wbHVnaW5zLWhhbmRsZXIvRHNDYXRlZ29yeUhhbmRsZXI=",onLoadDsPlugin:Je})])),[[ae,b.value]])]),_:1},8,["modelValue"]),d(fa,{onHandleShowFinishPage:ee,onFinish:ue,ref_key:"creatDsFolder",ref:Z},null,512)],64)}}});export{vt as _};
