import{y as Ye,b as qe,a as Qe,z as ea}from"./index-0.0.0-dataease.js";import{E as aa}from"./el-drawer-0.0.0-dataease.js";import{o as ta,j as de,n as te,v as sa,D as w,F as ke,G as la,y as ia}from"./ConfigGlobal.vue_vue_type_script_setup_true_lang-0.0.0-dataease.js";import{E as na}from"./el-tree-0.0.0-dataease.js";import"./el-checkbox-0.0.0-dataease.js";import{E as oa}from"./el-divider-0.0.0-dataease.js";import{E as ua,a as ra}from"./ApiHttpRequestDraw.vue_vue_type_style_index_0_lang-0.0.0-dataease.js";import{d as ca,r as c,X as $,w as fe,y as me,f as h,O as I,j as d,i as _,P as E,a4 as D,a3 as j,u as g,_ as k,R as B,W as pe,S as X,a6 as va,g as N,l as da,U as V,n as z}from"./vue-0.0.0-dataease.js";import{i as fa}from"./icon_close_outlined-0.0.0-dataease.js";import{i as ma}from"./icon_search-outline_outlined-0.0.0-dataease.js";import pa from"./CreatDsGroup-0.0.0-dataease2.js";import _a from"./DsTypeList-0.0.0-dataease.js";import ga from"./EditorDetail-0.0.0-dataease.js";import{_ as ya}from"./ExcelDetail.vue_vue_type_style_index_0_lang-0.0.0-dataease.js";import{h as ha,i as Ca,f as Ta,v as Da,a as ba,b as Sa,u as xa}from"./datasource-0.0.0-dataease.js";import{g as R}from"./dataset-0.0.0-dataease.js";import{t as se,n as Ne,d as wa}from"./option-0.0.0-dataease.js";import{u as Ea}from"./index.esm-0.0.0-dataease.js";import Fa from"./FinishPage-0.0.0-dataease.js";import{_ as ka}from"./PluginComponent.vue_vue_type_script_setup_true_lang-0.0.0-dataease.js";import{i as Na}from"./datasource-list-0.0.0-dataease.js";import Pa from"./ExcelRemoteDetail-0.0.0-dataease.js";import{e as U}from"./lodash-0.0.0-dataease.js";const Aa={key:0,class:"flex-center",style:{width:"100%"}},La={class:"datasource"},Oa={key:0,class:"ds-type-select"},Ua={class:"title"},Ia=["onClick"],ja=["title"],Ba={class:"custom-tree-node flex-align-center"},Ja=["title"],Va={class:"editor-footer"},ft=ca({__name:"index",emits:["refresh"],setup(Ra,{expose:Pe,emit:Ae}){const{t:o}=ta(),H=c(),Le=Ye(),{wsCache:_e}=qe(),b=c(!1);let ge=!1,ye=!1,le=!1;const he=e=>{le=e},Ce=$({datasourceTree:[]});Ce.datasourceTree=se.map(e=>({name:Ne[e],type:e}));const u=c(0),y=c(),C=c(),P=c(),v=c(),Te=c([]),M=c("OLTP"),Z=c(""),s=c(""),ie=Ae,{emitter:Oe}=Qe(),F=c(!1),G=c(!1),De=e=>{s.value=e,u.value=1,S.value=1,z(()=>{var a,t,n;(a=y==null?void 0:y.value)!=null&&a.initForm(e,Q.value,W.value,F.value)||((t=C==null?void 0:C.value)==null||t.invokeMethod({methodName:"initForm",args:e})),(n=v==null?void 0:v.value)==null||n.initForm(e),Y.value&&be.value.map(l=>l.dbList).flat().some(l=>l.type===s.value?(Y.value.setCurrentNode(l),F.value=l.isPlugin,!0):!1)})},Ue=e=>{e.type&&(F.value=e.isPlugin,De(e.type))},ne=e=>{M.value=e.type};fe(Z,e=>{u.value===1&&Y.value.filter(e.toLocaleLowerCase())});const Y=c(),Ie={children:"dbList",label:"name"},je=(e,a)=>e?a.name.toLowerCase().includes(e):!0,q=c([]),be=me(()=>se.map((e,a)=>({name:Ne[e],dbList:q.value[a]})));(()=>{const e=[[],[],[],[],[]];wa.forEach(a=>{const t=se.findIndex(n=>n===a.catalog);t!==-1&&e[t].push(a)}),q.value=e.map(a=>a.sort((t,n)=>t.name.toLowerCase().charCodeAt(0)-n.name.toLowerCase().charCodeAt(0)))})();const W=c(""),Q=c([]),Be=e=>{Q.value=e,e.forEach(a=>{const{name:t,category:n,type:l,icon:i,extraParams:m,staticMap:x}=a,O={name:t,catalog:n,type:l,icon:i,extraParams:m,isPlugin:!0,staticMap:x},ae=se.findIndex(p=>p===O.catalog);ae!==-1&&q.value[ae].push(O)})},Je=e=>{var t;const a=Q.value.filter(n=>n.type===e);return W.value?W.value:a&&a.length>0?(t=a[0].staticMap)==null?void 0:t.index:null};(()=>{ha({}).then(e=>{Te.value=e.data})})();const S=c(0),oe=()=>{S.value=u.value+1,!((s.value.includes("API")||s.value==="ExcelRemote")&&u.value===1)&&(u.value=u.value+1)},Ve=()=>{var e;if(s.value===""){w.error(o("datasource.select_type"));return}if(((e=r.apiConfiguration)==null?void 0:e.length)===0&&s.value.includes("API")&&u.value!==2){w.error(o("data_source.cannot_be_empty_table"));return}if(s.value.includes("ExcelRemote")&&u.value!==2){v.value.validateExcel()&&oe();return}if(s.value.includes("API")&&u.value!==2){y.value.submitForm()(t=>{t&&oe()});return}oe()},ue=(e,a,t)=>{var n,l;(n=P==null?void 0:P.value)==null||n.saveExcelDs(e,()=>{L.value=e.pid,a()},t),(l=v==null?void 0:v.value)==null||l.saveExcelDs(e,()=>{L.value=e.pid,a()},t)},J=c(!1),re=$({name:"",id:""}),Re=()=>{Le.push({path:"/dataset-form",query:{datasourceId:re.id}})},Me=()=>{A.value=!1,ie("refresh"),J.value=!1},We=()=>{J.value=!1,Ee(null,L.value)},ee=({id:e,name:a,pid:t})=>{Ca().then(n=>{if(f.value||!n.data){ie("refresh"),A.value=!1;return}else J.value=!0,Object.assign(re,{id:e,name:a})}).finally(()=>{t.value=t})};Oe.on("showFinishPage",ee);const Ke=()=>{$e()},$e=()=>{if((s.value.includes("API")||s.value==="ExcelRemote")&&S.value===2){S.value=1,u.value=1;return}u.value===1&&(s.value=""),u.value=u.value-1},Xe=e=>{const a=e.validate;e.eventName==="saveDs"?a(t=>{t&&ce(e.args)}):a(t=>{t&&Se(e.args)})},ze=()=>{var a,t,n,l;const e=JSON.parse(JSON.stringify(r));if(s.value.includes("API")){if(r.apiConfiguration.length===0){w.error(o("data_source.add_data_table"));return}let i=[];i=i.concat(e.apiConfiguration),e.paramsConfiguration&&(i=i.concat(e.paramsConfiguration)),e.configuration=R.encode(JSON.stringify(i)),e.syncSetting.startTime=new Date(e.syncSetting.startTime).getTime(),e.syncSetting.endTime=new Date(e.syncSetting.endTime).getTime()}else e.configuration=R.encode(JSON.stringify(e.configuration));if(F.value&&!s.value.includes("API"))(a=C==null?void 0:C.value)==null||a.invokeMethod({methodName:"submitForm",args:[{eventName:"validateDs",args:e}]});else{let i=(t=y==null?void 0:y.value)==null?void 0:t.submitForm();(n=v==null?void 0:v.value)!=null&&n.submitForm()&&(i=(l=v==null?void 0:v.value)==null?void 0:l.submitForm()),i(m=>{m&&Se(e)})}},Se=e=>{if(b.value=!0,s.value==="ExcelRemote"){let a=JSON.parse(JSON.stringify(T.configuration));return a.datasourceId=T.id||0,a.editType=T.editType,a.userName=R.encode(a.userName),a.passwd=R.encode(a.passwd),Ta(a).then(t=>{if(b.value=!1,!t){w.warning(t.msg);return}if((t==null?void 0:t.code)!==0){w.warning(t.msg);return}w.success(o("datasource.validate_success")),b.value=!1}).catch(()=>{w.error(o("data_source.verification_failed")),b.value=!1})}Da(e).then(a=>{if(a.data.type.includes("API")){let t=0;const n=JSON.parse(a.data.status);for(let l=0;l<n.length;l++){n[l].status==="Error"&&t++;for(let i=0;i<r.apiConfiguration.length;i++)n[l].name===r.apiConfiguration[i].name&&(r.apiConfiguration[i].status=n[l].status)}t===0?w.success(o("datasource.validate_success")):w.error(o("data_source.verification_failed"))}else w.success(o("datasource.validate_success"))}).finally(()=>{b.value=!1})},He=me(()=>{if(!s.value)return"";let e="";return q.value.some(a=>a.some(t=>t.type===s.value?(e=t.name,!0):!1)),e}),Ze=()=>{var a,t,n;le=!1;const e=JSON.parse(JSON.stringify(r));if(s.value==="Excel"){if(P.value.uploadStatus(!1),!((a=P.value.sheetFile)!=null&&a.name)){P.value.uploadStatus(!0);return}P.value.submitForm()(i=>{i&&(f.value?ue(null,null,null):H.value.createInit("datasource",{id:L.value},"",T.name))});return}if(s.value==="ExcelRemote"){v.value.submitForm()(i=>{var m;i&&((m=v==null?void 0:v.value)==null?void 0:m.submitSyncSettingForm())(O=>{O&&(f.value&&T.id?ue(null,null,null):H.value.createInit("datasource",{id:L.value},"",T.name))})});return}else if(s.value.includes("API")){for(let i=0;i<e.apiConfiguration.length;i++){(e.apiConfiguration[i].deTableName===""||e.apiConfiguration[i].deTableName===void 0||e.apiConfiguration[i].deTableName===null)&&(e.apiConfiguration[i].deTableName="api_"+e.apiConfiguration[i].name+"_"+Ea.v1().replaceAll("-","").substring(0,10)),e.apiConfiguration[i].jsonFields=[];for(let m=0;m<e.apiConfiguration[i].fields.length;m++)e.apiConfiguration[i].fields[m].value=[]}let l=[];l=l.concat(e.apiConfiguration),e.paramsConfiguration&&(l=l.concat(e.paramsConfiguration)),e.configuration=R.encode(JSON.stringify(l)),e.syncSetting.startTime=new Date(e.syncSetting.startTime).getTime(),e.syncSetting.endTime=new Date(e.syncSetting.endTime).getTime()}else e.configuration=R.encode(JSON.stringify(e.configuration));if(F.value&&!s.value.includes("API"))(t=C==null?void 0:C.value)==null||t.invokeMethod({methodName:"submitForm",args:[{eventName:"saveDs",args:e}]});else{const l=(n=y==null?void 0:y.value)==null?void 0:n.submitForm();e.apiConfiguration="",l(i=>{var m;i&&(s.value.includes("API")?((m=y==null?void 0:y.value)==null?void 0:m.submitApiForm())(O=>{O&&ce(e)}):ce(e))})}},ce=e=>{if(f.value&&r.id){let a={confirmButtonType:"danger",type:"warning",autofocus:!1,showClose:!1,tip:""};ba(e).then(t=>{let n=e.id===""?Sa:xa;if(t)ke.confirm(o("datasource.has_same_ds"),a).then(()=>{b.value!==!0&&(b.value=!0,n(e).then(l=>{l!==void 0&&(ee({id:l.id,name:l.name}),w.success(o("data_source.source_saved_successfully")))}).finally(()=>{b.value=!1}))});else{if(b.value===!0)return;b.value=!0,n(e).then(l=>{l!==void 0&&(ee({id:l.id,name:l.name}),w.success(o("data_source.source_saved_successfully")))}).finally(()=>{b.value=!1})}})}else H.value.createInit("datasource",{id:L.value,request:e},"",r.name)},ve={id:"",name:"",description:"",type:"API",apiConfiguration:[],paramsConfiguration:[],enableDataFill:!1},xe={type:"",id:"0",editType:0,name:"",creator:"",configuration:{}},we=$(U(ve)),r=$(U(ve)),T=$(U(xe)),A=c(!1),f=c(!1),L=c("0");fe(()=>r,()=>{ge&&he(!0)},{deep:!0}),fe(()=>T,()=>{ye&&he(!0)},{deep:!0});const Ee=(e,a,t,n)=>{var l;F.value=e==null?void 0:e.isPlugin,W.value=F.value?(l=e==null?void 0:e.staticMap)==null?void 0:l.index:null,G.value=n,f.value=!!e,J.value=!1,e?(e.type.startsWith("Excel")?Object.assign(T,U(e)):(Object.assign(r,U(e)),Object.assign(we,U(e)),r.hasOwnProperty("configuration")&&r.configuration.urlType==null&&(r.configuration.urlType="hostName"),r.hasOwnProperty("configuration")&&r.configuration.sshType==null&&(r.configuration.sshType="password")),L.value=e.pid||"0"):(Object.assign(T,U(xe)),Object.assign(r,U(ve)),L.value=a||"0"),u.value=Number(f.value),S.value=u.value,A.value=!0,z(()=>{ye=!0,ge=!0}),e&&z(()=>{s.value=e.type,u.value=1,S.value=u.value,t&&z(()=>{P.value.appendReplaceExcel(t)}),z(()=>{var i,m,x;(i=y==null?void 0:y.value)==null||i.clearForm(),(m=v==null?void 0:v.value)==null||m.clearForm(),(x=C==null?void 0:C.value)==null||x.invokeMethod({methodName:"clearForm",args:[]})})})},Ge=me(()=>{const{id:e,editType:a,creator:t}=T;return t&&e&&s.value=="Excel"?o(a===1?"data_source.append_data":"data_source.replace_data"):s.value=="ExcelRemote"?f.value?T.id?o("datasource.modify"):o("data_source.copy_data_source"):o("data_source.create_data_source"):f.value?r.id?o("datasource.modify"):o("data_source.copy_data_source"):o("data_source.create_data_source")}),Fe=()=>{_e.get("ds-new-success")&&(ie("refresh"),_e.set("ds-new-success",!1)),!J.value&&(!f.value&&u.value!==0||le)&&JSON.stringify(r)!==JSON.stringify(we)?ke.confirm(o("data_source.want_to_exit"),{confirmButtonText:o("dataset.confirm"),cancelButtonText:o("common.cancel"),showCancelButton:!0,confirmButtonType:"primary",type:"warning",autofocus:!1,showClose:!1}).then(()=>{A.value=!1}):A.value=!1};return Pe({init:Ee}),(e,a)=>{const t=ua,n=ra,l=la,i=oa,m=na,x=ia,O=aa,ae=ea;return h(),I(pe,null,[d(O,{"close-on-click-modal":!1,size:"calc(100% - 100px)","modal-class":"datasource-drawer-fullscreen",direction:"btt","before-close":Fe,"show-close":!1,modelValue:A.value,"onUpdate:modelValue":a[3]||(a[3]=p=>A.value=p)},{header:_(({close:p})=>[E("span",null,D(Ge.value),1),f.value?k("",!0):(h(),I("div",Aa,[d(n,{custom:"",style:{"max-width":"500px",flex:"1"},active:u.value,"align-center":""},{default:_(()=>[d(t,null,{title:_(()=>[j(D(g(o)("deDataset.select_data_source")),1)]),_:1}),d(t,null,{title:_(()=>[j(D(g(o)("data_source.configuration_information")),1)]),_:1})]),_:1},8,["active"])])),d(g(de),{onClick:p,class:"datasource-close"},{default:_(()=>[d(te,{name:"icon_close_outlined"},{default:_(()=>[d(g(fa),{class:"svg-icon"})]),_:1})]),_:1},8,["onClick"])]),default:_(()=>[B((h(),I("div",La,[f.value?k("",!0):(h(),I("div",Oa,[E("div",Ua,[d(l,{placeholder:g(o)("chart.search"),class:"m24 w100",modelValue:Z.value,"onUpdate:modelValue":a[0]||(a[0]=p=>Z.value=p),clearable:""},{prefix:_(()=>[d(g(de),null,{default:_(()=>[d(te,{name:"icon_search-outline_outlined"},{default:_(()=>[d(g(ma),{class:"svg-icon"})]),_:1})]),_:1})]),_:1},8,["placeholder","modelValue"])]),u.value===0?(h(),I(pe,{key:0},[E("p",{class:X([M.value==="latestUse"&&"active","list-item_primary"]),onClick:a[1]||(a[1]=p=>ne({type:"latestUse",name:"latestUse",id:"latestUse"}))},D(g(o)("data_source.recently_created")),3),d(i),E("p",{class:X([M.value==="all"&&"active","list-item_primary"]),onClick:a[2]||(a[2]=p=>ne({type:"all",name:"all",id:"all"}))},D(g(o)("data_source.all")),3),(h(!0),I(pe,null,va(Ce.datasourceTree,p=>(h(),I("div",{key:p.name,onClick:K=>ne(p),class:X(["list-item_primary",M.value===p.type&&"active"])},[E("span",{title:p.name,class:"label"},D(p.name),9,ja)],10,Ia))),128))],64)):k("",!0),u.value>0?(h(),N(m,{key:1,"expand-on-click-node":!1,menu:"",ref_key:"dsTree",ref:Y,data:be.value,nodeKey:"name",props:Ie,"filter-node-method":je,onNodeClick:Ue},{default:_(({node:p,data:K})=>[E("span",Ba,[K.catalog?(h(),N(g(de),{key:0,class:"icon-border",style:{width:"18px",height:"18px"}},{default:_(()=>[K.isPlugin?(h(),N(te,{key:0,"static-content":K.icon},null,8,["static-content"])):(h(),N(te,{key:1},{default:_(()=>[(h(),N(da(g(Na)[K.type]),{class:"svg-icon"}))]),_:2},1024))]),_:2},1024)):k("",!0),E("span",{title:p.label,class:"label-tooltip"},D(p.label),9,Ja)])]),_:1},8,["data"])):k("",!0)])),E("div",{class:X(["ds-editor",f.value&&"edit-ds"])},[B(E("div",{class:"ds-type-title"},D(He.value),513),[[V,u.value!==0&&!f.value]]),E("div",{class:X(["editor-content",(u.value===0||f.value)&&"type-title"])},[B(d(_a,{"filter-text":Z.value.toLocaleLowerCase(),onSelectDsType:De,"current-type":M.value,"latest-use-types":Te.value},null,8,["filter-text","current-type","latest-use-types"]),[[V,u.value===0]]),u.value!==0&&s.value&&!s.value.startsWith("Excel")&&A.value&&(!F.value||s.value.startsWith("API"))?(h(),N(ga,{key:0,ref_key:"detail",ref:y,form:r,"is-plugin":F.value,"plugin-ds":Q.value,"plugin-index":W.value,editDs:f.value,"active-step":S.value,"is-supportSetKey":G.value},null,8,["form","is-plugin","plugin-ds","plugin-index","editDs","active-step","is-supportSetKey"])):k("",!0),u.value!==0&&s.value&&s.value!=="Excel"&&A.value&&F.value&&!s.value.startsWith("API")?(h(),N(g(ka),{key:1,jsname:Je(s.value),ref_key:"xpack",ref:C,form:r,editDs:f.value,"active-step":S.value,onSubmitForm:Xe},null,8,["jsname","form","editDs","active-step"])):k("",!0),u.value!==0&&s.value=="Excel"?(h(),N(ya,{key:2,editDs:f.value,"is-supportSetKey":G.value,ref_key:"excel",ref:P,param:T},null,8,["editDs","is-supportSetKey","param"])):k("",!0),u.value!==0&&s.value=="ExcelRemote"?(h(),N(Pa,{key:3,editDs:f.value,"is-supportSetKey":G.value,ref_key:"excelRemote",ref:v,"active-step":S.value,form:T},null,8,["editDs","is-supportSetKey","active-step","form"])):k("",!0)],2)],2),E("div",Va,[d(x,{secondary:"",onClick:Fe},{default:_(()=>[j(D(g(o)("common.cancel")),1)]),_:1}),B(d(x,{secondary:"",onClick:Ke},{default:_(()=>[j(D(g(o)("common.prev")),1)]),_:1},512),[[V,!(u.value===0||f.value&&S.value<=1)]]),B(d(x,{secondary:"",onClick:ze},{default:_(()=>[j(D(g(o)("datasource.validate")),1)]),_:1},512),[[V,u.value===1&&s.value!=="Excel"]]),B(d(x,{type:"primary",onClick:Ve},{default:_(()=>[j(D(g(o)("common.next")),1)]),_:1},512),[[V,u.value===0&&!s.value.startsWith("API")&&s.value!=="ExcelRemote"||S.value!==2&&(s.value.startsWith("API")||s.value==="ExcelRemote")]]),B(d(x,{type:"primary",onClick:Ze},{default:_(()=>[j(D(g(o)("common.save")),1)]),_:1},512),[[V,u.value===1&&!s.value.startsWith("API")&&s.value!=="ExcelRemote"||S.value===2&&(s.value.startsWith("API")||s.value==="ExcelRemote")]])]),J.value?(h(),N(Fa,{key:1,onContinueCreating:We,onBackToDatasourceList:Me,onCreateDataset:Re,name:re.name},null,8,["name"])):k("",!0),d(g(sa),{jsname:"L2NvbXBvbmVudC9wbHVnaW5zLWhhbmRsZXIvRHNDYXRlZ29yeUhhbmRsZXI=",onLoadDsPlugin:Be})])),[[ae,b.value]])]),_:1},8,["modelValue"]),d(pa,{onHandleShowFinishPage:ee,onFinish:ue,ref_key:"creatDsFolder",ref:H},null,512)],64)}}});export{ft as _};
